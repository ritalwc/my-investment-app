<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½è³‡ç”¢ç®¡ç†ç³»çµ±</title>
    <style>
        :root {
            --primary: #34495e; /* Dark Blue/Grey */
            --accent: #5d5fef;  /* Purple/Blue */
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 50px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #fff;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .tab-btn.active {
            background-color: var(--primary);
            color: white;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        h3, h4 { margin-top: 0; color: var(--primary); }
        
        /* Buttons */
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-block { width: 100%; display: block; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-success { background-color: var(--success); }
        .btn-danger { background-color: var(--danger); }
        .btn-info { background-color: var(--accent); }
        .btn-secondary { background-color: #95a5a6; }

        /* Inputs */
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .flex-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .w-100 { width: 100%; }
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }

        /* Balance & Logs */
        .balance-display { font-size: 2em; font-weight: bold; color: var(--success); margin: 10px 0; }
        .log-item {
            border-left: 4px solid var(--accent);
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* USD Pots */
        .usd-pots { display: flex; gap: 10px; margin-bottom: 20px; }
        .pot-card {
            flex: 1; background: #f0f2f5; padding: 10px; border-radius: 8px; text-align: center;
        }
        .pot-amount { font-size: 1.2em; font-weight: bold; color: var(--accent); }

        /* Countdown */
        .countdown-box {
            background: linear-gradient(135deg, #8e90ff 0%, #5d5fef 100%);
            color: white; text-align: center; padding: 30px; border-radius: 12px;
        }
        .countdown-number { font-size: 4em; font-weight: bold; line-height: 1; }

        /* HK Stock List */
        .stock-item {
            border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; background: white;
        }
        .stock-item.active { border: 2px solid var(--warning); background-color: #fff8e1; }
        .stock-item.purchased { border: 2px solid var(--success); background-color: #e8f5e9; }
        .stock-index {
            width: 30px; height: 30px; border-radius: 50%; background: var(--primary); color: white;
            display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px;
        }

        /* US Stock Counter */
        .counter-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;
        }
        .counter-ctrl { display: flex; align-items: center; gap: 15px; }
        .counter-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: #e0e0e0; font-weight: bold; font-size: 18px; cursor: pointer;
        }
        .counter-val { font-size: 1.2em; font-weight: bold; width: 30px; text-align: center; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; margin-top: 10px; }
        .stat-box h5 { margin: 0 0 5px 0; color: #666; }
        .stat-box div { font-size: 1.4em; font-weight: bold; color: var(--primary); }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }

        /* Utility to hide tabs */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

    </style>
    <script src="github-sync.js"></script>
</head>
<body>
<a href="guide.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fff;text-decoration:none;border-radius:6px;font-size:14px;z-index:9999;">â† è¿”å›æŒ‡å—</a>
<div class="container">
    
    <!-- Global Actions -->
    <div class="flex-between mb-2">
        <div style="font-weight: bold; color: #666;">è³‡ç”¢ç®¡ç† v2.2</div>
        <div>
            <button class="btn btn-secondary btn-sm" onclick="app.exportData()">ğŸ“¥ å‚™ä»½</button>
            <input type="file" id="fileInput" style="display:none" onchange="app.importData(this)">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('fileInput').click()">ğŸ“¤ è¼‰å…¥</button>
            <button class="btn btn-danger btn-sm" onclick="app.resetData()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="app.switchTab('savings')" id="btn-savings">
            ğŸ’° è‚¡æ¯å­˜éŒ¢ç½
        </button>
        <button class="tab-btn" onclick="app.switchTab('investments')" id="btn-investments">
            ğŸ“ˆ è‚¡ç¥¨æŠ•è³‡è¨˜éŒ„
        </button>
    </div>

    <!-- TAB 1: Savings (Piggy Bank) -->
    <div id="tab-savings" class="tab-content active">
        
        <!-- HKD Section -->
        <div class="card">
            <h3>ğŸ‡­ğŸ‡° æ¸¯å…ƒè‚¡æ¯</h3>
            <div class="balance-display">HK$ <span id="hkd-total">0.00</span></div>
            <div class="flex-row">
                <input type="text" id="hkd-note" placeholder="å‚™è¨» (ä¾‹: 2025å¹´10æœˆ)" style="flex:2">
                <input type="number" id="hkd-amount" placeholder="é‡‘é¡" style="flex:1">
                <button class="btn btn-info" onclick="app.addHKDLog('deposit')">å­˜å…¥</button>
                <button class="btn btn-warning" onclick="app.addHKDLog('withdraw')">æå–</button>
            </div>
            <div id="hkd-logs" class="mt-2"></div>
        </div>

        <!-- USD Section -->
        <div class="card">
            <h3>ğŸ‡ºğŸ‡¸ ç¾å…ƒè‚¡æ¯ & åˆ©æ¯</h3>
            
            <div class="usd-pots">
                <div class="pot-card">
                    <div style="font-size:0.9em; color:#666;">SPLG/VXUS å„²éŒ¢ç½</div>
                    <div class="pot-amount">US$ <span id="usd-equity-total">0.00</span></div>
                </div>
                <div class="pot-card">
                    <div style="font-size:0.9em; color:#666;">ç¾å‚µå„²éŒ¢ç½</div>
                    <div class="pot-amount">US$ <span id="usd-bond-total">0.00</span></div>
                </div>
            </div>

            <h4 style="border-bottom: 1px solid #eee; padding-bottom: 5px;">å­˜å…¥è³‡é‡‘</h4>
            <div class="flex-row mb-2">
                <input type="text" id="usd-div-note" placeholder="ä¾‹: 2025å¹´10æœˆ" style="flex: 2;">
                <span style="font-weight: bold; font-size: 0.9em; color: var(--accent);">ç¾è‚¡è‚¡æ¯<br><span style="font-size:0.7em; color:#999;">(è‡ªå‹•70/30åˆ†é…)</span></span>
                <input type="number" id="usd-div-amount" placeholder="ç¸½é‡‘é¡" style="flex: 1;">
                <button class="btn btn-info btn-sm" onclick="app.addUSDLog('deposit', 'dividend_split')">åˆ†é…å­˜å…¥</button>
            </div>
            <div class="flex-row mb-2">
                <input type="text" id="usd-bond-note" placeholder="å‚µåˆ¸åç¨±/æ—¥æœŸ" style="flex: 2;">
                <span style="font-weight: bold; font-size: 0.9em; color: var(--warning);">å‚µåˆ¸åˆ©æ¯<br><span style="font-size:0.7em; color:#999;">(100%å…¥å‚µåˆ¸æ± )</span></span>
                <input type="number" id="usd-bond-amount" placeholder="é‡‘é¡" style="flex: 1;">
                <button class="btn btn-info btn-sm" onclick="app.addUSDLog('deposit', 'bond_only')">å­˜å…¥</button>
            </div>

            <h4 style="border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;">æå– (è³¼è²·è³‡ç”¢)</h4>
            <div class="flex-row">
                <input type="text" id="usd-withdraw-note" placeholder="æå–å‚™è¨»" style="flex: 2;">
                <input type="number" id="usd-withdraw-amount" placeholder="é‡‘é¡" style="flex: 1;">
                <select id="usd-withdraw-source" style="flex: 1.5;">
                    <option value="equity">è³¼è²· SPLG/VXUS</option>
                    <option value="bond">è³¼è²· ç¾å‚µ</option>
                </select>
                <button class="btn btn-info btn-sm" onclick="app.addUSDLog('withdraw', null)">æå–</button>
            </div>

            <div id="usd-logs" class="mt-2"></div>
        </div>
    </div>

    <!-- TAB 2: Investments -->
    <div id="tab-investments" class="tab-content">
        
        <!-- 1. Countdown (First) -->
        <div class="card countdown-box">
            <h3>é‚„æ¬¾å€’æ•¸</h3>
            <div class="countdown-number" id="countdown-val">--</div>
            <div style="font-size: 1.2em; margin-top: 10px;">å€‹æœˆå¾Œæ¢å¾©æ¯æœˆå„²è“„</div>
            <div style="margin-top: 10px; opacity: 0.8;">ç•¶å‰æœˆä»½ï¼š<span id="current-month-display"></span></div>
        </div>

        <!-- 2. HK Stock List (Second) -->
        <div class="card">
            <h3>ğŸ‡­ğŸ‡° æ¸¯è‚¡æŠ•è³‡æ¸…å–®</h3>
            <div class="flex-row mb-2">
                <input type="text" id="hk-stock-code" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ (ä¾‹å¦‚: 3466)" style="flex:1">
                <button class="btn btn-info" onclick="app.addHKStock()">+ æ–°å¢è‚¡ç¥¨</button>
            </div>
            <div class="alert" style="background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 6px; font-size: 0.9em; margin-bottom: 15px;">
                ğŸ’¡ æç¤ºï¼šé †åºå¯ä»¥èª¿æ•´ï¼Œè³¼è²·æ¨™è¨˜åƒ…ä½œè¨˜éŒ„ç”¨é€”ã€‚
            </div>
            <div id="hk-stock-list"></div>
        </div>

        <!-- 3. US Stock Monthly Investment (Third) -->
        <div class="card">
            <h3>ğŸ‡ºğŸ‡¸ ç¾è‚¡å®šæŠ• (æœ¬æœˆ)</h3>
            
            <div class="counter-row">
                <span style="font-weight:bold;">SPLG</span>
                <div class="counter-ctrl">
                    <button class="counter-btn" onclick="app.adjustCounter('splg', -1)">-</button>
                    <span class="counter-val" id="count-splg">0</span>
                    <button class="counter-btn" onclick="app.adjustCounter('splg', 1)">+</button>
                </div>
            </div>
            
            <div class="counter-row">
                <span style="font-weight:bold;">VXUS</span>
                <div class="counter-ctrl">
                    <button class="counter-btn" onclick="app.adjustCounter('vxus', -1)">-</button>
                    <span class="counter-val" id="count-vxus">0</span>
                    <button class="counter-btn" onclick="app.adjustCounter('vxus', 1)">+</button>
                </div>
            </div>

            <button class="btn btn-primary btn-block" style="background-color: #2c3e50;" onclick="app.saveMonthlyRecord()">âœ… ä¿å­˜æœ¬æœˆè¨˜éŒ„</button>
        </div>

        <!-- 4. Investment History Stats (Fourth) -->
        <div class="card">
            <h3>ğŸ“Š æŠ•è³‡æ­·å²çµ±è¨ˆ</h3>
            <div class="stats-grid">
                <div class="stat-box"><h5>ç¸½ SPLG</h5><div id="stat-total-splg">0</div></div>
                <div class="stat-box"><h5>ç¸½ VXUS</h5><div id="stat-total-vxus">0</div></div>
                <div class="stat-box"><h5>æŠ•è³‡æœˆæ•¸</h5><div id="stat-months">0</div></div>
                <div class="stat-box"><h5>å¹³å‡æœˆæŠ•</h5><div id="stat-avg">0</div></div>
            </div>
            
            <h4 class="mt-2">æ­·å²è¨˜éŒ„</h4>
            <div id="us-stock-history"></div>
        </div>

    </div>

</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>ä¿®æ”¹è¨˜éŒ„</h3>
        <input type="hidden" id="edit-id">
        <input type="hidden" id="edit-type">
        
        <div class="mb-2">
            <label>æ—¥æœŸ/å‚™è¨»</label>
            <input type="text" id="edit-note" class="w-100">
        </div>
        <div class="mb-2">
            <label>é‡‘é¡</label>
            <input type="number" id="edit-amount" class="w-100">
        </div>
        <div class="flex-row" style="justify-content: flex-end; margin-top:15px;">
            <button class="btn btn-secondary" onclick="document.getElementById('editModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="app.saveEdit()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    // GitHub åŒæ­¥è¨­å®š
const DATA_FILENAME = 'savings-tracker-data.json';

// è‡ªå‹•è¼‰å…¥ GitHub æ•¸æ“š
(async function initGitHubSync() {
    if (typeof GitHubSync !== 'undefined' && GitHubSync.isConfigured()) {
        const data = await GitHubSync.loadFromGitHub(DATA_FILENAME);
        if (data) {
            // å¦‚æœæœ‰è¼‰å…¥è³‡æ–™çš„å‡½æ•¸ï¼Œåœ¨é€™è£¡å‘¼å«
            console.log('å¾ GitHub è¼‰å…¥æ•¸æ“š:', data);
            GitHubSync.showSyncStatus('âœ… å·²å¾ GitHub è¼‰å…¥');
        }
    }
})();

// åœ¨ç¾æœ‰çš„å°å‡ºå‡½æ•¸ä¸­åŠ å…¥ GitHub åŒæ­¥
function syncToGitHub(data) {
    if (typeof GitHubSync !== 'undefined' && GitHubSync.isConfigured()) {
        GitHubSync.saveToGitHub(DATA_FILENAME, data);
    }
}
const app = {
    data: {
        hkdLogs: [],
        usdLogs: [],
        hkStocks: [],
        usStockLogs: [], // { id, monthStr, splg, vxus }
        lastUpdated: new Date().toISOString()
    },
    
    tempCounters: { splg: 0, vxus: 0 },

    init() {
        this.loadData();
        this.renderAll();
        setInterval(() => this.renderCountdown(), 60000); 
    },

    // --- Tab Logic ---
    switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabName).classList.add('active');
        document.getElementById('btn-' + tabName).classList.add('active');
    },

    // --- Data Persistence ---
    saveData() {
        localStorage.setItem('assetApp_v3', JSON.stringify(this.data));
        this.renderAll();
    },
    loadData() {
        const saved = localStorage.getItem('assetApp_v3');
        if (saved) this.data = JSON.parse(saved);
    },
    resetData() {
        if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) {
            this.data = { hkdLogs: [], usdLogs: [], hkStocks: [], usStockLogs: [] };
            this.saveData();
        }
    },
    exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "asset_backup_" + new Date().toISOString().slice(0,10) + ".json";
        a.click();
    },
    importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try { this.data = JSON.parse(e.target.result); this.saveData(); alert("æ•¸æ“šè¼‰å…¥æˆåŠŸï¼"); }
            catch (err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        };
        reader.readAsText(file);
    },

    renderAll() {
        this.renderHKD();
        this.renderUSD();
        this.renderCountdown();
        this.renderHKStocks();
        this.renderUSStocks();
    },

    // --- HKD Logic ---
    addHKDLog(type) {
        const note = document.getElementById('hkd-note').value;
        const amount = parseFloat(document.getElementById('hkd-amount').value);
        if (!amount) return alert("è«‹è¼¸å…¥é‡‘é¡");
        this.data.hkdLogs.unshift({ id: Date.now(), date: new Date().toISOString(), note: note || (type==='deposit'?'å­˜å…¥':'æå–'), amount, type });
        document.getElementById('hkd-note').value = ''; document.getElementById('hkd-amount').value = '';
        this.saveData();
    },
    renderHKD() {
        const list = document.getElementById('hkd-logs');
        list.innerHTML = '';
        let total = 0;
        this.data.hkdLogs.forEach(log => {
            if (log.type === 'deposit') total += log.amount; else total -= log.amount;
            list.innerHTML += this.createLogHtml(log, 'hkd');
        });
        document.getElementById('hkd-total').innerText = total.toFixed(2);
    },

    // --- USD Logic (Modified) ---
    addUSDLog(action, inputType) {
        let note, amount, finalCategory;

        if (action === 'deposit') {
            if (inputType === 'dividend_split') {
                // 70/30 Split Logic
                note = document.getElementById('usd-div-note').value || 'è‚¡æ¯å­˜å…¥';
                amount = parseFloat(document.getElementById('usd-div-amount').value);
                if (!amount) return alert("è«‹è¼¸å…¥é‡‘é¡");

                // Calculate Split
                const equityAmt = parseFloat((amount * 0.7).toFixed(2));
                const bondAmt = parseFloat((amount - equityAmt).toFixed(2)); // Subtract to ensure no rounding loss

                // Add Equity Log (70%)
                this.data.usdLogs.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    note: note + " (70% è‚¡ç¥¨æ± )",
                    amount: equityAmt,
                    type: 'deposit',
                    category: 'equity'
                });

                // Add Bond Log (30%)
                this.data.usdLogs.unshift({
                    id: Date.now() + 1, // Ensure unique ID
                    date: new Date().toISOString(),
                    note: note + " (30% å‚µåˆ¸æ± )",
                    amount: bondAmt,
                    type: 'deposit',
                    category: 'bond'
                });

                // Clear Inputs
                document.getElementById('usd-div-note').value = '';
                document.getElementById('usd-div-amount').value = '';

            } else if (inputType === 'bond_only') {
                // 100% Bond Logic
                note = document.getElementById('usd-bond-note').value || 'å‚µåˆ¸åˆ©æ¯';
                amount = parseFloat(document.getElementById('usd-bond-amount').value);
                if (!amount) return alert("è«‹è¼¸å…¥é‡‘é¡");

                this.data.usdLogs.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    note: note,
                    amount: amount,
                    type: 'deposit',
                    category: 'bond'
                });

                // Clear Inputs
                document.getElementById('usd-bond-note').value = '';
                document.getElementById('usd-bond-amount').value = '';
            }
        } else {
            // Withdraw Logic (unchanged)
            note = document.getElementById('usd-withdraw-note').value || 'æå–è³¼è²·';
            amount = parseFloat(document.getElementById('usd-withdraw-amount').value);
            finalCategory = document.getElementById('usd-withdraw-source').value;
            
            if (!amount) return alert("è«‹è¼¸å…¥é‡‘é¡");

            this.data.usdLogs.unshift({
                id: Date.now(),
                date: new Date().toISOString(),
                note: note,
                amount: amount,
                type: action,
                category: finalCategory
            });
            
            document.getElementById('usd-withdraw-note').value = '';
            document.getElementById('usd-withdraw-amount').value = '';
        }
        
        this.saveData();
    },
    renderUSD() {
        const list = document.getElementById('usd-logs');
        list.innerHTML = '';
        let equityTotal = 0, bondTotal = 0;
        this.data.usdLogs.forEach(log => {
            if (log.category === 'equity') {
                if (log.type === 'deposit') equityTotal += log.amount; else equityTotal -= log.amount;
            } else {
                if (log.type === 'deposit') bondTotal += log.amount; else bondTotal -= log.amount;
            }
            list.innerHTML += this.createLogHtml(log, 'usd');
        });
        document.getElementById('usd-equity-total').innerText = equityTotal.toFixed(2);
        document.getElementById('usd-bond-total').innerText = bondTotal.toFixed(2);
    },

    // --- Helper for Logs ---
    createLogHtml(log, type) {
        const isDep = log.type === 'deposit';
        const dateStr = new Date(log.date).toLocaleDateString('zh-HK');
        let badge = '';
        if (type === 'usd') {
            const label = log.category === 'equity' ? 'è‚¡ç¥¨æ± ' : 'å‚µåˆ¸æ± ';
            const color = log.category === 'equity' ? '#e3f2fd' : '#fff3e0';
            badge = `<span style="font-size:0.8em; background:${color}; padding:2px 5px; border-radius:4px; margin-left:5px;">${label}</span>`;
        }
        return `
            <div class="log-item">
                <div>
                    <div style="font-weight:bold;">${log.note} ${badge}</div>
                    <div style="font-size:0.8em; color:#666;">${dateStr}</div>
                </div>
                <div style="text-align:right;">
                    <div style="color: ${isDep ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">
                        ${isDep ? '+' : '-'}${log.amount.toFixed(2)}
                    </div>
                    <div style="margin-top:5px;">
                        <button class="btn btn-sm btn-info" onclick="app.openEditModal('${type}', ${log.id})">ä¿®æ”¹</button>
                        <button class="btn btn-sm btn-danger" onclick="app.deleteLog('${type}', ${log.id})">åˆªé™¤</button>
                    </div>
                </div>
            </div>
        `;
    },

    // --- Edit/Delete Logic ---
    deleteLog(type, id) {
        if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
        if (type === 'hkd') this.data.hkdLogs = this.data.hkdLogs.filter(l => l.id !== id);
        else this.data.usdLogs = this.data.usdLogs.filter(l => l.id !== id);
        this.saveData();
    },
    openEditModal(type, id) {
        const log = (type === 'hkd' ? this.data.hkdLogs : this.data.usdLogs).find(l => l.id === id);
        if (!log) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-type').value = type;
        document.getElementById('edit-note').value = log.note;
        document.getElementById('edit-amount').value = log.amount;
        document.getElementById('editModal').style.display = 'flex';
    },
    saveEdit() {
        const id = parseInt(document.getElementById('edit-id').value);
        const type = document.getElementById('edit-type').value;
        const note = document.getElementById('edit-note').value;
        const amount = parseFloat(document.getElementById('edit-amount').value);
        if (!amount) return alert("é‡‘é¡ä¸èƒ½ç‚ºç©º");

        const logs = type === 'hkd' ? this.data.hkdLogs : this.data.usdLogs;
        const log = logs.find(l => l.id === id);
        if (log) { log.note = note; log.amount = amount; }
        document.getElementById('editModal').style.display = 'none';
        this.saveData();
    },

    // --- US Stock Monthly Logic ---
    adjustCounter(ticker, delta) {
        this.tempCounters[ticker] += delta;
        if (this.tempCounters[ticker] < 0) this.tempCounters[ticker] = 0;
        document.getElementById(`count-${ticker}`).innerText = this.tempCounters[ticker];
    },
    saveMonthlyRecord() {
        if (this.tempCounters.splg === 0 && this.tempCounters.vxus === 0) return alert("æ•¸é‡ä¸èƒ½å…¨ç‚º 0");
        const now = new Date();
        const monthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2, '0')}`;
        
        // Check if exists
        const exists = this.data.usStockLogs.find(l => l.monthStr === monthStr);
        if (exists) {
            if(!confirm("æœ¬æœˆå·²æœ‰è¨˜éŒ„ï¼Œè¦è¦†è“‹å—ï¼Ÿ")) return;
            exists.splg = this.tempCounters.splg;
            exists.vxus = this.tempCounters.vxus;
        } else {
            this.data.usStockLogs.unshift({
                id: Date.now(),
                monthStr: monthStr,
                splg: this.tempCounters.splg,
                vxus: this.tempCounters.vxus
            });
        }
        
        // Reset UI
        this.tempCounters = { splg: 0, vxus: 0 };
        document.getElementById('count-splg').innerText = '0';
        document.getElementById('count-vxus').innerText = '0';
        this.saveData();
    },
    deleteUSStockLog(id) {
        if(!confirm("åˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) return;
        this.data.usStockLogs = this.data.usStockLogs.filter(l => l.id !== id);
        this.saveData();
    },
    renderUSStocks() {
        const list = document.getElementById('us-stock-history');
        list.innerHTML = '';
        let totalSplg = 0, totalVxus = 0;
        
        this.data.usStockLogs.forEach(log => {
            totalSplg += log.splg;
            totalVxus += log.vxus;
            list.innerHTML += `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <div style="font-weight:bold;">${log.monthStr}</div>
                    <div>
                        SPLG: ${log.splg} | VXUS: ${log.vxus}
                        <button class="btn btn-sm btn-danger" style="margin-left:10px;" onclick="app.deleteUSStockLog(${log.id})">x</button>
                    </div>
                </div>
            `;
        });

        const months = this.data.usStockLogs.length;
        const avg = months > 0 ? ((totalSplg + totalVxus) / months).toFixed(1) : 0;

        document.getElementById('stat-total-splg').innerText = totalSplg;
        document.getElementById('stat-total-vxus').innerText = totalVxus;
        document.getElementById('stat-months').innerText = months;
        document.getElementById('stat-avg').innerText = avg;
    },

    // --- Countdown Logic ---
    renderCountdown() {
        const now = new Date();
        const targetDate = new Date('2029-12-31'); // Dec 2025 + 48 months
        let months = (targetDate.getFullYear() - now.getFullYear()) * 12;
        months -= now.getMonth();
        months += targetDate.getMonth();
        
        const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
        document.getElementById('current-month-display').innerText = `${now.getFullYear()}å¹´${monthNames[now.getMonth()]}`;
        document.getElementById('countdown-val').innerText = months > 0 ? months : 0;
    },

    // --- HK Stock Logic ---
    addHKStock() {
        const code = document.getElementById('hk-stock-code').value;
        if (!code) return;
        this.data.hkStocks.push({ id: Date.now(), code: code, purchased: false });
        document.getElementById('hk-stock-code').value = '';
        this.saveData();
    },
    toggleStockStatus(id) {
        const s = this.data.hkStocks.find(s => s.id === id);
        if (s) { s.purchased = !s.purchased; this.saveData(); }
    },
    deleteStock(id) {
        if(confirm("åˆªé™¤æ­¤è‚¡ç¥¨ï¼Ÿ")) {
            this.data.hkStocks = this.data.hkStocks.filter(s => s.id !== id);
            this.saveData();
        }
    },
    moveStock(id, dir) {
        const idx = this.data.hkStocks.findIndex(s => s.id === id);
        if (idx < 0) return;
        if (dir === 'up' && idx > 0) {
            [this.data.hkStocks[idx], this.data.hkStocks[idx-1]] = [this.data.hkStocks[idx-1], this.data.hkStocks[idx]];
        } else if (dir === 'down' && idx < this.data.hkStocks.length - 1) {
            [this.data.hkStocks[idx], this.data.hkStocks[idx+1]] = [this.data.hkStocks[idx+1], this.data.hkStocks[idx]];
        }
        this.saveData();
    },
    updateStockCode(id, val) {
        const s = this.data.hkStocks.find(s => s.id === id);
        if(s) { s.code = val; this.saveData(); }
    },
    renderHKStocks() {
        const list = document.getElementById('hk-stock-list');
        list.innerHTML = '';
        let foundNext = false;
        this.data.hkStocks.forEach((stock, index) => {
            let statusClass = '', badgeHtml = '';
            if (stock.purchased) {
                statusClass = 'purchased'; badgeHtml = '<span style="background:var(--success); color:white; padding:2px 6px; border-radius:4px; font-size:12px;">å·²è³¼</span>';
            } else if (!foundNext) {
                statusClass = 'active'; badgeHtml = '<span style="background:var(--warning); color:white; padding:2px 6px; border-radius:4px; font-size:12px;">ä¸‹ä¸€é †ä½</span>';
                foundNext = true;
            }
            list.innerHTML += `
                <div class="stock-item ${statusClass}">
                    <div style="display:flex; align-items:center;">
                        <div class="stock-index">${index + 1}</div>
                        <input type="text" value="${stock.code}" onchange="app.updateStockCode(${stock.id}, this.value)" style="font-size:1.2em; font-weight:bold; width:100px; border:none; background:transparent;">
                        ${badgeHtml}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-sm btn-secondary" onclick="app.moveStock(${stock.id}, 'up')">â¬†</button>
                        <button class="btn btn-sm btn-secondary" onclick="app.moveStock(${stock.id}, 'down')">â¬‡</button>
                        <button class="btn btn-sm ${stock.purchased ? 'btn-danger' : 'btn-success'}" onclick="app.toggleStockStatus(${stock.id})">${stock.purchased ? 'å–æ¶ˆ' : 'å·²è³¼'}</button>
                        <button class="btn btn-sm btn-secondary" onclick="app.deleteStock(${stock.id})">ğŸ—‘</button>
                    </div>
                </div>
            `;
        });
    }
};

app.init();
window.onclick = function(e) { if(e.target == document.getElementById('editModal')) document.getElementById('editModal').style.display="none"; }
</script>
</body>
</html>
