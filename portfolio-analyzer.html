<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資組合分析器 (增強版)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px; /* Slightly wider for side-by-side layout */
            margin: 0 auto;
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--primary-color);
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Input Forms */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }

        .row { display: flex; flex-wrap: wrap; gap: 10px; }
        .col { flex: 1; min-width: 200px; }

        /* Buttons */
        button {
            cursor: pointer; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; transition: background 0.3s;
        }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: #2980b9; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--success-color); color: white; } 
        .btn-secondary { background-color: #95a5a6; color: white; }
        .btn-secondary:hover { background-color: #7f8c8d; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }

        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary-color); color: white; }
        tr:hover { background-color: #f1f1f1; }

        /* --- NEW CHART LAYOUT STYLES --- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); /* Wider min-width */
            gap: 20px;
        }

        /* Flex container for Chart + Legend */
        .chart-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 300px;
        }

        .chart-visual {
            flex: 1;
            position: relative;
            height: 300px;
            min-width: 250px;
        }

        .chart-legend {
            flex: 0 0 180px; /* Fixed width for legend */
            padding-left: 20px;
            font-size: 0.9em;
            border-left: 1px solid #eee;
            margin-left: 15px;
        }

        .chart-legend ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .chart-legend li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .legend-label-group {
            display: flex;
            align-items: center;
        }

        .legend-color-box {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 8px;
            border-radius: 2px;
        }

        .legend-percent {
            font-weight: bold;
            margin-left: 10px;
            color: #555;
        }

        .hidden { display: none; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .btn-group { flex-direction: column; }
            .charts-grid { grid-template-columns: 1fr; }
            
            /* Stack chart and legend on mobile */
            .chart-wrapper {
                flex-direction: column;
                height: auto;
            }
            .chart-visual {
                width: 100%;
                height: 250px;
            }
            .chart-legend {
                width: 100%;
                border-left: none;
                border-top: 1px solid #eee;
                margin-left: 0;
                margin-top: 15px;
                padding-left: 0;
                padding-top: 15px;
            }
        }
    </style>
  
</head>
<body>
<a href="guide.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fff;text-decoration:none;border-radius:6px;font-size:14px;z-index:9999;">← 返回指南</a>
<div class="container">
    <h1>投資組合分析器</h1>

    <!-- Global Settings -->
    <div class="card">
        <div class="form-group">
            <label for="exchangeRate">美元兌港元匯率 (USD to HKD):</label>
            <input type="number" id="exchangeRate" value="7.8" step="0.01" onchange="updateAllCalculations()">
        </div>
    </div>

    <!-- Data Entry -->
    <div class="card">
        <h3>新增/修改資產</h3>
        <input type="hidden" id="editIndex" value="-1">
        <div class="row">
            <div class="col">
                <label>股票/資產名稱及代號</label>
                <input type="text" id="assetName" placeholder="例如: Apple (AAPL)">
            </div>
            <div class="col">
                <label>類型</label>
                <select id="assetType">
                    <option value="hk_stock">港股</option>
                    <option value="us_stock">美股</option>
                    <option value="us_bond">美債</option>
                    <option value="corp_bond">公司債</option>
                    <option value="usd_fixed">美金定期</option>
                    <option value="hkd_fixed">港元定期</option>
                </select>
            </div>
        </div>
        <div class="row" style="margin-top: 10px;">
            <div class="col">
                <label>市值</label>
                <input type="number" id="marketValue" placeholder="輸入金額">
            </div>
            <div class="col">
                <label>貨幣單位</label>
                <select id="currency">
                    <option value="HKD">港元 (HKD)</option>
                    <option value="USD">美元 (USD)</option>
                </select>
            </div>
        </div>
        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn-primary" onclick="addOrUpdateAsset()" id="submitBtn">新增資產</button>
            <button class="btn-secondary" onclick="clearForm()">清空表格</button>
        </div>
    </div>

    <!-- Data Management -->
    <div class="card">
        <h3>資產列表</h3>
        <div class="table-container">
            <table id="assetTable">
                <thead>
                    <tr>
                        <th>名稱/代號</th>
                        <th>類型</th>
                        <th>原幣市值</th>
                        <th>港元估值</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here -->
                </tbody>
            </table>
        </div>
        <div class="btn-group" style="margin-top: 20px;">
            <button class="btn-secondary" onclick="exportData()">導出資料 (JSON)</button>
            <button class="btn-secondary" onclick="document.getElementById('importFile').click()">導入資料 (JSON)</button>
            <input type="file" id="importFile" style="display: none;" onchange="importData(this)">
            <button class="btn-danger" onclick="resetData()">重置所有資料</button>
        </div>
    </div>

    <!-- Analysis Charts -->
    <div id="analysisSection">
        <h2 style="margin-top: 40px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">資產分佈分析</h2>
        
        <!-- Macro Level -->
        <h3>1. 宏觀資產類別分佈</h3>
        <div class="card">
            <h4>股票 vs 債券 vs 定期</h4>
            <div class="chart-wrapper">
                <div class="chart-visual">
                    <canvas id="chartMacro"></canvas>
                </div>
                <div id="legend-chartMacro" class="chart-legend"></div>
            </div>
        </div>

        <h3>2. 詳細資產類別分佈</h3>
        <div class="card">
            <h4>港股 vs 美股 vs 美債 vs 公司債 vs 定期</h4>
            <div class="chart-wrapper">
                <div class="chart-visual">
                    <canvas id="chartDetailedType"></canvas>
                </div>
                <div id="legend-chartDetailedType" class="chart-legend"></div>
            </div>
        </div>

        <!-- Mid Level -->
        <h3>3. 類別內部比較</h3>
        <div class="charts-grid">
            <div class="card">
                <h4>股票: 港股 vs 美股</h4>
                <div class="chart-wrapper">
                    <div class="chart-visual">
                        <canvas id="chartStockRegion"></canvas>
                    </div>
                    <div id="legend-chartStockRegion" class="chart-legend"></div>
                </div>
            </div>
            <div class="card">
                <h4>債券: 美債 vs 公司債</h4>
                <div class="chart-wrapper">
                    <div class="chart-visual">
                        <canvas id="chartBondType"></canvas>
                    </div>
                    <div id="legend-chartBondType" class="chart-legend"></div>
                </div>
            </div>
            <div class="card">
                <h4>定期: 美元 vs 港元</h4>
                <div class="chart-wrapper">
                    <div class="chart-visual">
                        <canvas id="chartFixedType"></canvas>
                    </div>
                    <div id="legend-chartFixedType" class="chart-legend"></div>
                </div>
            </div>
        </div>

        <!-- Micro Level -->
        <h3>4. 個股佔比</h3>
        <div class="charts-grid">
            <div class="card">
                <h4>各項港股佔比</h4>
                <div class="chart-wrapper">
                    <div class="chart-visual">
                        <canvas id="chartHKStock"></canvas>
                    </div>
                    <div id="legend-chartHKStock" class="chart-legend"></div>
                </div>
            </div>
            <div class="card">
                <h4>各項美股佔比</h4>
                <div class="chart-wrapper">
                    <div class="chart-visual">
                        <canvas id="chartUSStock"></canvas>
                    </div>
                    <div id="legend-chartUSStock" class="chart-legend"></div>
                </div>
            </div>
        </div>
    </div>
</div>
  <script src="github-sync.js"></script>
<script>
  // GitHub 同步設定
const DATA_FILENAME = 'portfolio-analyzer-data.json';

// 自動載入 GitHub 數據
async function initGitHubSync() {
    if (typeof GitHubSync === 'undefined') {
        console.log('GitHubSync 模組未載入');
        return;
    }
    if (!GitHubSync.isConfigured()) {
        console.log('GitHub 未設定');
        return;
    }
    
    const data = await GitHubSync.loadFromGitHub(DATA_FILENAME);
    if (data && Array.isArray(data)) {
        assets = data;
        saveToLocalStorage();
        renderTable();
        updateCharts();
        console.log('從 GitHub 載入數據:', data);
        GitHubSync.showSyncStatus('✅ 已從 GitHub 載入');
    }
}

// 同步到 GitHub
async function syncToGitHub() {
    if (typeof GitHubSync === 'undefined') {
        alert('GitHub 同步模組未載入，請確認 github-sync.js 檔案存在');
        console.error('GitHubSync is undefined');
        return;
    }
    
    if (!GitHubSync.isConfigured()) {
        alert('請先在 guide.html 設定 GitHub Token');
        return;
    }
    
    const success = await GitHubSync.saveToGitHub(DATA_FILENAME, assets);
    if (success) {
        alert('已同步到 GitHub！');
    } else {
        alert('同步失敗，請檢查設定');
    }
}

// 從 GitHub 載入
async function loadFromGitHub() {
    if (typeof GitHubSync === 'undefined') {
        alert('GitHub 同步模組未載入');
        return;
    }
    
    if (!GitHubSync.isConfigured()) {
        alert('請先在 guide.html 設定 GitHub Token');
        return;
    }
    
    const data = await GitHubSync.loadFromGitHub(DATA_FILENAME);
    if (data && Array.isArray(data)) {
        assets = data;
        saveToLocalStorage();
        renderTable();
        updateCharts();
        alert(`已從 GitHub 載入 ${assets.length} 筆資料！`);
    } else {
        alert('GitHub 上沒有找到資料');
    }
}
    // State Management
    let assets = [];
    let charts = {};

    // Type Mapping for display
    const typeLabels = {
        'hk_stock': '港股',
        'us_stock': '美股',
        'us_bond': '美債',
        'corp_bond': '公司債',
        'usd_fixed': '美金定期',
        'hkd_fixed': '港元定期'
    };

    // Default Color Palette
    const defaultColors = [
        '#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6', 
        '#34495e', '#1abc9c', '#e67e22', '#95a5a6', '#d35400',
        '#2980b9', '#c0392b', '#f39c12', '#27ae60', '#8e44ad'
    ];

    // Initialize
  window.onload = async function() {
    loadFromLocalStorage();
    renderTable();
    updateCharts();
    // 嘗試從 GitHub 載入（會覆蓋本地資料）
    await initGitHubSync();
};

    // --- Core Logic ---

    function getExchangeRate() {
        return parseFloat(document.getElementById('exchangeRate').value) || 7.8;
    }

    function calculateHKDValue(amount, currency) {
        if (currency === 'HKD') return parseFloat(amount);
        return parseFloat(amount) * getExchangeRate();
    }

    function addOrUpdateAsset() {
        const name = document.getElementById('assetName').value;
        const type = document.getElementById('assetType').value;
        const value = parseFloat(document.getElementById('marketValue').value);
        const currency = document.getElementById('currency').value;
        const editIndex = parseInt(document.getElementById('editIndex').value);

        if (!name || isNaN(value)) {
            alert("請輸入有效的名稱和市值");
            return;
        }

        const asset = {
            name,
            type,
            originalValue: value,
            currency
        };

        if (editIndex > -1) {
            assets[editIndex] = asset;
            document.getElementById('submitBtn').innerText = "新增資產";
            document.getElementById('submitBtn').classList.remove('btn-success');
            document.getElementById('submitBtn').classList.add('btn-primary');
        } else {
            assets.push(asset);
        }

        saveToLocalStorage();
        clearForm();
        renderTable();
        updateCharts();
    }

    function editAsset(index) {
        const asset = assets[index];
        document.getElementById('assetName').value = asset.name;
        document.getElementById('assetType').value = asset.type;
        document.getElementById('marketValue').value = asset.originalValue;
        document.getElementById('currency').value = asset.currency;
        document.getElementById('editIndex').value = index;
        
        const btn = document.getElementById('submitBtn');
        btn.innerText = "更新資產";
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success'); 
        window.scrollTo(0, 0);
    }

    function deleteAsset(index) {
        if(confirm("確定刪除此資產？")) {
            assets.splice(index, 1);
            saveToLocalStorage();
            renderTable();
            updateCharts();
        }
    }

    function clearForm() {
        document.getElementById('assetName').value = '';
        document.getElementById('marketValue').value = '';
        document.getElementById('editIndex').value = '-1';
        document.getElementById('submitBtn').innerText = "新增資產";
        document.getElementById('submitBtn').classList.remove('btn-success');
        document.getElementById('submitBtn').classList.add('btn-primary');
    }

    function updateAllCalculations() {
        renderTable();
        updateCharts();
    }

    function renderTable() {
        const tbody = document.querySelector('#assetTable tbody');
        tbody.innerHTML = '';

        assets.forEach((asset, index) => {
            const hkdValue = calculateHKDValue(asset.originalValue, asset.currency);
            const row = `
                <tr>
                    <td>${asset.name}</td>
                    <td>${typeLabels[asset.type]}</td>
                    <td>${asset.originalValue.toLocaleString()} ${asset.currency}</td>
                    <td>HKD ${hkdValue.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td>
                        <button class="btn-secondary" style="padding: 5px 10px; font-size: 0.8em;" onclick="editAsset(${index})">修改</button>
                        <button class="btn-danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="deleteAsset(${index})">刪除</button>
                        <button class="btn-primary" onclick="syncToGitHub()">同步到 GitHub</button>
<button class="btn-secondary" onclick="loadFromGitHub()">從 GitHub 載入</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- Data Persistence ---

    function saveToLocalStorage() {
        localStorage.setItem('portfolioData', JSON.stringify(assets));
    }

    function loadFromLocalStorage() {
        const data = localStorage.getItem('portfolioData');
        if (data) {
            assets = JSON.parse(data);
        }
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(assets));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "portfolio_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                assets = JSON.parse(e.target.result);
                saveToLocalStorage();
                renderTable();
                updateCharts();
                alert("導入成功！");
            } catch (err) {
                alert("導入失敗，檔案格式錯誤。");
            }
        };
        reader.readAsText(file);
        input.value = ''; 
    }

    function resetData() {
        if(confirm("確定清空所有資料？此操作無法復原。")) {
            assets = [];
            saveToLocalStorage();
            renderTable();
            updateCharts();
        }
    }

    // --- Charting Logic (Enhanced with Side Legend & Sorting) ---

    function getChartData(filterFn, labelFn) {
        const dataMap = {};
        assets.forEach(asset => {
            if (filterFn(asset)) {
                const label = labelFn(asset);
                const val = calculateHKDValue(asset.originalValue, asset.currency);
                dataMap[label] = (dataMap[label] || 0) + val;
            }
        });
        return {
            labels: Object.keys(dataMap),
            data: Object.values(dataMap)
        };
    }

    function createOrUpdateChart(canvasId, title, labels, data, customColors) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const legendId = 'legend-' + canvasId;
        const legendContainer = document.getElementById(legendId);
        
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }

        // 1. Combine Data for Sorting
        let combinedData = labels.map((label, i) => ({
            label: label,
            value: data[i],
            color: customColors ? customColors[i % customColors.length] : defaultColors[i % defaultColors.length]
        }));

        // 2. Sort by Value (High to Low)
        combinedData.sort((a, b) => b.value - a.value);

        // 3. Unpack sorted data for Chart.js
        const sortedLabels = combinedData.map(item => item.label);
        const sortedValues = combinedData.map(item => item.value);
        const sortedColors = combinedData.map(item => item.color);

        // 4. Calculate Total for Percentages
        const total = sortedValues.reduce((acc, curr) => acc + curr, 0);

        // 5. Create Chart
        charts[canvasId] = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: sortedLabels,
                datasets: [{
                    data: sortedValues,
                    backgroundColor: sortedColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: false // Disable default legend
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + "%" : "0%";
                                return context.label + ': HKD ' + Math.round(value).toLocaleString() + ' (' + percentage + ')';
                            }
                        }
                    }
                }
            }
        });

        // 6. Generate Custom Side Legend (High to Low)
        let legendHtml = '<ul>';
        if (total === 0) {
            legendHtml += '<li>無數據</li>';
        } else {
            combinedData.forEach(item => {
                const percentage = ((item.value / total) * 100).toFixed(1);
                legendHtml += `
                    <li>
                        <div class="legend-label-group">
                            <span class="legend-color-box" style="background-color: ${item.color}"></span>
                            <span>${item.label}</span>
                        </div>
                        <span class="legend-percent">${percentage}%</span>
                    </li>
                `;
            });
        }
        legendHtml += '</ul>';
        legendContainer.innerHTML = legendHtml;
    }

    function updateCharts() {
        // 1. Macro: Stock vs Bond vs Fixed
        const macroData = getChartData(
            () => true,
            (asset) => {
                if (asset.type.includes('stock')) return '股票';
                if (asset.type.includes('bond')) return '債券';
                if (asset.type.includes('fixed')) return '定期';
                return '其他';
            }
        );
        createOrUpdateChart('chartMacro', '股票 vs 債券 vs 定期', macroData.labels, macroData.data, ['#3498db', '#e74c3c', '#f1c40f']);

        // 2. Detailed Types
        const detailedData = getChartData(
            () => true,
            (asset) => {
                if (asset.type === 'hk_stock') return '港股';
                if (asset.type === 'us_stock') return '美股';
                if (asset.type === 'us_bond') return '美債';
                if (asset.type === 'corp_bond') return '公司債';
                if (asset.type.includes('fixed')) return '定期';
                return '其他';
            }
        );
        createOrUpdateChart('chartDetailedType', '詳細資產類別', detailedData.labels, detailedData.data);

        // 3. Stock Region
        const stockRegionData = getChartData(
            (asset) => asset.type.includes('stock'),
            (asset) => asset.type === 'hk_stock' ? '港股' : '美股'
        );
        createOrUpdateChart('chartStockRegion', '港股 vs 美股', stockRegionData.labels, stockRegionData.data, ['#e67e22', '#2980b9']);

        // 4. Bond Type
        const bondTypeData = getChartData(
            (asset) => asset.type.includes('bond'),
            (asset) => asset.type === 'us_bond' ? '美債' : '公司債'
        );
        createOrUpdateChart('chartBondType', '美債 vs 公司債', bondTypeData.labels, bondTypeData.data, ['#2ecc71', '#27ae60']);

        // 5. Fixed Deposit Type
        const fixedTypeData = getChartData(
            (asset) => asset.type.includes('fixed'),
            (asset) => asset.type === 'usd_fixed' ? '美元定期' : '港元定期'
        );
        createOrUpdateChart('chartFixedType', '美元定期 vs 港元定期', fixedTypeData.labels, fixedTypeData.data, ['#9b59b6', '#8e44ad']);

        // 6. HK Stock Individual
        const hkStockData = getChartData(
            (asset) => asset.type === 'hk_stock',
            (asset) => asset.name
        );
        createOrUpdateChart('chartHKStock', '各項港股佔比', hkStockData.labels, hkStockData.data);

        // 7. US Stock Individual
        const usStockData = getChartData(
            (asset) => asset.type === 'us_stock',
            (asset) => asset.name
        );
        createOrUpdateChart('chartUSStock', '各項美股佔比', usStockData.labels, usStockData.data);
    }

</script>

</body>
</html>
