<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚µåˆ¸æˆæœ¬å°æ¯”å°ç¨‹å¼</title>
    <style>
        /* === å…¨åŸŸè¨­å®šï¼Œç¢ºä¿é‚Šç•Œå°é½Š === */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            background: #f5f6fa;
            margin: 0;
            padding: 0;
            color: #222;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: #123456;
        }

        .subtitle {
            color: #555;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        /* === è¨ˆç®—æ¨¡å¼é¸æ“‡ === */
        .mode-selector {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .mode-selector label {
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .mode-selector select {
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* === å‚µåˆ¸è¼¸å…¥å®¹å™¨ === */
        .bonds-container {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .bond-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 320px;
        }

        /* === è¡¨å–®å¡ç‰‡ === */
        .card {
            background: #fff;
            border-radius: 10px;
            border: 1px solid #d0d8e8;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 1rem;
            flex: 1;
        }

        .card__body h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2a4d84;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .hint-text {
            font-size: 0.85rem;
            color: #555;
            margin-top: 4px;
        }

        /* === çµæœå¡ç‰‡ === */
        .result-card {
            background: #f8fbff;
            border: 1px solid #d0d8e8;
            border-radius: 10px;
            margin-top: 1rem;
            padding: 1rem;
            flex: 1;
            position: relative;
        }

        .result-card h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #123456;
            border-left: 4px solid #2a7ade;
            padding-left: 0.5rem;
        }

        .result-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .result-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0.8rem;
            border-bottom: 1px solid #e9eef5;
            font-size: 0.95rem;
        }

        .result-list li:last-child {
            border-bottom: none;
        }

        .result-list li span {
            color: #333;
        }

        .result-list li strong {
            color: #085f73;
        }

        .result-list li.highlight {
            background: #f5f2ef;
            border-radius: 6px;
            margin: 0.4rem 0;
            font-weight: bold;
        }

        /* === è¼ƒå„ªå‚µåˆ¸å¼·èª¿æ•ˆæœ === */
        .highlight-winner {
            background: #fff9e6 !important;
            border: 2px solid #f5b400 !important;
            box-shadow: 0 0 15px rgba(245, 180, 0, 0.3);
        }

        .highlight-winner::after {
            content: "ğŸ‰";
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 1.4rem;
        }

        /* === æ¯”è¼ƒçµæœ === */
        .comparison-summary {
            margin-top: 2rem;
        }

        .comparison-summary h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #123456;
        }

        .summary-items {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .summary-item {
            flex: 1;
            min-width: 320px;
            background: #f3fdf6;
            border: 1px solid #d8e9d8;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .summary-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #123456;
        }

        .summary-value {
            background: #e9f5ee;
            border: 1px solid #bcd8c7;
            padding: 0.7rem;
            border-radius: 6px;
            font-size: 0.95rem;
            line-height: 1.4;
            text-align: center;
        }

        /* === æŒ‰éˆ• === */
        .btn {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            border: none;
        }

        .btn--secondary {
            background: #eee;
            color: #333;
        }

        .btn--secondary:hover {
            background: #ddd;
        }

        .btn--lg {
            width: 100%;
            margin-top: 1rem;
        }

        .action-section {
            margin-top: 2rem;
        }

        /* === æ¯”è¼ƒè¡¨æ ¼æ¨£å¼ === */
        .comparison-table-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .comparison-table-container h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .compare-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .compare-table th,
        .compare-table td {
            border: 1px solid #e0e0e0;
            padding: 0.75rem;
            text-align: center;
        }

        .compare-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .compare-table td {
            font-size: 0.95rem;
        }

        .compare-table .highlight {
            background: #fff3cd;
            font-weight: 600;
        }

        .compare-table tbody tr:hover {
            background: #f9f9f9;
        }

        /* === éŸ¿æ‡‰å¼è¨­è¨ˆ === */
        @media (max-width: 768px) {
            .bonds-container {
                flex-direction: column;
            }
            
            .bond-section {
                min-width: 100%;
            }
            
            .summary-items {
                flex-direction: column;
            }
            
            .summary-item {
                min-width: 100%;
            }
        }
    </style>
    <script src="github-sync.js"></script>
</head>
<body>
    <a href="guide.html" style="position:fixed;top:10px;left:10px;padding:8px 16px;background:rgba(0,0,0,0.7);color:#fff;text-decoration:none;border-radius:6px;font-size:14px;z-index:9999;">â† è¿”å›æŒ‡å—</a>
    <div class="container">
        <header class="header">
            <h1>å‚µåˆ¸æˆæœ¬å°æ¯”å°ç¨‹å¼</h1>
            <p class="subtitle">æ¯”è¼ƒå…©ç¨®å‚µåˆ¸çš„æŠ•è³‡å›å ±ç‡ï¼ˆæ”¯æ´ç°¡æ˜“æ¨¡å¼ / å°ˆæ¥­æ¨¡å¼ï¼‰</p>
        </header>

        <div class="mode-selector">
            <label for="calcMode">è¨ˆç®—æ¨¡å¼ï¼š</label>
            <select id="calcMode">
                <option value="simple">ç°¡æ˜“æ¨¡å¼ï¼ˆåŸæœ¬å…¬å¼ï¼‰</option>
                <option value="pro">å°ˆæ¥­æ¨¡å¼ï¼ˆDirty Price / æ‡‰è¨ˆåˆ©æ¯ / åŠå¹´ä»˜æ¯ç­‰ï¼‰</option>
            </select>
        </div>

        <div class="bonds-container">
            <!-- å‚µåˆ¸ A -->
            <div class="bond-section" id="bondA">
                <div class="card">
                    <div class="card__body">
                        <h2>å‚µåˆ¸ A</h2>
                        <div class="form-group">
                            <label class="form-label">å‚µåˆ¸é¡å‹</label>
                            <select id="bondTypeA" class="form-control">
                                <option value="government">åœ‹å‚µ</option>
                                <option value="corporate">å…¬å¸å‚µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¥¨é¢æ¯ç‡ (%)</label>
                            <input type="number" id="couponRateA" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š3.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¢å€¼ ($)</label>
                            <input type="number" id="faceValueA" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¾è³¼è²·åƒ¹ (Clean Price)</label>
                            <input type="number" id="marketPriceA" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š98.5">
                            <p class="hint-text" id="actualPriceA">å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä»˜æ¯é »ç‡</label>
                            <select id="freqA" class="form-control">
                                <option value="2">åŠå¹´ä»˜</option>
                                <option value="1">å¹´ä»˜</option>
                                <option value="4">å­£ä»˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è²·å…¥æ—¥æœŸ</label>
                            <input type="date" id="purchaseDateA" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆ°æœŸæ—¥æœŸ</label>
                            <input type="date" id="maturityDateA" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="result-card">
                    <h2>å‚µåˆ¸ A çµæœ</h2>
                    <ul class="result-list">
                        <li><span>æŒæœ‰å¤©æ•¸ï¼š</span><strong id="holdingDaysA">-</strong></li>
                        <li><span>ç¥¨æ¯æ”¶ç›Šï¼š</span><strong id="couponIncomeA">-</strong></li>
                        <li><span>è³‡æœ¬æ”¶ç›Šï¼š</span><strong id="capitalGainA">-</strong></li>
                        <li class="highlight"><span>ç¸½æ”¶ç›Šï¼š</span><strong id="totalReturnA">-</strong></li>
                        <li class="highlight"><span>æ‰£é™¤æˆæœ¬å¾Œæ”¶ç›Šï¼š</span><strong id="profitAfterCostA">-</strong></li>
                        <li><span>å¹´åŒ–æ¯ç‡ï¼š</span><strong id="annualizedYieldRateA">-</strong></li>
                        <li><span>æ‰£é™¤æˆæœ¬å¾Œå¹´åŒ–æ¯ç‡ï¼š</span><strong id="annualizedYieldRateAfterCostA">-</strong></li>
                        <li><span>IRRï¼ˆå…§éƒ¨å ±é…¬ç‡ï¼‰ï¼š</span><strong id="irrA">-</strong></li>
                        <li><span>æ‰£æˆæœ¬å¾Œ IRRï¼š</span><strong id="irrAfterCostA">-</strong></li>
                        <li><span>YTMï¼ˆåˆ°æœŸæ”¶ç›Šç‡ï¼‰ï¼š</span><strong id="ytmA">-</strong></li>
                        <li><span>æ‰£æˆæœ¬å¾Œ YTMï¼š</span><strong id="ytmAfterCostA">-</strong></li>
                    </ul>
                </div>
            </div>

            <!-- å‚µåˆ¸ B -->
            <div class="bond-section" id="bondB">
                <div class="card">
                    <div class="card__body">
                        <h2>å‚µåˆ¸ B</h2>
                        <div class="form-group">
                            <label class="form-label">å‚µåˆ¸é¡å‹</label>
                            <select id="bondTypeB" class="form-control">
                                <option value="government">åœ‹å‚µ</option>
                                <option value="corporate">å…¬å¸å‚µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¥¨é¢æ¯ç‡ (%)</label>
                            <input type="number" id="couponRateB" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š3.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">é¢å€¼ ($)</label>
                            <input type="number" id="faceValueB" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç¾è³¼è²·åƒ¹ (Clean Price)</label>
                            <input type="number" id="marketPriceB" class="form-control" step="0.01" placeholder="ä¾‹å¦‚ï¼š98.5">
                            <p class="hint-text" id="actualPriceB">å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ä»˜æ¯é »ç‡</label>
                            <select id="freqB" class="form-control">
                                <option value="2">åŠå¹´ä»˜</option>
                                <option value="1">å¹´ä»˜</option>
                                <option value="4">å­£ä»˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">è²·å…¥æ—¥æœŸ</label>
                            <input type="date" id="purchaseDateB" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">åˆ°æœŸæ—¥æœŸ</label>
                            <input type="date" id="maturityDateB" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="result-card">
                    <h2>å‚µåˆ¸ B çµæœ</h2>
                    <ul class="result-list">
                        <li><span>æŒæœ‰å¤©æ•¸ï¼š</span><strong id="holdingDaysB">-</strong></li>
                        <li><span>ç¥¨æ¯æ”¶ç›Šï¼š</span><strong id="couponIncomeB">-</strong></li>
                        <li><span>è³‡æœ¬æ”¶ç›Šï¼š</span><strong id="capitalGainB">-</strong></li>
                        <li class="highlight"><span>ç¸½æ”¶ç›Šï¼š</span><strong id="totalReturnB">-</strong></li>
                        <li class="highlight"><span>æ‰£é™¤æˆæœ¬å¾Œæ”¶ç›Šï¼š</span><strong id="profitAfterCostB">-</strong></li>
                        <li><span>å¹´åŒ–æ¯ç‡ï¼š</span><strong id="annualizedYieldRateB">-</strong></li>
                        <li><span>æ‰£é™¤æˆæœ¬å¾Œå¹´åŒ–æ¯ç‡ï¼š</span><strong id="annualizedYieldRateAfterCostB">-</strong></li>
                        <li><span>IRRï¼ˆå…§éƒ¨å ±é…¬ç‡ï¼‰ï¼š</span><strong id="irrB">-</strong></li>
                        <li><span>æ‰£æˆæœ¬å¾Œ IRRï¼š</span><strong id="irrAfterCostB">-</strong></li>
                        <li><span>YTMï¼ˆåˆ°æœŸæ”¶ç›Šç‡ï¼‰ï¼š</span><strong id="ytmB">-</strong></li>
                        <li><span>æ‰£æˆæœ¬å¾Œ YTMï¼š</span><strong id="ytmAfterCostB">-</strong></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="comparison-summary">
            <h3>æ¯”è¼ƒçµæœ</h3>
            <div class="summary-items">
                <div class="summary-item">
                    <div class="summary-label">ç¸½æ”¶ç›Šæ¯”è¼ƒ</div>
                    <div class="summary-value" id="returnComparison">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ‰£é™¤æˆæœ¬å¾Œæ”¶ç›Šæ¯”è¼ƒ</div>
                    <div class="summary-value" id="costComparison">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">å¹´åŒ–æ¯ç‡æ¯”è¼ƒ</div>
                    <div class="summary-value" id="yieldComparison">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">æ‰£é™¤æˆæœ¬å¾Œå¹´åŒ–æ¯ç‡æ¯”è¼ƒ</div>
                    <div class="summary-value" id="yieldAfterCostComparison">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</div>
                </div>
            </div>
        </div>

        <div class="action-section">
            <button id="resetBtn" class="btn btn--secondary btn--lg">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        </div>

        <div class="comparison-table-container">
            <h3>è©³ç´°æ¯”è¼ƒè¡¨æ ¼</h3>
            <table class="compare-table">
                <thead>
                    <tr>
                        <th>æŒ‡æ¨™</th>
                        <th>å‚µåˆ¸ A</th>
                        <th>å‚µåˆ¸ B</th>
                        <th>å„ªå‹</th>
                    </tr>
                </thead>
                <tbody id="comparisonTableBody">
                    <tr><td colspan="4">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // =========================================================
        // å‚µåˆ¸æ¯”è¼ƒå°ç¨‹å¼ - å¢å¼·ç‰ˆï¼ˆå« IRRã€YTMã€æ¯”è¼ƒç¸½è¡¨æ ¼ï¼‰
        // =========================================================

     // GitHub åŒæ­¥è¨­å®š
const DATA_FILENAME = 'bond-compare-data.json';

// è‡ªå‹•è¼‰å…¥ GitHub æ•¸æ“š
(async function initGitHubSync() {
    if (typeof GitHubSync !== 'undefined' && GitHubSync.isConfigured()) {
        const data = await GitHubSync.loadFromGitHub(DATA_FILENAME);
        if (data) {
            // å¦‚æœæœ‰è¼‰å…¥è³‡æ–™çš„å‡½æ•¸ï¼Œåœ¨é€™è£¡å‘¼å«
            console.log('å¾ GitHub è¼‰å…¥æ•¸æ“š:', data);
            GitHubSync.showSyncStatus('âœ… å·²å¾ GitHub è¼‰å…¥');
        }
    }
})();

// åœ¨ç¾æœ‰çš„å°å‡ºå‡½æ•¸ä¸­åŠ å…¥ GitHub åŒæ­¥
function syncToGitHub(data) {
    if (typeof GitHubSync !== 'undefined' && GitHubSync.isConfigured()) {
        GitHubSync.saveToGitHub(DATA_FILENAME, data);
    }
}
        class BondCalculator {
            constructor() {
                this.bondA = this.initBond();
                this.bondB = this.initBond();
                this.calcMode = "simple";
                this.init();
            }

            initBond() {
                return {
                    bondType: "government",
                    couponRate: 0,
                    faceValue: 0,
                    cleanPrice: 0,
                    purchasePrice: 0,
                    freq: 2,
                    purchaseDate: null,
                    maturityDate: null,
                    results: {}
                };
            }

            init() {
                this.setupEventListeners();
                this.updateAllCalculations();
            }

            setupEventListeners() {
                document.getElementById("calcMode").addEventListener("change", (e) => {
                    this.calcMode = e.target.value;
                    this.updateAllCalculations();
                });

                ["bondTypeA","couponRateA","faceValueA","marketPriceA","freqA","purchaseDateA","maturityDateA"].forEach(id => {
                    document.getElementById(id).addEventListener("input", () => this.handleInput("A"));
                });

                ["bondTypeB","couponRateB","faceValueB","marketPriceB","freqB","purchaseDateB","maturityDateB"].forEach(id => {
                    document.getElementById(id).addEventListener("input", () => this.handleInput("B"));
                });

                document.getElementById("resetBtn").addEventListener("click", () => this.resetAll());
            }

            handleInput(tag) {
                this.updateBondData(tag);
                this.calculateBond(tag);
                this.updateDisplay(tag);
                this.updateComparison();
                this.updateComparisonTable();
            }

            updateBondData(tag) {
                const bond = tag === "A" ? this.bondA : this.bondB;
                const s = tag;

                bond.bondType = document.getElementById(`bondType${s}`).value;
                bond.couponRate = parseFloat(document.getElementById(`couponRate${s}`).value) || 0;
                bond.faceValue = parseFloat(document.getElementById(`faceValue${s}`).value) || 0;
                bond.cleanPrice = parseFloat(document.getElementById(`marketPrice${s}`).value) || 0;
                bond.freq = parseInt(document.getElementById(`freq${s}`).value) || 2;

                const pd = document.getElementById(`purchaseDate${s}`).value;
                const md = document.getElementById(`maturityDate${s}`).value;
                bond.purchaseDate = pd ? new Date(pd) : null;
                bond.maturityDate = md ? new Date(md) : null;

                const disp = document.getElementById(`actualPrice${s}`);
                if (this.calcMode === "simple") {
                    if (bond.cleanPrice > 0 && bond.faceValue > 0) {
                        bond.purchasePrice = bond.cleanPrice * (bond.faceValue / 100);
                        disp.textContent = `å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š$${bond.purchasePrice.toFixed(2)}`;
                    } else {
                        bond.purchasePrice = 0;
                        disp.textContent = "å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-";
                    }
                } else {
                    if (bond.cleanPrice > 0 && bond.faceValue > 0 && bond.purchaseDate) {
                        const acc = this.calcAccruedInterest(bond);
                        bond.purchasePrice = (bond.cleanPrice + acc) * (bond.faceValue / 100);
                        disp.textContent = `å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š$${bond.purchasePrice.toFixed(2)}ï¼ˆå«æ‡‰è¨ˆåˆ©æ¯ ${acc.toFixed(4)}ï¼‰`;
                    } else {
                        bond.purchasePrice = 0;
                        disp.textContent = "å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-";
                    }
                }
            }

            calcAccruedInterest(bond) {
                if (bond.couponRate <= 0 || !bond.maturityDate || !bond.purchaseDate) return 0;
                const freq = bond.freq;
                const periodMonths = 12 / freq;
                let d = new Date(bond.maturityDate);

                while (true) {
                    let prev = new Date(d);
                    prev.setMonth(prev.getMonth() - periodMonths);
                    if (prev <= bond.purchaseDate) {
                        const lastCoupon = new Date(prev);
                        const nextCoupon = new Date(prev);
                        nextCoupon.setMonth(nextCoupon.getMonth() + periodMonths);
                        const diff1 = (bond.purchaseDate - lastCoupon) / (1000 * 3600 * 24);
                        const diff2 = (nextCoupon - lastCoupon) / (1000 * 3600 * 24);
                        return (diff1 / diff2) * (bond.couponRate / freq);
                    }
                    d = prev;
                }
            }

            calculateBond(tag) {
                const bond = tag === "A" ? this.bondA : this.bondB;
                
                bond.results = {
                    holdingDays: 0,
                    couponIncome: 0,
                    capitalGain: 0,
                    totalReturn: 0,
                    cost: 0,
                    profitAfterCost: 0,
                    annualizedYieldRate: 0,
                    annualizedYieldRateAfterCost: 0,
                    irr: 0,
                    irrAfterCost: 0,
                    ytm: 0,
                    ytmAfterCost: 0,
                    isValid: false
                };

                if (!this.validateBondInputs(bond)) return;

                const holdingDays = Math.floor((bond.maturityDate - bond.purchaseDate) / (1000 * 3600 * 24));
                bond.results.holdingDays = holdingDays;
                if (holdingDays <= 0) return;

                // åŸºæœ¬è¨ˆç®—
                if (this.calcMode === "simple") {
                    bond.results.couponIncome = (bond.faceValue * bond.couponRate / 100 / 365) * holdingDays;
                } else {
                    bond.results.couponIncome = this.calcCouponIncomePro(bond);
                }

                bond.results.capitalGain = bond.faceValue - bond.purchasePrice;
                bond.results.totalReturn = bond.results.couponIncome + bond.results.capitalGain;
                bond.results.cost = bond.bondType === "government" ? 5 : bond.faceValue * 0.001;
                bond.results.profitAfterCost = bond.results.totalReturn - bond.results.cost;

                const yr = holdingDays / 365;
                bond.results.annualizedYieldRate = (bond.results.totalReturn / bond.purchasePrice) / yr * 100;
                bond.results.annualizedYieldRateAfterCost = (bond.results.profitAfterCost / bond.purchasePrice) / yr * 100;

                // è¨ˆç®— IRR
                bond.results.irr = this.calcIRR(bond, false);
                bond.results.irrAfterCost = this.calcIRR(bond, true);

                // è¨ˆç®— YTM
                bond.results.ytm = this.calcYTM(bond, false);
                bond.results.ytmAfterCost = this.calcYTM(bond, true);

                bond.results.isValid = true;
            }

            calcCouponIncomePro(bond) {
                if (bond.couponRate <= 0) return 0;
                const freq = bond.freq;
                const couponEach = (bond.couponRate / 100 * bond.faceValue) / freq;
                const purchase = new Date(bond.purchaseDate);
                const maturity = new Date(bond.maturityDate);
                const periodMonths = 12 / freq;

                let payDates = [];
                let d = new Date(maturity);

                while (true) {
                    payDates.push(new Date(d));
                    let prev = new Date(d);
                    prev.setMonth(prev.getMonth() - periodMonths);
                    if (prev < purchase) break;
                    d = prev;
                }

                let count = 0;
                for (const pd of payDates) {
                    if (pd > purchase && pd <= maturity) count++;
                }
                return count * couponEach;
            }

            // IRR è¨ˆç®—ï¼ˆä½¿ç”¨ç‰›é “æ³•ï¼‰
            calcIRR(bond, afterCost = false) {
                if (!bond.purchaseDate || !bond.maturityDate) return 0;
                
                const cashFlows = this.getCashFlows(bond, afterCost);
                if (cashFlows.length === 0) return 0;

                let rate = 0.05; // åˆå§‹çŒœæ¸¬ 5%
                const maxIterations = 50;
                const tolerance = 0.00001;

                for (let i = 0; i < maxIterations; i++) {
                    const npv = this.calcNPV(cashFlows, rate);
                    const dnpv = this.calcNPVDerivative(cashFlows, rate);
                    if (Math.abs(dnpv) < tolerance) break;
                    
                    const newRate = rate - npv / dnpv;
                    if (Math.abs(newRate - rate) < tolerance) break;
                    rate = newRate;
                }
                return rate * 100;
            }

            // YTM è¨ˆç®—
            calcYTM(bond, afterCost = false) {
                if (!bond.purchaseDate || !bond.maturityDate || bond.purchasePrice === 0) return 0;
                
                const years = (bond.maturityDate - bond.purchaseDate) / (365 * 24 * 60 * 60 * 1000);
                if (years <= 0) return 0;

                const totalIncome = afterCost ? bond.results.profitAfterCost : bond.results.totalReturn;
                const finalValue = bond.purchasePrice + totalIncome;
                
                // YTM = ((FV/PV)^(1/n) - 1) * 100
                return (Math.pow(finalValue / bond.purchasePrice, 1 / years) - 1) * 100;
            }

            getCashFlows(bond, afterCost) {
                const flows = [];
                if (!bond.purchaseDate || !bond.maturityDate) return flows;

                // åˆå§‹æŠ•è³‡ï¼ˆè² å€¼ï¼‰
                flows.push({
                    date: new Date(bond.purchaseDate),
                    amount: -bond.purchasePrice
                });

                // ç¥¨æ¯æ”¶å…¥
                if (bond.couponRate > 0) {
                    const freq = bond.freq;
                    const couponEach = (bond.couponRate / 100 * bond.faceValue) / freq;
                    const periodMonths = 12 / freq;
                    
                    let d = new Date(bond.maturityDate);
                    let payDates = [];
                    
                    while (d > bond.purchaseDate) {
                        if (d <= bond.maturityDate) {
                            payDates.push(new Date(d));
                        }
                        d.setMonth(d.getMonth() - periodMonths);
                    }
                    
                    payDates.forEach(date => {
                        flows.push({
                            date: date,
                            amount: couponEach
                        });
                    });
                }

                // åˆ°æœŸé‚„æœ¬
                let finalAmount = bond.faceValue;
                if (afterCost) {
                    finalAmount -= bond.results.cost;
                }
                
                flows.push({
                    date: new Date(bond.maturityDate),
                    amount: finalAmount
                });

                return flows;
            }

            calcNPV(cashFlows, rate) {
                if (cashFlows.length === 0) return 0;
                const startDate = cashFlows[0].date;
                let npv = 0;

                cashFlows.forEach(flow => {
                    const days = (flow.date - startDate) / (1000 * 60 * 60 * 24);
                    const years = days / 365;
                    npv += flow.amount / Math.pow(1 + rate, years);
                });
                return npv;
            }

            calcNPVDerivative(cashFlows, rate) {
                if (cashFlows.length === 0) return 0;
                const startDate = cashFlows[0].date;
                let dnpv = 0;

                cashFlows.forEach(flow => {
                    const days = (flow.date - startDate) / (1000 * 60 * 60 * 24);
                    const years = days / 365;
                    dnpv -= years * flow.amount / Math.pow(1 + rate, years + 1);
                });
                return dnpv;
            }

            validateBondInputs(bond) {
                return (
                    bond.faceValue > 0 &&
                    bond.cleanPrice > 0 &&
                    bond.purchaseDate &&
                    bond.maturityDate &&
                    bond.maturityDate > bond.purchaseDate
                );
            }

            updateDisplay(tag) {
                const r = tag === "A" ? this.bondA.results : this.bondB.results;
                if (!r.isValid) {
                    this.clearDisplays(tag);
                    return;
                }

                document.getElementById(`holdingDays${tag}`).textContent = r.holdingDays + " å¤©";
                document.getElementById(`couponIncome${tag}`).textContent = "$" + r.couponIncome.toFixed(2);
                document.getElementById(`capitalGain${tag}`).textContent = "$" + r.capitalGain.toFixed(2);
                document.getElementById(`totalReturn${tag}`).textContent = "$" + r.totalReturn.toFixed(2);
                document.getElementById(`profitAfterCost${tag}`).textContent = "$" + r.profitAfterCost.toFixed(2);
                document.getElementById(`annualizedYieldRate${tag}`).textContent = r.annualizedYieldRate.toFixed(2) + "%";
                document.getElementById(`annualizedYieldRateAfterCost${tag}`).textContent = r.annualizedYieldRateAfterCost.toFixed(2) + "%";
                document.getElementById(`irr${tag}`).textContent = r.irr.toFixed(2) + "%";
                document.getElementById(`irrAfterCost${tag}`).textContent = r.irrAfterCost.toFixed(2) + "%";
                document.getElementById(`ytm${tag}`).textContent = r.ytm.toFixed(2) + "%";
                document.getElementById(`ytmAfterCost${tag}`).textContent = r.ytmAfterCost.toFixed(2) + "%";
            }

            clearDisplays(tag) {
                ["holdingDays","couponIncome","capitalGain","totalReturn","profitAfterCost",
                 "annualizedYieldRate","annualizedYieldRateAfterCost","irr","irrAfterCost","ytm","ytmAfterCost"].forEach(f => {
                    const el = document.getElementById(`${f}${tag}`);
                    if (el) el.textContent = "-";
                });
            }

            updateComparison() {
                const A = this.bondA.results;
                const B = this.bondB.results;

                const boxes = {
                    r: document.getElementById("returnComparison"),
                    c: document.getElementById("costComparison"),
                    y: document.getElementById("yieldComparison"),
                    yc: document.getElementById("yieldAfterCostComparison")
                };

                document.querySelectorAll(".result-card").forEach(el => {
                    el.classList.remove("highlight-winner");
                });

                if (!A.isValid || !B.isValid) {
                    Object.values(boxes).forEach(el => el.textContent = "è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥");
                    return;
                }

                const compare = (x, y, name) => {
                    if (x > y) return `å‚µåˆ¸ A è¼ƒå„ª<br>${name} å¤š ${(x - y).toFixed(2)}`;
                    if (y > x) return `å‚µåˆ¸ B è¼ƒå„ª<br>${name} å¤š ${(y - x).toFixed(2)}`;
                    return `å…©è€…ç›¸åŒ<br>${name} å·®ç•° 0.00`;
                };

                boxes.r.innerHTML = compare(A.totalReturn, B.totalReturn, "ç¸½æ”¶ç›Š");
                boxes.c.innerHTML = compare(A.profitAfterCost, B.profitAfterCost, "æ‰£é™¤æˆæœ¬å¾Œæ”¶ç›Š");
                boxes.y.innerHTML = compare(A.annualizedYieldRate, B.annualizedYieldRate, "å¹´åŒ–æ¯ç‡ (%)");
                boxes.yc.innerHTML = compare(A.annualizedYieldRateAfterCost, B.annualizedYieldRateAfterCost, "æ‰£é™¤æˆæœ¬å¾Œå¹´åŒ– (%)");

                if (A.profitAfterCost > B.profitAfterCost) {
                    document.querySelector("#bondA .result-card").classList.add("highlight-winner");
                } else if (B.profitAfterCost > A.profitAfterCost) {
                    document.querySelector("#bondB .result-card").classList.add("highlight-winner");
                }
            }

            updateComparisonTable() {
                const table = document.getElementById("comparisonTableBody");
                if (!table) return;

                const A = this.bondA.results;
                const B = this.bondB.results;

                if (!A.isValid || !B.isValid) {
                    table.innerHTML = '<tr><td colspan="4">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</td></tr>';
                    return;
                }

                const rows = [
                    { label: "ç¸½æ”¶ç›Š", a: A.totalReturn, b: B.totalReturn, format: "$" },
                    { label: "æ‰£æˆæœ¬å¾Œæ”¶ç›Š", a: A.profitAfterCost, b: B.profitAfterCost, format: "$" },
                    { label: "å¹´åŒ–æ¯ç‡", a: A.annualizedYieldRate, b: B.annualizedYieldRate, format: "%" },
                    { label: "æ‰£æˆæœ¬å¾Œå¹´åŒ–", a: A.annualizedYieldRateAfterCost, b: B.annualizedYieldRateAfterCost, format: "%" },
                    { label: "IRR", a: A.irr, b: B.irr, format: "%" },
                    { label: "æ‰£æˆæœ¬å¾Œ IRR", a: A.irrAfterCost, b: B.irrAfterCost, format: "%" },
                    { label: "YTM", a: A.ytm, b: B.ytm, format: "%" },
                    { label: "æ‰£æˆæœ¬å¾Œ YTM", a: A.ytmAfterCost, b: B.ytmAfterCost, format: "%" }
                ];

                let html = '';
                rows.forEach(row => {
                    const winner = row.a > row.b ? "A" : row.b > row.a ? "B" : "å¹³æ‰‹";
                    const aClass = winner === "A" ? "highlight" : "";
                    const bClass = winner === "B" ? "highlight" : "";
                    const winnerClass = winner !== "å¹³æ‰‹" ? "highlight" : "";

                    const aVal = row.format === "$" ? `$${row.a.toFixed(2)}` : `${row.a.toFixed(2)}%`;
                    const bVal = row.format === "$" ? `$${row.b.toFixed(2)}` : `${row.b.toFixed(2)}%`;

                    html += `
                        <tr>
                            <td>${row.label}</td>
                            <td class="${aClass}">${aVal}</td>
                            <td class="${bClass}">${bVal}</td>
                            <td class="${winnerClass}">${winner}</td>
                        </tr>
                    `;
                });
                table.innerHTML = html;
            }

            resetAll() {
                ["bondTypeA","couponRateA","faceValueA","marketPriceA","freqA","purchaseDateA","maturityDateA",
                 "bondTypeB","couponRateB","faceValueB","marketPriceB","freqB","purchaseDateB","maturityDateB"].forEach(id => {
                    const el = document.getElementById(id);
                    if (el.tagName === "SELECT") {
                        // Don't clear selects, just reset to default
                    } else {
                        el.value = "";
                    }
                });

                document.getElementById("bondTypeA").value = "government";
                document.getElementById("bondTypeB").value = "government";
                document.getElementById("freqA").value = "2";
                document.getElementById("freqB").value = "2";
                document.getElementById("actualPriceA").textContent = "å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-";
                document.getElementById("actualPriceB").textContent = "å¯¦éš›è²·å…¥åƒ¹æ ¼ï¼š-";

                this.bondA = this.initBond();
                this.bondB = this.initBond();
                this.updateAllCalculations();
            }

            updateAllCalculations() {
                this.handleInput("A");
                this.handleInput("B");
            }
        }

        document.addEventListener("DOMContentLoaded", () => new BondCalculator());
    </script>
</body>
</html>