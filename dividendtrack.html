<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•è³‡æ”¶ç›Šè¿½è¹¤å„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
/* ========================
   å…¨å±€æ¨£å¼èˆ‡è®Šæ•¸
======================== */
:root {
    --primary-color: #1FB8CD;
    --secondary-color: #FFC185;
    --danger-color: #DB4545;
    --text-color: #333;
    --bg-color: #f8f9fa;
    --border-color: #ddd;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
    --radius: 8px;
    --transition: all 0.3s ease;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ========================
   å¹´ä»½é¸å–®
======================== */
.year-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}
.year-selector label {
    font-size: 1rem;
    color: var(--text-color);
}
.year-selector select {
    font-size: 1rem;
    padding: 4px 8px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

/* ========================
   æ¨™é¡Œå€
======================== */
.app-header {
    text-align: center;
    margin-bottom: 30px;
}

.app-header h1 {
    font-size: 2.2rem;
    color: var(--primary-color);
    margin-bottom: 8px;
}

.app-header p {
    font-size: 1.1rem;
    color: #666;
}

/* ========================
   æ•¸æ“šæ§åˆ¶å€
======================== */
.data-controls {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
    padding: 12px;
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
    text-transform: uppercase;
    font-weight: 500;
}

.btn--primary {
    background-color: var(--primary-color);
    color: white;
}

.btn--primary:hover {
    background-color: #189ca3;
}

.btn--secondary {
    background-color: #f0f0f0;
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn--secondary:hover {
    background-color: #e0e0e0;
}

.btn--danger {
    background-color: var(--danger-color);
    color: white;
}

.btn--danger:hover {
    background-color: #b43636;
}

.btn--outline {
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
}

.btn--outline:hover {
    background-color: #f0f0f0;
}

.btn--sm {
    padding: 6px 12px;
    font-size: 0.9rem;
}

.btn--full-width {
    width: 100%;
}

/* ========================
   æ¨™ç±¤å°èˆª
======================== */
.tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.tab-btn {
    padding: 12px 24px;
    background: #f0f0f0;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    transition: var(--transition);
}

.tab-btn--active {
    background: var(--primary-color);
    color: white;
}

.tab-btn:hover {
    background: #e0e0e0;
}

.tab-btn--active:hover {
    background: var(--primary-color);
}

/* ========================
   æ¨™ç±¤å…§å®¹å€
======================== */
.tab-panes {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px;
}

.tab-pane {
    display: none;
}

.tab-pane--active {
    display: block;
}

/* ========================
   æ¦‚è¦½å¡ç‰‡
======================== */
.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
}

.card {
    background: #fff;
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.card h3 {
    font-size: 1.2rem;
    margin-bottom: 8px;
    color: var(--primary-color);
}

.amount {
    font-size: 1.6rem;
    font-weight: bold;
    color: var(--text-color);
}

.prediction-label {
    font-size: 0.8rem;
    color: #666;
    background: #f0f0f0;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 4px;
}

/* ========================
   æ”¶ç›Šä¾†æºåˆ†ä½ˆ
======================== */
.percentage {
    margin-top: 12px;
}

.bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-size: 0.9rem;
}

.bar .label {
    color: #666;
}

.bar .value {
    font-weight: 500;
    color: var(--primary-color);
}
/* ========================
   æœˆåº¦å¡ç‰‡ï¼ˆå„ªåŒ–ç‚ºæ¯è¡Œé¡¯ç¤ºä¸€æœˆï¼‰
======================== */
.monthly-cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 20px;
}
.monthly-card {
    min-height: 120px;
}
.monthly-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.monthly-card--empty {
    opacity: 0.6;
}

.monthly-card__header {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 6px;
    margin-bottom: 8px;
}

.monthly-card__total {
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--text-color);
    text-align: center;
    padding: 10px 0;
    background: #f8f9fa;
    border-radius: var(--radius);
}
.monthly-card__items {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 300px;
    overflow: hidden;
    padding: 4px 0;
    transition: max-height 0.3s ease;
}

.monthly-card__items.expanded {
    max-height: 1000px;
    overflow: visible;
}

.monthly-item {
    display: grid;
    grid-template-columns: 1fr 120px;
    gap: 12px;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
    background: #f8f9fa;
    border-radius: 4px;
    width: 100%;
    box-sizing: border-box;
}

.monthly-item__info {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.monthly-item__name {
    font-weight: 500;
    color: var(--text-color);
    font-size: 0.95rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.monthly-item__details {
    font-size: 0.75rem;
    color: #666;
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
}

.monthly-item__type {
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
}

.monthly-item__type--confirmed {
    background: #c2e0e6;
    color: #1f6a79;
}

.monthly-item__type--predicted {
    background: #f4e0c0;
    color: #8a5c00;
}

.monthly-item__type--deposit {
    background: #d9f0e1;
    color: #2d7b3d;
}

.monthly-item__type--bond {
    background: #e9d3d3;
    color: #8a3333;
}

.monthly-item__amount {
    font-weight: 600;
    color: var(--primary-color);
    white-space: nowrap;
    text-align: right;
    font-size: 0.95rem;
    justify-self: end;
}

.monthly-card__expand-btn {
    display: block;
    width: 100%;
    text-align: center;
    padding: 8px 0;
    background: #f0f0f0;
    border: 1px dashed #ccc;
    border-radius: 4px;
    margin-top: 8px;
    font-size: 0.9rem;
    color: var(--primary-color);
    cursor: pointer;
    transition: var(--transition);
}

.monthly-card__expand-btn:hover {
    background: #e0e0e0;
}

.monthly-card__items.expanded .monthly-card__expand-btn {
    display: none;
}

/* ========================
   æŠ•è³‡åˆ†ææ‘˜è¦
======================== */
#analysis-summary {
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border-color);
    margin-top: 20px;
    font-size: 0.95rem;
}

#analysis-summary .summary-item {
    margin-bottom: 12px;
    line-height: 1.5;
    font-weight: 500;
}

/* ========================
   è‚¡ç¥¨/å­˜æ¬¾/å‚µåˆ¸å€å¡Š
======================== */
.section {
    margin-bottom: 30px;
}

.section h2 {
    font-size: 1.4rem;
    margin-bottom: 16px;
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
}

.stock-entry,
.bond-entry {
    background: #fff;
    border-radius: var(--radius);
    margin-bottom: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.stock-header,
.bond-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 10px;
}

.stock-info h3,
.bond-info h3 {
    font-size: 1.3rem;
    margin-bottom: 4px;
    color: var(--text-color);
}

.stock-code,
.bond-code {
    font-size: 0.9rem;
    color: #666;
}

.stock-actions,
.bond-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.stock-actions label,
.bond-actions label {
    font-size: 0.9rem;
    color: #666;
}

.form-control {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    font-size: 1rem;
    width: 100px;
}

.form-control[readonly] {
    background-color: #f8f9fa !important;
    color: #666 !important;
    cursor: not-allowed;
}

/* ========================
   æ´¾æ¯è¨˜éŒ„è¡¨æ ¼æ¨£å¼ï¼ˆæ–°å¢æ‘ºç–ŠåŠŸèƒ½ï¼‰
======================== */
.dividend-table,
.bond-payment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 0.9rem;
}

.dividend-table th,
.dividend-table td,
.bond-payment-table th,
.bond-payment-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.dividend-table th,
.bond-payment-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: var(--text-color);
}

.dividend-table .form-control,
.bond-payment-table .form-control {
    width: 100%;
    min-width: 80px;
    padding: 4px 8px;
    font-size: 0.85rem;
}

/* è¡¨æ ¼æ‘ºç–ŠåŠŸèƒ½æ¨£å¼ */
.table-wrapper {
    position: relative;
}

.table-collapsed {
    max-height: 280px;
    overflow: hidden;
    position: relative;
}

.table-collapsed::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(transparent, rgba(248, 249, 250, 0.9));
    pointer-events: none;
}

.table-expand-btn {
    display: block;
    width: 100%;
    text-align: center;
    padding: 8px 0;
    background: #f0f0f0;
    border: 1px dashed #ccc;
    border-radius: 4px;
    margin-top: 8px;
    font-size: 0.9rem;
    color: var(--primary-color);
    cursor: pointer;
    transition: var(--transition);
    border: none;
}

.table-expand-btn:hover {
    background: #e0e0e0;
}

.table-expand-btn .expand-text {
    display: inline;
}

.table-expand-btn .collapse-text {
    display: none;
}

.table-wrapper.expanded .table-collapsed {
    max-height: none;
    overflow: visible;
}

.table-wrapper.expanded .table-collapsed::after {
    display: none;
}

.table-wrapper.expanded .table-expand-btn .expand-text {
    display: none;
}

.table-wrapper.expanded .table-expand-btn .collapse-text {
    display: inline;
}

.dividend-section,
.bond-payment-section {
    margin-top: 16px;
}

.add-dividend-btn,
.add-bond-payment-btn {
    margin-top: 12px;
}

.deposit-entry {
    background: #fff;
    border-radius: var(--radius);
    margin-bottom: 16px;
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.entry-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 12px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-size: 0.9rem;
    margin-bottom: 4px;
    color: var(--text-color);
}

.entry-actions {
    text-align: right;
}

/* ========================
   ç©ºç‹€æ…‹
======================== */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
    font-size: 1.1rem;
}

/* ========================
   æ¨¡æ…‹æ¡†
======================== */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal {
    background: white;
    width: 90%;
    max-width: 500px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--primary-color);
    color: white;
}

.modal-close {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 16px 20px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
}

/* ========================
   å †ç–Šæ¢å½¢åœ–æ¨£å¼
======================== */
#monthlyChart {
    height: 400px !important;
}

/* ========================
   åˆ†æåœ–è¡¨
======================== */
.analysis-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    margin-top: 20px;
}

.chart-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    height: 400px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* å¼·åˆ¶å„è‚¡ç¥¨è‚¡æ¯ä½”æ¯”åœ–è¡¨ç‚ºæ­£åœ“å½¢ */
#stockDividendChart {
    aspect-ratio: 1 / 1;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

#sourceChart,
#stockDividendChart,
#trendChart {
    height: 100% !important;
    width: 100% !important;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* ä¿æŒåˆ†ææ‘˜è¦æ¨£å¼ä¸è®Š */
#analysis-summary {
    background: #f8f9fa;
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid var(--border-color);
    margin-top: 20px;
    font-size: 0.95rem;
}

#analysis-summary .summary-item {
    margin-bottom: 12px;
    line-height: 1.5;
    font-weight: 500;
}

/* ========================
   å“æ‡‰å¼åŠ å¼·
======================== */
@media (max-width: 768px) {
    .analysis-grid {
        grid-template-columns: 1fr;
    }
    .chart-card {
        height: 350px;
    }
    #sourceChart,
    #stockDividendChart,
    #trendChart {
        height: 100% !important;
        width: 100% !important;
    }
}

/* ===== å„è‚¡ç¥¨è‚¡æ¯ä½”æ¯”ï¼šåœ–è¡¨+èªªæ˜ ===== */
.stock-dividend-wrapper {
    display: flex !important;
    flex-direction: row !important;
    align-items: flex-start;
    justify-content: space-between;
    gap: 20px;
    width: 100%;
    height: 100%;
}

.stock-dividend-chart {
    flex: 0 0 50%;
    max-width: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
}

.stock-dividend-chart canvas {
    max-width: 100% !important;
    max-height: 350px !important;
}

.stock-dividend-legend {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 0.9rem;
    overflow-y: auto;
    max-height: 350px;
}

.stock-dividend-legend .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.stock-dividend-legend .color-box {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    flex-shrink: 0;
}

.stock-dividend-legend .label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.stock-dividend-legend .percentage {
    font-weight: 600;
    color: green;
    flex-shrink: 0;
}

.stock-dividend-legend .legend-item {
    cursor: pointer;
    transition: opacity 0.3s;
}

.stock-dividend-legend .legend-item:hover {
    opacity: 0.7;
}

.summary-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 0;
    margin: 0;
}

/* æ¢ç‹€æ‘˜è¦ç¾åŒ–ï¼Œä½èª¿ç°è—è‰² */
.summary-bar {
    display: grid;
    grid-template-columns: 130px auto 1fr;
    gap: 8px;
    align-items: center;
    min-height: 38px;
    padding: 0 18px;
    border-radius: 5px;
    font-size: 1rem;
    font-weight: 500;
    background: linear-gradient(90deg, #f3f6fa 70%, #e9eef3 100%);
    color: #38506b;
    box-shadow: 0 1px 5px rgba(56, 80, 107, 0.04);
    letter-spacing: 0.01em;
    transition: background 0.15s;
    border: 1px solid #e5eaf1;
}

.summary-bar:hover {
    background: linear-gradient(90deg, #e6ebf3 70%, #e0e6ee 100%);
}

.summary-bar .summary-label {
    text-align: right;
    color: #255179;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.summary-bar .summary-colon {
    color: #b0bac9;
    font-weight: 600;
    justify-self: start;
}

.summary-bar .summary-value {
    color: #38506b;
    font-weight: 500;
    font-family: inherit;
    word-break: break-all;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

@media (max-width: 600px) {
    .summary-bar {
        font-size: 0.96rem;
        padding: 0 12px;
        grid-template-columns: 100px auto 1fr;
        gap: 6px;
    }
}

.bond-entry .bond-name {
    min-width: 220px;
    width: 100%;
    max-width: 350px;
}

/* ========================
   æ´¾æ¯æœˆæ›†æ¨£å¼
======================== */
.calendar-controls {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.month-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.month-selector label {
    font-size: 1rem;
    color: var(--text-color);
}

.month-selector select {
    font-size: 1rem;
    padding: 4px 8px;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
}

.dividend-calendar {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: var(--primary-color);
    color: white;
    font-weight: 600;
}

.calendar-header-cell {
    padding: 12px 8px;
    text-align: center;
    border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.calendar-header-cell:last-child {
    border-right: none;
}

.calendar-body {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-day {
    min-height: 120px;
    border-right: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    padding: 8px;
    position: relative;
    background: white;
    transition: background-color 0.2s ease;
}

.calendar-day:nth-child(7n) {
    border-right: none;
}

.calendar-day:hover {
    background: #f8f9fa;
}

.calendar-day.other-month {
    background: #f5f5f5;
    color: #ccc;
}

.calendar-day.other-month .day-number {
    color: #ccc;
}

.calendar-day.today {
    background: rgba(31, 184, 205, 0.1);
    border: 2px solid var(--primary-color);
}

.day-number {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-color);
    font-size: 0.9rem;
}

.day-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-height: 90px;
    overflow: hidden;
}

.event-item {
    background: var(--primary-color);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.75rem;
    line-height: 1.2;
    cursor: pointer;
    transition: all 0.2s ease;
    word-break: break-all;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 4px;
    align-items: center;
}

.event-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.event-item.predicted {
    background: var(--secondary-color);
    color: var(--text-color);
}

.event-item.deposit {
    background: #28a745;
}

.event-item.bond {
    background: #6f42c1;
}

.event-name {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
}

.event-amount {
    font-weight: 600;
    font-size: 0.7rem;
    white-space: nowrap;
}

.more-events {
    background: #6c757d;
    color: white;
    padding: 1px 4px;
    border-radius: 2px;
    font-size: 0.7rem;
    text-align: center;
    cursor: pointer;
    margin-top: 2px;
}

.more-events:hover {
    background: #5a6268;
}

/* äº‹ä»¶è©³æƒ…å½ˆçª— */
.event-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
}

.event-modal-content {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow);
}

.event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.event-modal-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-color);
}

.event-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.event-modal-close:hover {
    background: #f0f0f0;
}

.event-detail {
    margin-bottom: 12px;
    padding: 8px;
    border-radius: 4px;
    border-left: 3px solid var(--primary-color);
    background: #f8f9fa;
}

.event-detail.predicted {
    border-left-color: var(--secondary-color);
}

.event-detail.deposit {
    border-left-color: #28a745;
}

.event-detail.bond {
    border-left-color: #6f42c1;
}

.event-detail-name {
    font-weight: 600;
    margin-bottom: 4px;
    color: var(--text-color);
}

.event-detail-info {
    font-size: 0.9rem;
    color: #666;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.event-detail-amount {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1rem;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .calendar-day {
        min-height: 100px;
        padding: 4px;
    }
    
    .day-events {
        max-height: 75px;
    }
    
    .event-item {
        font-size: 0.7rem;
        padding: 1px 4px;
    }
    
    .calendar-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}

@media (max-width: 480px) {
    .calendar-day {
        min-height: 80px;
        padding: 2px;
    }
    
    .day-number {
        font-size: 0.8rem;
    }
    
    .event-item {
        font-size: 0.65rem;
        padding: 1px 3px;
    }
    
    .event-amount {
        display: none; /* æ‰‹æ©Ÿç‰ˆéš±è—é‡‘é¡ */
    }
}

.hidden-file-input {
    display: none;
}

.rate-input-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.rate-input-group label {
    font-size: 0.9rem;
    color: #666;
}

.rate-input-group input {
    width: 80px;
}
    </style>
</head>
<body>
    <a href="guide.html" style="position: fixed; top: 20px; left: 20px; padding: 10px 20px; border-radius: 8px; background: #1FB8CD; color: white; text-decoration: none; font-size: 14px; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">â† è¿”å›æŒ‡å—</a>
    <div class="container">
        <header class="app-header">
            <h1>æŠ•è³‡æ”¶ç›Šè¿½è¹¤å„€è¡¨æ¿</h1>
            <p>å³æ™‚è¿½è¹¤è‚¡ç¥¨ã€å­˜æ¬¾ã€å‚µåˆ¸æ”¶ç›Š</p>
        </header>

        <div class="data-controls">
            <button class="btn btn--primary" id="export-data-btn">å°å‡ºæ•¸æ“š</button>
            <label class="btn btn--secondary">
                åŒ¯å…¥æ•¸æ“š
                <input type="file" id="import-data-file" accept=".json" class="hidden-file-input">
            </label>
            <button class="btn btn--danger" id="reset-data-btn">é‡è¨­æ•¸æ“š</button>
            <div class="rate-input-group">
                <label for="usd-hkd-rate">ç¾å…ƒå…Œæ¸¯å…ƒåŒ¯ç‡ï¼š</label>
                <input type="number" id="usd-hkd-rate" class="form-control" step="0.01" min="0" value="7.81">
            </div>
            <button class="btn btn--primary" id="sync-github-btn">â˜ï¸ åŒæ­¥åˆ° GitHub</button>
            <button class="btn btn--secondary" id="load-github-btn">ğŸ“¥ å¾ GitHub è¼‰å…¥</button>
        </div>

        <nav class="tabs">
            <button class="tab-btn tab-btn--active" data-tab="overview">æ¦‚è¦½</button>
            <button class="tab-btn" data-tab="monthly">æœˆåº¦ç´°ç¯€</button>
            <button class="tab-btn" data-tab="calendar">æ´¾æ¯æœˆæ›†</button>
            <button class="tab-btn" data-tab="analysis">åˆ†æ</button>
        </nav>

        <div class="tab-panes">
            <!-- æ¦‚è¦½åˆ†é  -->
            <div id="overview-tab" class="tab-pane tab-pane--active">
                <div class="overview-grid">
                    <div class="card">
                        <h3>å¹´åº¦ç¸½æ”¶ç›Š</h3>
                        <div id="total-annual-list"></div>
                    </div>
                    <div class="card">
                        <h3>ç¢ºå®šæ”¶ç›Š</h3>
                        <div id="confirmed-income-list"></div>
                    </div>
                    <div class="card">
                        <h3>é æ¸¬æ”¶ç›Š</h3>
                        <div id="predicted-income-list"></div>
                    </div>
                    <div class="card">
                        <h3>æ”¶ç›Šä¾†æºåˆ†ä½ˆ</h3>
                        <div id="source-percentage-list"></div>
                    </div>
                </div>

                <section class="section">
                    <h2>è‚¡ç¥¨æŒæœ‰</h2>
                    <div id="stocks-container"></div>
                </section>

                <section class="section">
                    <h2>å®šæœŸå­˜æ¬¾</h2>
                    <button class="btn btn--primary" id="add-deposit-btn">æ–°å¢å®šæœŸå­˜æ¬¾</button>
                    <div id="deposits-container"></div>
                </section>

                <section class="section">
                    <h2>å‚µåˆ¸æŒæœ‰</h2>
                    <button class="btn btn--primary" id="add-bond-btn">æ–°å¢å‚µåˆ¸</button>
                    <div id="bonds-container"></div>
                </section>
            </div>

            <!-- æœˆåº¦ç´°ç¯€åˆ†é  -->
            <div id="monthly-tab" class="tab-pane">
                <div class="year-selector">
                    <label for="year-select">å¹´ä»½ï¼š</label>
                    <select id="year-select"></select>
                </div>
                <div style="height: 400px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="monthly-cards" id="monthly-cards-grid"></div>
            </div>

            <!-- æ´¾æ¯æœˆæ›†åˆ†é  -->
            <div id="calendar-tab" class="tab-pane">
                <div class="calendar-controls">
                    <div class="year-selector">
                        <label for="calendar-year-select">å¹´ä»½ï¼š</label>
                        <select id="calendar-year-select"></select>
                    </div>
                    <div class="month-selector">
                        <label for="calendar-month-select">æœˆä»½ï¼š</label>
                        <select id="calendar-month-select">
                            <option value="0">1æœˆ</option>
                            <option value="1">2æœˆ</option>
                            <option value="2">3æœˆ</option>
                            <option value="3">4æœˆ</option>
                            <option value="4">5æœˆ</option>
                            <option value="5">6æœˆ</option>
                            <option value="6">7æœˆ</option>
                            <option value="7">8æœˆ</option>
                            <option value="8">9æœˆ</option>
                            <option value="9">10æœˆ</option>
                            <option value="10">11æœˆ</option>
                            <option value="11">12æœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="dividend-calendar" id="dividend-calendar"></div>
            </div>

            <!-- åˆ†æåˆ†é  -->
            <div id="analysis-tab" class="tab-pane">
                <div class="year-selector">
                    <label for="analysis-year-select">å¹´ä»½ï¼š</label>
                    <select id="analysis-year-select"></select>
                </div>
                <div class="analysis-grid">
                    <div class="chart-card">
                        <canvas id="sourceChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="stock-dividend-wrapper">
                            <div class="stock-dividend-chart">
                                <canvas id="stockDividendChart"></canvas>
                            </div>
                            <div class="stock-dividend-legend" id="stockDividendLegend"></div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div id="analysis-summary"></div>
            </div>
        </div>
    </div>

    <script>
// Application Data
const defaultStocks = [
    {"name": "2800ç›ˆå¯Œ", "code": "2800"},
    {"name": "3466æ’ç”Ÿé«˜æ¯è‚¡30æŒ‡æ•¸ETF", "code": "3466"},
    {"name": "2388 ä¸­éŠ€é¦™æ¸¯", "code": "2388"},
    {"name": "3116 Global Xäºå¤ªé«˜è‚¡æ¯ç‡ETF", "code": "3116"},
    {"name": "3070å¹³å®‰é¦™æ¸¯é«˜æ¯è‚¡ ETF", "code": "3070"},
    {"name": "3416 Global X åœ‹æŒ‡å‚™å…Œèªè³¼æœŸæ¬Šä¸»å‹•å‹ETF", "code": "3416"},
    {"name": "3419 Global X æ†æŒ‡å‚™å…Œèªè³¼æœŸæ¬Šä¸»å‹•å‹ETF", "code": "3419"},
    {"name": "3417 Global X æ†ç§‘å‚™å…Œèªè³¼æœŸæ¬Šä¸»å‹•å‹ETF", "code": "3417"},
    {"name": "3437 åšæ™‚å¤®ä¼ç´…åˆ©ETF", "code": "3437"}
];

const usdHkdRate = 7.81;
const chartColors = ["#1FB8CD", "#FFC185", "#B4413C", "#ECEBD5", "#5D878F", "#DB4545", "#D2BA4C", "#964325", "#944454", "#13343B"];
const monthNames = ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"];

// Application State
let appData = {
    stocks: {},
    deposits: [],
    bonds: [],
    usdHkdRate: 7.81
};

let charts = {};

// ===== å¹´åº¦é¸æ“‡ =====
let selectedYear = new Date().getFullYear();
let selectedAnalysisYear = new Date().getFullYear();
let selectedCalendarYear = new Date().getFullYear();
let selectedCalendarMonth = new Date().getMonth();

function getAvailableYears() {
    const years = new Set();
    // è‚¡ç¥¨
    Object.values(appData.stocks).forEach(stock => {
        (stock.dividends || []).forEach(d => {
            if (d.date) years.add(new Date(d.date).getFullYear());
        });
    });
    // å­˜æ¬¾
    appData.deposits.forEach(d => {
        if (d.maturityDate) years.add(new Date(d.maturityDate).getFullYear());
    });
    // å‚µåˆ¸ - åŒ…å«æ´¾æ¯è¨˜éŒ„çš„æ—¥æœŸ
    appData.bonds.forEach(b => {
        if (b.maturityDate) years.add(new Date(b.maturityDate).getFullYear());
        // æ–°å¢ï¼šå‚µåˆ¸æ´¾æ¯è¨˜éŒ„
        (b.payments || []).forEach(p => {
            if (p.date) years.add(new Date(p.date).getFullYear());
        });
    });
    // ç•¶å‰å¹´ä¹ŸåŠ é€²å»
    years.add(new Date().getFullYear());
    return Array.from(years).sort((a, b) => a - b);
}

function renderYearSelector() {
    const years = getAvailableYears();
    const selector = document.getElementById('year-select');
    if (!selector) return;
    selector.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    if (!years.includes(selectedYear)) selectedYear = years[years.length-1];
    selector.value = selectedYear;
    selector.onchange = function() {
        selectedYear = parseInt(selector.value, 10);
        updateCalculations();
    }
}

function renderAnalysisYearSelector() {
    const years = getAvailableYears();
    const selector = document.getElementById('analysis-year-select');
    if (!selector) return;
    selector.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    if (!years.includes(selectedAnalysisYear)) selectedAnalysisYear = years[years.length-1];
    selector.value = selectedAnalysisYear;
    selector.onchange = function() {
        selectedAnalysisYear = parseInt(selector.value, 10);
        updateCalculations();
    }
}

function renderCalendarYearSelector() {
    const years = getAvailableYears();
    const selector = document.getElementById('calendar-year-select');
    if (!selector) return;
    selector.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
    if (!years.includes(selectedCalendarYear)) selectedCalendarYear = years[years.length-1];
    selector.value = selectedCalendarYear;
    selector.onchange = function() {
        selectedCalendarYear = parseInt(selector.value, 10);
        updateCalendar();
    }
}

function renderCalendarMonthSelector() {
    const selector = document.getElementById('calendar-month-select');
    if (!selector) return;
    selector.value = selectedCalendarMonth;
    selector.onchange = function() {
        selectedCalendarMonth = parseInt(selector.value, 10);
        updateCalendar();
    }
}

// Utility Functions
function formatCurrency(amount, currency = 'HKD') {
    const prefix = currency === 'USD' ? 'US$' : 'HK$';
    return prefix + (amount || 0).toLocaleString('zh-HK', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatCurrencyShort(amount) {
    if (amount >= 10000) {
        return 'HK$' + (amount / 10000).toFixed(1) + 'è¬';
    } else if (amount >= 1000) {
        return 'HK$' + (amount / 1000).toFixed(1) + 'K';
    } else {
        return 'HK$' + amount.toFixed(0);
    }
}

function convertUsdToHkd(usdAmount) {
    return usdAmount * appData.usdHkdRate;
}

function saveData() {
    try {
        localStorage.setItem('investmentTrackerData', JSON.stringify(appData));
    } catch (e) {
        console.warn('ç„¡æ³•ä¿å­˜æ•¸æ“šåˆ°æœ¬åœ°å­˜å„²');
    }
}

function loadData() {
    try {
        const savedData = localStorage.getItem('investmentTrackerData');
        if (savedData) {
            const parsed = JSON.parse(savedData);
            // å‘å¾Œå…¼å®¹ï¼šå°‡èˆŠçš„dividendè£œ shares æ¬„
            Object.values(parsed.stocks || {}).forEach(stock => {
                (stock.dividends || []).forEach(dividend => {
                    if (dividend.shares === undefined) dividend.shares = stock.shares || 0;
                });
                // å‘å¾Œå…¼å®¹ï¼šè£œå…… currency æ¬„ä½
                if (!stock.currency) stock.currency = 'HKD';
            });
            // å‘å¾Œå…¼å®¹ï¼šç¢ºä¿å‚µåˆ¸æœ‰ payments é™£åˆ—
            (parsed.bonds || []).forEach(bond => {
                if (!bond.payments) bond.payments = [];
            });
            appData = {
                stocks: parsed.stocks || {},
                deposits: parsed.deposits || [],
                bonds: parsed.bonds || [],
                usdHkdRate: parsed.usdHkdRate || 7.81
            };
        }
    } catch (e) {
        console.warn('ç„¡æ³•å¾æœ¬åœ°å­˜å„²è¼‰å…¥æ•¸æ“š');
    }
    if (Object.keys(appData.stocks).length === 0) {
        defaultStocks.forEach(stock => {
            appData.stocks[stock.code] = {
                name: stock.name,
                code: stock.code,
                shares: 0,
                dividends: [],
                currency: 'HKD' // é è¨­ç‚ºæ¸¯å…ƒ
            };
        });
    }
}

function exportData() {
    const dataStr = JSON.stringify(appData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `investment-tracker-data-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

function importData(event) {
    const fileReader = new FileReader();
    fileReader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            // å‘å¾Œå…¼å®¹ï¼šè£œ shares
            Object.values(importedData.stocks || {}).forEach(stock => {
                (stock.dividends || []).forEach(dividend => {
                    if (dividend.shares === undefined) dividend.shares = stock.shares || 0;
                });
                // å‘å¾Œå…¼å®¹ï¼šè£œå…… currency æ¬„ä½
                if (!stock.currency) stock.currency = 'HKD';
            });
            // å‘å¾Œå…¼å®¹ï¼šç¢ºä¿å‚µåˆ¸æœ‰ payments é™£åˆ—
            (importedData.bonds || []).forEach(bond => {
                if (!bond.payments) bond.payments = [];
            });
            if (confirm('ç¢ºå®šè¦åŒ¯å…¥æ•¸æ“šå—ï¼Ÿé€™å°‡è¦†è“‹ç•¶å‰æ‰€æœ‰æ•¸æ“šã€‚')) {
                appData = importedData;
                renderStocks();
                renderDeposits();
                renderBonds();
                updateCalculations();
                saveData();
                alert('æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼');
            }
        } catch (err) {
            alert('æ•¸æ“šæ ¼å¼éŒ¯èª¤æˆ–ç„¡æ•ˆï¼š' + err.message);
        }
    };
    fileReader.readAsText(event.target.files[0]);
}

function resetData() {
    if (confirm('ç¢ºå®šè¦é‡è¨­æ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) {
        appData = {
            stocks: {},
            deposits: [],
            bonds: [],
            usdHkdRate: 7.81
        };
        defaultStocks.forEach(stock => {
            appData.stocks[stock.code] = {
                name: stock.name,
                code: stock.code,
                shares: 0,
                dividends: [],
                currency: 'HKD'
            };
        });
        renderStocks();
        renderDeposits();
        renderBonds();
        updateCalculations();
        saveData();
        alert('æ•¸æ“šå·²é‡è¨­ç‚ºé è¨­ç‹€æ…‹');
    }
}

// Tab Management
function initTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const targetTab = button.dataset.tab;
            tabButtons.forEach(btn => btn.classList.remove('tab-btn--active'));
            button.classList.add('tab-btn--active');
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('tab-pane--active'));
            const targetPane = document.getElementById(`${targetTab}-tab`);
            if (targetPane) {
                targetPane.classList.add('tab-pane--active');
                setTimeout(() => {
                    if (targetTab === 'overview') {
                        updateOverview();
                    } else if (targetTab === 'monthly') {
                        updateMonthlyDetails();
                    } else if (targetTab === 'calendar') {
                        updateCalendar();
                    } else if (targetTab === 'analysis') {
                        updateAnalysis();
                    }
                }, 50);
            }
        });
    });
}

// Calendar Functions
function updateCalendar() {
    renderCalendarYearSelector();
    renderCalendarMonthSelector();
    renderDividendCalendar();
}

function getCalendarEvents(year, month) {
    const events = [];
    
    // è‚¡ç¥¨æ´¾æ¯
    Object.values(appData.stocks).forEach(stock => {
        if (stock.dividends) {
            stock.dividends.forEach(dividend => {
                if (dividend.amount > 0 && dividend.date) {
                    const date = new Date(dividend.date);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const shares = dividend.shares !== undefined ? dividend.shares : stock.shares || 0;
                        let totalAmount = shares * dividend.amount;
                        
                        if (stock.currency === 'USD') {
                            totalAmount = convertUsdToHkd(totalAmount);
                        }
                        
                        events.push({
                            date: date.getDate(),
                            name: stock.name,
                            type: dividend.type,
                            amount: totalAmount,
                            currency: 'HKD',
                            period: dividend.period,
                            category: 'stock'
                        });
                    }
                }
            });
        }
    });
    
    // å®šæœŸå­˜æ¬¾
    appData.deposits.forEach(deposit => {
        if (deposit.interest > 0 && deposit.maturityDate) {
            const date = new Date(deposit.maturityDate);
            if (date.getFullYear() === year && date.getMonth() === month) {
                const amount = deposit.currency === 'USD' ? convertUsdToHkd(deposit.interest) : deposit.interest;
                events.push({
                    date: date.getDate(),
                    name: 'å®šæœŸå­˜æ¬¾',
                    type: 'deposit',
                    amount: amount,
                    currency: 'HKD',
                    period: 'åˆ°æœŸ',
                    category: 'deposit'
                });
            }
        }
    });
    
    // å‚µåˆ¸æ´¾æ¯
    appData.bonds.forEach(bond => {
        if (bond.payments) {
            bond.payments.forEach(payment => {
                if (payment.amount > 0 && payment.date) {
                    const date = new Date(payment.date);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const amount = bond.currency === 'USD' ? convertUsdToHkd(payment.amount) : payment.amount;
                        events.push({
                            date: date.getDate(),
                            name: bond.name || 'å‚µåˆ¸',
                            type: payment.type,
                            amount: amount,
                            currency: 'HKD',
                            period: payment.period,
                            category: 'bond'
                        });
                    }
                }
            });
        }
    });
    
    return events;
}

function renderDividendCalendar() {
    const container = document.getElementById('dividend-calendar');
    if (!container) return;
    
    const year = selectedCalendarYear;
    const month = selectedCalendarMonth;
    const events = getCalendarEvents(year, month);
    
    // ç²å–æœˆä»½ä¿¡æ¯
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay();
    
    // ç²å–å‰ä¸€å€‹æœˆå’Œå¾Œä¸€å€‹æœˆçš„ä¿¡æ¯
    const prevMonth = new Date(year, month - 1, 0);
    const nextMonth = new Date(year, month + 1, 1);
    
    container.innerHTML = `
        <div class="calendar-header">
            <div class="calendar-header-cell">é€±æ—¥</div>
            <div class="calendar-header-cell">é€±ä¸€</div>
            <div class="calendar-header-cell">é€±äºŒ</div>
            <div class="calendar-header-cell">é€±ä¸‰</div>
            <div class="calendar-header-cell">é€±å››</div>
            <div class="calendar-header-cell">é€±äº”</div>
            <div class="calendar-header-cell">é€±å…­</div>
        </div>
        <div class="calendar-body" id="calendar-body"></div>
    `;
    
    const calendarBody = document.getElementById('calendar-body');
    let dayCount = 1;
    const today = new Date();
    
    // è¨ˆç®—ç¸½å…±éœ€è¦å¤šå°‘å€‹æ ¼å­
    const totalCells = Math.ceil((daysInMonth + startDayOfWeek) / 7) * 7;
    
    for (let i = 0; i < totalCells; i++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        let dayNumber, isCurrentMonth, currentDate;
        
        if (i < startDayOfWeek) {
            // å‰ä¸€å€‹æœˆçš„æ—¥æœŸ
            dayNumber = prevMonth.getDate() - (startDayOfWeek - 1 - i);
            isCurrentMonth = false;
            dayDiv.classList.add('other-month');
            currentDate = new Date(year, month - 1, dayNumber);
        } else if (dayCount <= daysInMonth) {
            // ç•¶å‰æœˆçš„æ—¥æœŸ
            dayNumber = dayCount;
            isCurrentMonth = true;
            currentDate = new Date(year, month, dayNumber);
            dayCount++;
        } else {
            // ä¸‹ä¸€å€‹æœˆçš„æ—¥æœŸ
            dayNumber = dayCount - daysInMonth;
            isCurrentMonth = false;
            dayDiv.classList.add('other-month');
            currentDate = new Date(year, month + 1, dayNumber);
            dayCount++;
        }
        
        // æª¢æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
        if (currentDate.toDateString() === today.toDateString()) {
            dayDiv.classList.add('today');
        }
        
        // ç²å–é€™ä¸€å¤©çš„äº‹ä»¶
        const dayEvents = isCurrentMonth ? events.filter(event => event.date === dayNumber) : [];
        
        dayDiv.innerHTML = `
            <div class="day-number">${dayNumber}</div>
            <div class="day-events" id="events-${i}"></div>
        `;
        
        // æ·»åŠ äº‹ä»¶
        const eventsContainer = dayDiv.querySelector('.day-events');
        const maxVisibleEvents = 3;
        
        dayEvents.slice(0, maxVisibleEvents).forEach(event => {
            const eventDiv = document.createElement('div');
            eventDiv.className = `event-item ${event.type} ${event.category}`;
            eventDiv.innerHTML = `
                <span class="event-name">${event.name}</span>
                <span class="event-amount">${formatCurrencyShort(event.amount)}</span>
            `;
            eventDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showEventModal(dayEvents, dayNumber, monthNames[month]);
            });
            eventsContainer.appendChild(eventDiv);
        });
        
        // å¦‚æœæœ‰æ›´å¤šäº‹ä»¶ï¼Œé¡¯ç¤º"æ›´å¤š"
        if (dayEvents.length > maxVisibleEvents) {
            const moreDiv = document.createElement('div');
            moreDiv.className = 'more-events';
            moreDiv.textContent = `+${dayEvents.length - maxVisibleEvents} æ›´å¤š`;
            moreDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showEventModal(dayEvents, dayNumber, monthNames[month]);
            });
            eventsContainer.appendChild(moreDiv);
        }
        
        calendarBody.appendChild(dayDiv);
    }
}

function showEventModal(events, day, monthName) {
    const modal = document.createElement('div');
    modal.className = 'event-modal';
    modal.innerHTML = `
        <div class="event-modal-content">
            <div class="event-modal-header">
                <div class="event-modal-title">${monthName} ${day}æ—¥ æ”¶å…¥è©³æƒ…</div>
                <button class="event-modal-close">&times;</button>
            </div>
            <div class="event-modal-body">
                ${events.map(event => `
                    <div class="event-detail ${event.type} ${event.category}">
                        <div class="event-detail-name">${event.name}</div>
                        <div class="event-detail-info">
                            <span>é¡å‹ï¼š${getTypeLabel(event.type)}</span>
                            ${event.period ? `<span>æœŸé–“ï¼š${event.period}</span>` : ''}
                            <span class="event-detail-amount">${formatCurrency(event.amount, 'HKD')}</span>
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 16px; padding: 8px; background: #f0f0f0; border-radius: 4px; text-align: center;">
                    <strong>ç•¶æ—¥ç¸½æ”¶å…¥ï¼š${formatCurrency(events.reduce((sum, e) => sum + e.amount, 0), 'HKD')}</strong>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    const closeBtn = modal.querySelector('.event-modal-close');
    closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

// è¡¨æ ¼æ‘ºç–Š/å±•é–‹åŠŸèƒ½
function toggleTableExpansion(stockCode, isStock = true) {
    const prefix = isStock ? 'stock' : 'bond';
    const wrapper = document.getElementById(`table-wrapper-${stockCode}`);
    const expandBtn = document.getElementById(`expand-btn-${stockCode}`);
    
    if (!wrapper || !expandBtn) return;
    
    if (wrapper.classList.contains('expanded')) {
        wrapper.classList.remove('expanded');
    } else {
        wrapper.classList.add('expanded');
    }
}

function checkTableCollapse(stockCode, isStock = true) {
    const tbody = isStock ? 
        document.getElementById(`dividends-${stockCode}`) : 
        document.getElementById(`bond-payments-${stockCode}`);
    const wrapper = document.getElementById(`table-wrapper-${stockCode}`);
    const expandBtn = document.getElementById(`expand-btn-${stockCode}`);
    const recordCount = wrapper ? wrapper.querySelector('.record-count') : null;
    
    if (!tbody || !wrapper || !expandBtn || !recordCount) return;
    
    const rowCount = tbody.children.length;
    recordCount.textContent = rowCount;
    
    // ä¿®æ­£é‚è¼¯ï¼šå¦‚æœè¨˜éŒ„è¶…é4é …ï¼Œé¡¯ç¤ºæ‘ºç–ŠæŒ‰éˆ•ï¼Œä¸¦ä¸”é è¨­ç‚ºæ‘ºç–Šç‹€æ…‹
    if (rowCount > 4) {
        expandBtn.style.display = 'block';
        // ç¢ºä¿æ–°å¢è¨˜éŒ„å¾Œä¿æŒå±•é–‹ç‹€æ…‹ï¼ˆå¦‚æœä¹‹å‰å·²å±•é–‹ï¼‰
        // å¦å‰‡é è¨­ç‚ºæ‘ºç–Šç‹€æ…‹
        if (!wrapper.classList.contains('expanded')) {
            wrapper.classList.remove('expanded');
        }
    } else {
        expandBtn.style.display = 'none';
        wrapper.classList.remove('expanded');
    }
}

// Stock Management
function renderStocks() {
    const container = document.getElementById('stocks-container');
    if (!container) return;
    container.innerHTML = '';
    
    const addStockBtn = document.createElement('button');
    addStockBtn.className = 'btn btn--primary btn--full-width';
    addStockBtn.textContent = 'æ·»åŠ æ–°è‚¡ç¥¨';
    addStockBtn.style.marginBottom = '16px';
    addStockBtn.addEventListener('click', () => {
        showAddStockModal();
    });
    container.appendChild(addStockBtn);

    // ä¿®æ”¹ï¼šé¡¯ç¤ºæ‰€æœ‰åœ¨ appData.stocks ä¸­çš„è‚¡ç¥¨
    Object.values(appData.stocks).forEach(stockData => {
        const stockElement = createStockElement(stockData);
        container.appendChild(stockElement);
    });
}

function showAddStockModal() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal">
            <div class="modal-header">
                <h3>æ·»åŠ æ–°è‚¡ç¥¨</h3>
                <button class="btn btn--outline btn--sm modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-stock-name">è‚¡ç¥¨åç¨±</label>
                    <input type="text" id="new-stock-name" class="form-control" placeholder="ä¾‹å¦‚ï¼šé¨°è¨Šæ§è‚¡" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label for="new-stock-code">è‚¡ç¥¨ä»£ç¢¼</label>
                    <input type="text" id="new-stock-code" class="form-control" placeholder="ä¾‹å¦‚ï¼š0700" style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn--secondary" id="cancel-add-stock">å–æ¶ˆ</button>
                <button class="btn btn--primary" id="confirm-add-stock">ç¢ºå®šæ·»åŠ </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const closeBtn = modal.querySelector('.modal-close');
    const cancelBtn = modal.querySelector('#cancel-add-stock');
    const confirmBtn = modal.querySelector('#confirm-add-stock');
    const nameInput = modal.querySelector('#new-stock-name');
    const codeInput = modal.querySelector('#new-stock-code');

    closeBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });

    cancelBtn.addEventListener('click', () => {
        document.body.removeChild(modal);
    });

    confirmBtn.addEventListener('click', () => {
        const name = nameInput.value.trim();
        const code = codeInput.value.trim();
        if (!name) {
            alert('è«‹è¼¸å…¥è‚¡ç¥¨åç¨±');
            return;
        }
        if (!code) {
            alert('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼');
            return;
        }
        if (appData.stocks[code]) {
            alert('è©²è‚¡ç¥¨ä»£ç¢¼å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ä»£ç¢¼');
            return;
        }
        appData.stocks[code] = {
            name: name,
            code: code,
            shares: 0,
            dividends: [],
            currency: 'HKD'
        };
        saveData();
        renderStocks();
        document.body.removeChild(modal);
        alert('è‚¡ç¥¨æ·»åŠ æˆåŠŸï¼');
    });
}

function createStockElement(stockData) {
    const div = document.createElement('div');
    div.className = 'stock-entry';
    div.innerHTML = `
        <div class="stock-header">
            <div class="stock-info">
                <h3>${stockData.name}</h3>
                <div class="stock-code">${stockData.code}</div>
            </div>
            <div class="stock-actions">
                <label for="currency-${stockData.code}">è²¨å¹£ï¼š</label>
                <select id="currency-${stockData.code}" class="form-control stock-currency" style="width: 80px;">
                    <option value="HKD" ${(stockData.currency || 'HKD') === 'HKD' ? 'selected' : ''}>æ¸¯å…ƒ</option>
                    <option value="USD" ${(stockData.currency || 'HKD') === 'USD' ? 'selected' : ''}>ç¾å…ƒ</option>
                </select>
                <label for="shares-${stockData.code}">è‚¡æ•¸ï¼š</label>
                <input type="number" id="shares-${stockData.code}" class="form-control" 
                       value="${stockData.shares || 0}" min="0" step="1" placeholder="0">
                <button type="button" class="btn btn--danger btn--sm remove-stock-btn" 
                        data-stock="${stockData.code}">
                    åˆªé™¤è‚¡ç¥¨
                </button>
            </div>
        </div>
        <div class="dividend-section">
            <div class="table-wrapper" id="table-wrapper-${stockData.code}">
                <div class="table-collapsed" id="table-content-${stockData.code}">
                    <table class="dividend-table">
                        <thead>
                            <tr>
                                <th>æœŸé–“åç¨±</th>
                                <th>é¡å‹</th>
                                <th>æ¯è‚¡æ´¾æ¯</th>
                                <th>æ´¾é€æ—¥æœŸ</th>
                                <th>æŒè‚¡æ•¸</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="dividends-${stockData.code}">
                        </tbody>
                    </table>
                </div>
                <button type="button" class="table-expand-btn" id="expand-btn-${stockData.code}" style="display: none;">
                    <span class="expand-text">é¡¯ç¤ºæ›´å¤šè¨˜éŒ„ (å…± <span class="record-count">0</span> é …)</span>
                    <span class="collapse-text">æ”¶èµ·è¨˜éŒ„</span>
                </button>
            </div>
            <button type="button" class="btn btn--secondary btn--sm add-dividend-btn" 
                    data-stock="${stockData.code}">
                æ·»åŠ æ´¾æ¯è¨˜éŒ„
            </button>
        </div>
    `;
    
    // è²¨å¹£é¸æ“‡äº‹ä»¶ç›£è½
    const currencySelect = div.querySelector(`#currency-${stockData.code}`);
    if (currencySelect) {
        currencySelect.addEventListener('change', (e) => {
            const currency = e.target.value;
            appData.stocks[stockData.code].currency = currency;
            saveData();
            updateCalculations();
        });
    }
    
    const sharesInput = div.querySelector(`#shares-${stockData.code}`);
    if (sharesInput) {
        sharesInput.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value) || 0;
            appData.stocks[stockData.code].shares = value;
            // æ–°å¢ï¼šåŒæ­¥æ‰€æœ‰æœªæœ‰ shares çš„ dividend
            (appData.stocks[stockData.code].dividends || []).forEach(div => {
                if (!div.shares || div.shares === 0) div.shares = value;
            });
            saveData();
            updateCalculations();
        });
        sharesInput.addEventListener('change', (e) => {
            const value = parseFloat(e.target.value) || 0;
            appData.stocks[stockData.code].shares = value;
            (appData.stocks[stockData.code].dividends || []).forEach(div => {
                if (!div.shares || div.shares === 0) div.shares = value;
            });
            saveData();
            updateCalculations();
        });
    }
    const addBtn = div.querySelector('.add-dividend-btn');
    if (addBtn) {
        addBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addDividendRow(stockData.code);
        });
    }
    const removeBtn = div.querySelector('.remove-stock-btn');
    if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeStock(stockData.code);
        });
    }
    
    // æ·»åŠ æ‘ºç–ŠæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    const expandBtn = div.querySelector(`#expand-btn-${stockData.code}`);
    if (expandBtn) {
        expandBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleTableExpansion(stockData.code, true);
        });
    }
    
    setTimeout(() => renderDividends(stockData.code), 10);
    return div;
}

function renderDividends(stockCode) {
    const tbody = document.getElementById(`dividends-${stockCode}`);
    if (!tbody) return;
    const stockData = appData.stocks[stockCode];
    if (!stockData || !stockData.dividends) return;
    tbody.innerHTML = '';
    stockData.dividends.forEach((dividend, index) => {
        const row = createDividendRow(stockCode, dividend, index);
        tbody.appendChild(row);
    });
    // æª¢æŸ¥æ˜¯å¦éœ€è¦æ‘ºç–Š
    checkTableCollapse(stockCode, true);
}

function createDividendRow(stockCode, dividend = {}, index = -1) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>
            <input type="text" class="form-control dividend-period" value="${dividend.period || ''}" 
                   placeholder="ä¾‹ï¼š2024Q1">
        </td>
        <td>
            <select class="form-control dividend-type">
                <option value="confirmed" ${dividend.type === 'confirmed' ? 'selected' : ''}>ç¢ºå®š</option>
                <option value="predicted" ${dividend.type === 'predicted' ? 'selected' : ''}>é æ¸¬</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control dividend-amount" value="${dividend.amount || ''}" 
                   step="0.01" min="0" placeholder="0.00">
        </td>
        <td>
            <input type="date" class="form-control dividend-date" value="${dividend.date || ''}" style="width: 100%;">
        </td>
        <td>
            <input type="number" class="form-control dividend-shares" value="${dividend.shares !== undefined ? dividend.shares : (appData.stocks[stockCode]?.shares || '')}" min="0" step="1" placeholder="0">
        </td>
        <td>
            <button type="button" class="btn btn--outline btn--sm remove-dividend-btn">
                åˆªé™¤
            </button>
        </td>
    `;
    const periodInput = tr.querySelector('.dividend-period');
    const typeSelect = tr.querySelector('.dividend-type');
    const amountInput = tr.querySelector('.dividend-amount');
    const dateInput = tr.querySelector('.dividend-date');
    const sharesInput = tr.querySelector('.dividend-shares');
    const removeBtn = tr.querySelector('.remove-dividend-btn');
    [periodInput, typeSelect, amountInput, dateInput, sharesInput].forEach(input => {
        if (input) {
            input.addEventListener('change', () => {
                updateDividend(stockCode, index, input);
            });
        }
    });
    if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeDividend(stockCode, index);
        });
    }
    return tr;
}

function addDividendRow(stockCode) {
    if (!appData.stocks[stockCode]) return;
    if (!appData.stocks[stockCode].dividends) {
        appData.stocks[stockCode].dividends = [];
    }
    // é è¨­ shares ç‚ºä¸»æª” shares
    appData.stocks[stockCode].dividends.push({
        period: '',
        type: 'confirmed',
        amount: 0,
        date: '',
        shares: appData.stocks[stockCode].shares || 0
    });
    
    // å¦‚æœæ–°å¢å¾Œè¨˜éŒ„æ•¸é‡è¶…é4é …ï¼Œè‡ªå‹•å±•é–‹è¡¨æ ¼
    const newCount = appData.stocks[stockCode].dividends.length;
    if (newCount > 4) {
        setTimeout(() => {
            const wrapper = document.getElementById(`table-wrapper-${stockCode}`);
            if (wrapper) {
                wrapper.classList.add('expanded');
            }
        }, 50);
    }
    
    renderDividends(stockCode);
    saveData();
}

function addBondPaymentRow(bondIndex) {
    if (!appData.bonds[bondIndex]) return;
    if (!appData.bonds[bondIndex].payments) {
        appData.bonds[bondIndex].payments = [];
    }
    appData.bonds[bondIndex].payments.push({
        period: '',
        type: 'confirmed',
        amount: 0,
        date: ''
    });
    
    // å¦‚æœæ–°å¢å¾Œè¨˜éŒ„æ•¸é‡è¶…é4é …ï¼Œè‡ªå‹•å±•é–‹è¡¨æ ¼
    const newCount = appData.bonds[bondIndex].payments.length;
    if (newCount > 4) {
        setTimeout(() => {
            const wrapper = document.getElementById(`table-wrapper-${bondIndex}`);
            if (wrapper) {
                wrapper.classList.add('expanded');
            }
        }, 50);
    }
    
    renderBondPayments(bondIndex);
    updateBondYieldDisplay(bondIndex);
    saveData();
}

function updateDividend(stockCode, index, inputElement) {
    if (index === -1 || !appData.stocks[stockCode] || !appData.stocks[stockCode].dividends[index]) return;
    const dividend = appData.stocks[stockCode].dividends[index];
    if (inputElement.classList.contains('dividend-period')) {
        dividend.period = inputElement.value;
    } else if (inputElement.classList.contains('dividend-type')) {
        dividend.type = inputElement.value;
    } else if (inputElement.classList.contains('dividend-amount')) {
        dividend.amount = parseFloat(inputElement.value) || 0;
    } else if (inputElement.classList.contains('dividend-date')) {
        dividend.date = inputElement.value;
    } else if (inputElement.classList.contains('dividend-shares')) {
        dividend.shares = parseInt(inputElement.value, 10) || 0;
    }
    saveData();
    updateCalculations();
}

function removeDividend(stockCode, index) {
    if (!appData.stocks[stockCode] || !appData.stocks[stockCode].dividends) return;
    appData.stocks[stockCode].dividends.splice(index, 1);
    renderDividends(stockCode);
    saveData();
    updateCalculations();
}

function removeStock(stockCode) {
    if (confirm(`ç¢ºå®šè¦åˆªé™¤è‚¡ç¥¨ ${appData.stocks[stockCode].name} å—ï¼Ÿ`)) {
        delete appData.stocks[stockCode];
        renderStocks();
        saveData();
        updateCalculations();
    }
}

// Deposit Management
function renderDeposits() {
    const container = document.getElementById('deposits-container');
    if (!container) return;
    container.innerHTML = '';
    if (appData.deposits.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>æš«ç„¡å®šæœŸå­˜æ¬¾è¨˜éŒ„ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ·»åŠ </p></div>';
        return;
    }
    appData.deposits.forEach((deposit, index) => {
        const depositElement = createDepositElement(deposit, index);
        container.appendChild(depositElement);
    });
}

function createDepositElement(deposit, index) {
    const div = document.createElement('div');
    div.className = 'deposit-entry';
    div.innerHTML = `
        <div class="entry-form">
            <div class="form-group">
                <label>è²¨å¹£</label>
                <select class="form-control deposit-currency">
                    <option value="HKD" ${deposit.currency === 'HKD' ? 'selected' : ''}>æ¸¯å…ƒ (HKD)</option>
                    <option value="USD" ${deposit.currency === 'USD' ? 'selected' : ''}>ç¾å…ƒ (USD)</option>
                </select>
            </div>
            <div class="form-group">
                <label>æœ¬é‡‘é‡‘é¡</label>
                <input type="number" class="form-control deposit-principal" value="${deposit.principal || ''}" 
                       step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="form-group">
                <label>åˆ°æœŸæ—¥</label>
                <input type="date" class="form-control deposit-maturity" value="${deposit.maturityDate || ''}" style="width: 100%;">
            </div>
            <div class="form-group">
                <label>åˆ©æ¯é‡‘é¡</label>
                <input type="number" class="form-control deposit-interest" value="${deposit.interest || ''}" 
                       step="0.01" min="0" placeholder="0.00">
            </div>
        </div>
        <div class="entry-actions">
            <button type="button" class="btn btn--outline btn--sm remove-deposit-btn">åˆªé™¤</button>
        </div>
    `;
    const currencySelect = div.querySelector('.deposit-currency');
    const principalInput = div.querySelector('.deposit-principal');
    const maturityInput = div.querySelector('.deposit-maturity');
    const interestInput = div.querySelector('.deposit-interest');
    const removeBtn = div.querySelector('.remove-deposit-btn');
    [currencySelect, principalInput, maturityInput, interestInput].forEach(input => {
        if (input) {
            input.addEventListener('change', () => {
                updateDeposit(index, input);
            });
        }
    });
    if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeDeposit(index);
        });
    }
    return div;
}

function addDeposit() {
    appData.deposits.push({
        currency: 'HKD',
        principal: 0,
        maturityDate: '',
        interest: 0
    });
    renderDeposits();
    saveData();
}

function updateDeposit(index, inputElement) {
    if (!appData.deposits[index]) return;
    const deposit = appData.deposits[index];
    if (inputElement.classList.contains('deposit-currency')) {
        deposit.currency = inputElement.value;
    } else if (inputElement.classList.contains('deposit-principal')) {
        deposit.principal = parseFloat(inputElement.value) || 0;
    } else if (inputElement.classList.contains('deposit-maturity')) {
        deposit.maturityDate = inputElement.value;
    } else if (inputElement.classList.contains('deposit-interest')) {
        deposit.interest = parseFloat(inputElement.value) || 0;
    }
    saveData();
    updateCalculations();
}

function removeDeposit(index) {
    appData.deposits.splice(index, 1);
    renderDeposits();
    saveData();
    updateCalculations();
}

// Bond Management - é‡æ–°æ”¹å¯«ä»¥æ”¯æ´æ´¾æ¯è¨˜éŒ„å’Œè‡ªå‹•è¨ˆç®—ç¸½æ”¶ç›Š
function renderBonds() {
    const container = document.getElementById('bonds-container');
    if (!container) return;
    container.innerHTML = '';
    if (appData.bonds.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>æš«ç„¡å‚µåˆ¸è¨˜éŒ„ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ·»åŠ </p></div>';
        return;
    }
    appData.bonds.forEach((bond, index) => {
        const bondElement = createBondElement(bond, index);
        container.appendChild(bondElement);
    });
}

function createBondElement(bond, index) {
    const div = document.createElement('div');
    div.className = 'bond-entry';
    
    // è®¡ç®—æ´¾æ¯è®°å½•æ€»å’Œ
    const totalPayments = (bond.payments || []).reduce((sum, payment) => {
        return sum + (parseFloat(payment.amount) || 0);
    }, 0);
    
    div.innerHTML = `
        <div class="bond-header">
            <div class="bond-info">
                <h3 class="bond-title">${bond.name || 'å‚µåˆ¸'}</h3>
                <div class="bond-code">ç·¨è™Ÿ: ${index + 1}</div>
            </div>
            <div class="bond-actions">
                <button type="button" class="btn btn--danger btn--sm remove-bond-btn" 
                        data-bond="${index}">
                    åˆªé™¤å‚µåˆ¸
                </button>
            </div>
        </div>
        <div class="entry-form">
            <div class="form-group">
                <label>è²¨å¹£</label>
                <select class="form-control bond-currency">
                    <option value="HKD" ${bond.currency === 'HKD' ? 'selected' : ''}>æ¸¯å…ƒ (HKD)</option>
                    <option value="USD" ${bond.currency === 'USD' ? 'selected' : ''}>ç¾å…ƒ (USD)</option>
                </select>
            </div>
            <div class="form-group">
                <label>å‚µåˆ¸åç¨±</label>
                <input type="text" class="form-control bond-name" value="${bond.name || ''}" 
                       placeholder="å‚µåˆ¸åç¨±">
            </div>
            <div class="form-group">
                <label>åˆ°æœŸæ—¥</label>
                <input type="date" class="form-control bond-maturity" value="${bond.maturityDate || ''}" style="width: 100%;">
            </div>
            <div class="form-group">
                <label>æ´¾æ¯ç¸½æ”¶ç›Š (è‡ªå‹•è¨ˆç®—)</label>
                <input type="number" class="form-control bond-yield-display" value="${totalPayments.toFixed(2)}" 
                       step="0.01" readonly placeholder="0.00" 
                       style="background-color: #f8f9fa; color: #666;">
            </div>
        </div>
        <div class="bond-payment-section">
            <div class="table-wrapper" id="table-wrapper-${index}">
                <div class="table-collapsed" id="table-content-${index}">
                    <table class="bond-payment-table">
                        <thead>
                            <tr>
                                <th>æœŸé–“åç¨±</th>
                                <th>é¡å‹</th>
                                <th>æ´¾æ¯é‡‘é¡</th>
                                <th>æ´¾æ¯æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="bond-payments-${index}">
                        </tbody>
                    </table>
                </div>
                <button type="button" class="table-expand-btn" id="expand-btn-${index}" style="display: none;">
                    <span class="expand-text">é¡¯ç¤ºæ›´å¤šè¨˜éŒ„ (å…± <span class="record-count">0</span> é …)</span>
                    <span class="collapse-text">æ”¶èµ·è¨˜éŒ„</span>
                </button>
            </div>
            <button type="button" class="btn btn--secondary btn--sm add-bond-payment-btn" 
                    data-bond="${index}">
                æ·»åŠ æ´¾æ¯è¨˜éŒ„
            </button>
        </div>
    `;
    
    const currencySelect = div.querySelector('.bond-currency');
    const nameInput = div.querySelector('.bond-name');
    const maturityInput = div.querySelector('.bond-maturity');
    const removeBtn = div.querySelector('.remove-bond-btn');
    const addPaymentBtn = div.querySelector('.add-bond-payment-btn');
    
    [currencySelect, nameInput, maturityInput].forEach(input => {
        if (input) {
            input.addEventListener('change', () => {
                updateBond(index, input);
            });
            // æ–°å¢ï¼šç‚ºåç¨±è¼¸å…¥æ¡†æ·»åŠ å³æ™‚æ›´æ–°
            if (input === nameInput) {
                input.addEventListener('input', () => {
                    updateBond(index, input);
                });
            }
        }
    });
    
    if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeBond(index);
        });
    }
    
    if (addPaymentBtn) {
        addPaymentBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addBondPaymentRow(index);
        });
    }
    
    // æ·»åŠ æ‘ºç–ŠæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    const expandBtn = div.querySelector(`#expand-btn-${index}`);
    if (expandBtn) {
        expandBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleTableExpansion(index, false);
        });
    }
    
    setTimeout(() => renderBondPayments(index), 10);
    return div;
}

function renderBondPayments(bondIndex) {
    const tbody = document.getElementById(`bond-payments-${bondIndex}`);
    if (!tbody) return;
    const bond = appData.bonds[bondIndex];
    if (!bond || !bond.payments) return;
    tbody.innerHTML = '';
    bond.payments.forEach((payment, index) => {
        const row = createBondPaymentRow(bondIndex, payment, index);
        tbody.appendChild(row);
    });
    // æª¢æŸ¥æ˜¯å¦éœ€è¦æ‘ºç–Š
    checkTableCollapse(bondIndex, false);
}

function createBondPaymentRow(bondIndex, payment = {}, index = -1) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>
            <input type="text" class="form-control payment-period" value="${payment.period || ''}" 
                   placeholder="ä¾‹ï¼š2024Q1">
        </td>
        <td>
            <select class="form-control payment-type">
                <option value="confirmed" ${payment.type === 'confirmed' ? 'selected' : ''}>ç¢ºå®š</option>
                <option value="predicted" ${payment.type === 'predicted' ? 'selected' : ''}>é æ¸¬</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control payment-amount" value="${payment.amount || ''}" 
                   step="0.01" min="0" placeholder="0.00">
        </td>
        <td>
            <input type="date" class="form-control payment-date" value="${payment.date || ''}" style="width: 100%;">
        </td>
        <td>
            <button type="button" class="btn btn--outline btn--sm remove-payment-btn">
                åˆªé™¤
            </button>
        </td>
    `;
    
    const periodInput = tr.querySelector('.payment-period');
    const typeSelect = tr.querySelector('.payment-type');
    const amountInput = tr.querySelector('.payment-amount');
    const dateInput = tr.querySelector('.payment-date');
    const removeBtn = tr.querySelector('.remove-payment-btn');
    
    [periodInput, typeSelect, amountInput, dateInput].forEach(input => {
        if (input) {
            input.addEventListener('change', () => {
                updateBondPayment(bondIndex, index, input);
            });
        }
    });
    
    if (removeBtn) {
        removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeBondPayment(bondIndex, index);
        });
    }
    
    return tr;
}

// æ–°å¢ï¼šæ›´æ–°å€ºåˆ¸æ€»æ”¶ç›Šæ˜¾ç¤ºçš„å‡½æ•°
function updateBondYieldDisplay(bondIndex) {
    const bond = appData.bonds[bondIndex];
    if (!bond) return;
    
    // è®¡ç®—æ´¾æ¯è®°å½•æ€»å’Œ
    const totalPayments = (bond.payments || []).reduce((sum, payment) => {
        return sum + (parseFloat(payment.amount) || 0);
    }, 0);
    
    // æ›´æ–°æ˜¾ç¤ºå­—æ®µ
    const yieldDisplayInput = document.querySelector(`#bonds-container .bond-entry:nth-child(${bondIndex + 1}) .bond-yield-display`);
    if (yieldDisplayInput) {
        yieldDisplayInput.value = totalPayments.toFixed(2);
    }
}

function updateBondPayment(bondIndex, paymentIndex, inputElement) {
    if (paymentIndex === -1 || !appData.bonds[bondIndex] || !appData.bonds[bondIndex].payments[paymentIndex]) return;
    const payment = appData.bonds[bondIndex].payments[paymentIndex];
    if (inputElement.classList.contains('payment-period')) {
        payment.period = inputElement.value;
    } else if (inputElement.classList.contains('payment-type')) {
        payment.type = inputElement.value;
    } else if (inputElement.classList.contains('payment-amount')) {
        payment.amount = parseFloat(inputElement.value) || 0;
        // æ›´æ–°æ€»æ”¶ç›Šæ˜¾ç¤º
        updateBondYieldDisplay(bondIndex);
    } else if (inputElement.classList.contains('payment-date')) {
        payment.date = inputElement.value;
    }
    saveData();
    updateCalculations();
}

function removeBondPayment(bondIndex, paymentIndex) {
    if (!appData.bonds[bondIndex] || !appData.bonds[bondIndex].payments) return;
    appData.bonds[bondIndex].payments.splice(paymentIndex, 1);
    renderBondPayments(bondIndex);
    updateBondYieldDisplay(bondIndex); // æ›´æ–°æ€»æ”¶ç›Šæ˜¾ç¤º
    saveData();
    updateCalculations();
}

function addBond() {
    appData.bonds.push({
        currency: 'HKD',
        name: '',
        maturityDate: '',
        payments: [] // ç§»é™¤ yield å­—æ®µï¼Œæ”¹ä¸ºè‡ªåŠ¨è®¡ç®—
    });
    renderBonds();
    saveData();
}

function updateBond(index, inputElement) {
    if (!appData.bonds[index]) return;
    const bond = appData.bonds[index];
    if (inputElement.classList.contains('bond-currency')) {
        bond.currency = inputElement.value;
    } else if (inputElement.classList.contains('bond-name')) {
        bond.name = inputElement.value;
        // æ–°å¢ï¼šå³æ™‚æ›´æ–°å·¦ä¸Šè§’çš„å‚µåˆ¸åç¨±é¡¯ç¤º
        const bondEntry = document.querySelector(`#bonds-container .bond-entry:nth-child(${index + 1})`);
        if (bondEntry) {
            const titleElement = bondEntry.querySelector('.bond-title');
            if (titleElement) {
                titleElement.textContent = bond.name || 'å‚µåˆ¸';
            }
        }
    } else if (inputElement.classList.contains('bond-maturity')) {
        bond.maturityDate = inputElement.value;
    }
    // ç§»é™¤ bond-yield çš„å¤„ç†é€»è¾‘
    saveData();
    updateCalculations();
}

function removeBond(index) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å‚µåˆ¸è¨˜éŒ„å—ï¼Ÿ')) {
        appData.bonds.splice(index, 1);
        renderBonds();
        saveData();
        updateCalculations();
    }
}

// ======= Calculation Functionsï¼ˆæ›´æ–°ä»¥åŒ…å«è‚¡ç¥¨ç¾å…ƒè½‰æ›å’Œå‚µåˆ¸æ´¾æ¯ï¼‰=======
function calculateTotals(year = selectedYear) {
    let stockTotal = { confirmed: 0, predicted: 0, hkd: 0 };
    let depositTotal = { hkd: 0 };
    let bondTotal = { confirmed: 0, predicted: 0, hkd: 0 };
    
    // è‚¡ç¥¨ - ä¿®æ”¹ä»¥æ”¯æŒç¾å…ƒè½‰æ›
    Object.values(appData.stocks).forEach(stock => {
        if (stock.dividends) {
            stock.dividends.forEach(dividend => {
                if (dividend.amount > 0 && dividend.date) {
                    const date = new Date(dividend.date);
                    if (date.getFullYear() !== year) return;
                    const shares = dividend.shares !== undefined ? dividend.shares : stock.shares || 0;
                    let totalAmount = shares * dividend.amount;
                    
                    // å¦‚æœè‚¡ç¥¨æ˜¯ç¾å…ƒè¨ˆåƒ¹ï¼Œè½‰æ›ç‚ºæ¸¯å…ƒ
                    if (stock.currency === 'USD') {
                        totalAmount = convertUsdToHkd(totalAmount);
                    }
                    
                    if (dividend.type === 'confirmed') {
                        stockTotal.confirmed += totalAmount;
                    } else {
                        stockTotal.predicted += totalAmount;
                    }
                }
            });
        }
    });
    stockTotal.hkd = stockTotal.confirmed + stockTotal.predicted;
    
    // å­˜æ¬¾
    appData.deposits.forEach(deposit => {
        if (deposit.interest > 0 && deposit.maturityDate) {
            const date = new Date(deposit.maturityDate);
            if (date.getFullYear() !== year) return;
            if (deposit.currency === 'USD') {
                depositTotal.hkd += convertUsdToHkd(deposit.interest);
            } else {
                depositTotal.hkd += deposit.interest;
            }
        }
    });
    
    // å€ºåˆ¸ - ä¿®æ”¹ï¼šåªä½¿ç”¨æ´¾æ¯è®°å½•ï¼Œä¸å†ä½¿ç”¨ yield å­—æ®µ
    appData.bonds.forEach(bond => {
        // åªè®¡ç®—æ´¾æ¯è®°å½•
        if (bond.payments) {
            bond.payments.forEach(payment => {
                if (payment.amount > 0 && payment.date) {
                    const date = new Date(payment.date);
                    if (date.getFullYear() !== year) return;
                    const amount = bond.currency === 'USD' ? convertUsdToHkd(payment.amount) : payment.amount;
                    if (payment.type === 'confirmed') {
                        bondTotal.confirmed += amount;
                    } else {
                        bondTotal.predicted += amount;
                    }
                }
            });
        }
    });
    bondTotal.hkd = bondTotal.confirmed + bondTotal.predicted;
    
    const totalHkd = stockTotal.hkd + depositTotal.hkd + bondTotal.hkd;
    const totalUsd = totalHkd / appData.usdHkdRate;
    
    return {
        stock: stockTotal,
        deposit: depositTotal,
        bond: bondTotal,
        total: {
            hkd: totalHkd,
            usd: totalUsd,
            confirmed: stockTotal.confirmed + depositTotal.hkd + bondTotal.confirmed,
            predicted: stockTotal.predicted + bondTotal.predicted
        }
    };
}

function calculateMonthlyDistributionStacked(year = selectedYear) {
    const monthlyData = Array(12).fill(0).map(() => ({
        stock: 0, deposit: 0, bond: 0
    }));
    
    // è‚¡ç¥¨ - ä¿®æ”¹ä»¥æ”¯æŒç¾å…ƒè½‰æ›
    Object.values(appData.stocks).forEach(stock => {
        if (stock.dividends) {
            stock.dividends.forEach(dividend => {
                if (dividend.amount > 0 && dividend.date) {
                    const date = new Date(dividend.date);
                    if (date.getFullYear() !== year) return;
                    const month = date.getMonth();
                    const shares = dividend.shares !== undefined ? dividend.shares : stock.shares || 0;
                    let totalAmount = shares * dividend.amount;
                    
                    // å¦‚æœè‚¡ç¥¨æ˜¯ç¾å…ƒè¨ˆåƒ¹ï¼Œè½‰æ›ç‚ºæ¸¯å…ƒ
                    if (stock.currency === 'USD') {
                        totalAmount = convertUsdToHkd(totalAmount);
                    }
                    
                    monthlyData[month].stock += totalAmount;
                }
            });
        }
    });
    
    // å­˜æ¬¾
    appData.deposits.forEach(deposit => {
        if (deposit.interest > 0 && deposit.maturityDate) {
            const date = new Date(deposit.maturityDate);
            if (date.getFullYear() !== year) return;
            const month = date.getMonth();
            const amount = deposit.currency === 'USD' ? convertUsdToHkd(deposit.interest) : deposit.interest;
            monthlyData[month].deposit += amount;
        }
    });
    
    // å€ºåˆ¸ - ä¿®æ”¹ï¼šåªä½¿ç”¨æ´¾æ¯è®°å½•
    appData.bonds.forEach(bond => {
        if (bond.payments) {
            bond.payments.forEach(payment => {
                if (payment.amount > 0 && payment.date) {
                    const date = new Date(payment.date);
                    if (date.getFullYear() !== year) return;
                    const month = date.getMonth();
                    const amount = bond.currency === 'USD' ? convertUsdToHkd(payment.amount) : payment.amount;
                    monthlyData[month].bond += amount;
                }
            });
        }
    });
    
    return monthlyData;
}

function calculateStockDividendBreakdown(year = selectedAnalysisYear) {
    const result = {};
    Object.values(appData.stocks).forEach(stock => {
        if (stock.dividends) {
            let total = 0;
            stock.dividends.forEach(dividend => {
                if (dividend.amount > 0 && dividend.date) {
                    const date = new Date(dividend.date);
                    if (date.getFullYear() !== year) return;
                    const shares = dividend.shares !== undefined ? dividend.shares : stock.shares || 0;
                    let totalAmount = shares * dividend.amount;
                    
                    // å¦‚æœè‚¡ç¥¨æ˜¯ç¾å…ƒè¨ˆåƒ¹ï¼Œè½‰æ›ç‚ºæ¸¯å…ƒ
                    if (stock.currency === 'USD') {
                        totalAmount = convertUsdToHkd(totalAmount);
                    }
                    
                    total += totalAmount;
                }
            });
            if (total > 0) {
                result[stock.code] = total;
            }
        }
    });
    return result;
}

function calculateMonthlySummary(year = selectedAnalysisYear) {
    const monthlyData = calculateMonthlyDistributionStacked(year);
    const totals = { stock: 0, deposit: 0, bond: 0 };
    const monthlyAmounts = Array(12).fill(0);
    monthlyData.forEach((data, i) => {
        monthlyAmounts[i] = data.stock + data.deposit + data.bond;
        totals.stock += data.stock;
        totals.deposit += data.deposit;
        totals.bond += data.bond;
    });
    const maxMonth = monthlyAmounts.indexOf(Math.max(...monthlyAmounts));
    const avg = monthlyAmounts.reduce((a, b) => a + b, 0) / 12;
    return {
        maxMonth: monthNames[maxMonth],
        avg: avg,
        totals: totals
    };
}

function updateCalculations() {
    const activeTab = document.querySelector('.tab-btn--active');
    if (activeTab) {
        const tabName = activeTab.dataset.tab;
        if (tabName === 'overview') {
            updateOverview();
        } else if (tabName === 'monthly') {
            updateMonthlyDetails();
        } else if (tabName === 'calendar') {
            updateCalendar();
        } else if (tabName === 'analysis') {
            updateAnalysis();
        }
    }
}

// Monthly Details - ä¿®æ”¹ä»¥åŒ…å«å‚µåˆ¸æ´¾æ¯å’Œè‚¡ç¥¨ç¾å…ƒè½‰æ›
function updateMonthlyDetails() {
    renderYearSelector();
    const monthlyData = calculateMonthlyDistributionStacked(selectedYear);
    const detailedMonthlyData = calculateDetailedMonthlyData(selectedYear);
    updateMonthlyChart(monthlyData);
    renderMonthlyCards(detailedMonthlyData);
}

function calculateDetailedMonthlyData(year = selectedYear) {
    const monthlyData = Array(12).fill(null).map(() => ({
        total: 0,
        items: []
    }));
    
    // è‚¡ç¥¨ - ä¿®æ”¹ä»¥æ”¯æŒç¾å…ƒè½‰æ›
    Object.values(appData.stocks).forEach(stock => {
        if (stock.dividends) {
            stock.dividends.forEach(dividend => {
                if (dividend.amount > 0 && dividend.date) {
                    const date = new Date(dividend.date);
                    if (date.getFullYear() !== year) return;
                    const month = date.getMonth();
                    const shares = dividend.shares !== undefined ? dividend.shares : stock.shares || 0;
                    let totalAmount = shares * dividend.amount;
                    
                    // å¦‚æœè‚¡ç¥¨æ˜¯ç¾å…ƒè¨ˆåƒ¹ï¼Œè½‰æ›ç‚ºæ¸¯å…ƒ
                    if (stock.currency === 'USD') {
                        totalAmount = convertUsdToHkd(totalAmount);
                    }
                    
                    monthlyData[month].total += totalAmount;
                    monthlyData[month].items.push({
                        name: stock.name,
                        type: dividend.type,
                        period: dividend.period,
                        amount: totalAmount,
                        currency: 'HKD' // çµ±ä¸€é¡¯ç¤ºç‚ºæ¸¯å…ƒ
                    });
                }
            });
        }
    });
    
    // å­˜æ¬¾
    appData.deposits.forEach(deposit => {
        if (deposit.interest > 0 && deposit.maturityDate) {
            const date = new Date(deposit.maturityDate);
            if (date.getFullYear() !== year) return;
            const month = date.getMonth();
            const amount = deposit.currency === 'USD' ? convertUsdToHkd(deposit.interest) : deposit.interest;
            monthlyData[month].total += amount;
            monthlyData[month].items.push({
                name: 'å®šæœŸå­˜æ¬¾',
                type: 'deposit',
                period: 'åˆ°æœŸ',
                amount: amount,
                currency: 'HKD'
            });
        }
    });
    
    // å€ºåˆ¸ - ä¿®æ”¹ï¼šåªä½¿ç”¨æ´¾æ¯è®°å½•
    appData.bonds.forEach(bond => {
        if (bond.payments) {
            bond.payments.forEach(payment => {
                if (payment.amount > 0 && payment.date) {
                    const date = new Date(payment.date);
                    if (date.getFullYear() !== year) return;
                    const month = date.getMonth();
                    const amount = bond.currency === 'USD' ? convertUsdToHkd(payment.amount) : payment.amount;
                    monthlyData[month].total += amount;
                    monthlyData[month].items.push({
                        name: bond.name || 'å‚µåˆ¸',
                        type: payment.type,
                        period: payment.period,
                        amount: amount,
                        currency: 'HKD'
                    });
                }
            });
        }
    });
    
    return monthlyData;
}

function renderMonthlyCards(monthlyData) {
    const container = document.getElementById('monthly-cards-grid');
    if (!container) return;
    container.innerHTML = '';
    monthlyData.forEach((monthData, index) => {
        const card = createMonthlyCard(monthNames[index], monthData);
        container.appendChild(card);
    });
}

function createMonthlyCard(monthName, monthData) {
    const div = document.createElement('div');
    if (monthData.total === 0) {
        div.className = 'monthly-card monthly-card--empty';
        div.innerHTML = `
            <div class="monthly-card__header">${monthName}</div>
            <div class="monthly-card--empty">
                <p>æœ¬æœˆç„¡æ”¶å…¥</p>
            </div>
        `;
        return div;
    }
    div.className = 'monthly-card';
    div.innerHTML = `
        <div class="monthly-card__header">${monthName}</div>
        <div class="monthly-card__total">
            <div class="monthly-total-amount">${formatCurrency(monthData.total, 'HKD')}</div>
        </div>
        <div class="monthly-card__items" id="items-${monthName}">
            ${monthData.items.map(item => createMonthlyItemHTML(item)).join('')}
        </div>
        ${monthData.items.length > 4 ? `
            <button class="monthly-card__expand-btn" onclick="toggleExpand('${monthName}')">
                é»æ“ŠæŸ¥çœ‹æ›´å¤š
            </button>
        ` : ''}
    `;
    return div;
}

function createMonthlyItemHTML(item) {
    const typeClass = getTypeClass(item.type);
    const typeLabel = getTypeLabel(item.type);

    return `
        <div class="monthly-item">
            <div class="monthly-item__info">
                <div class="monthly-item__name">${item.name}</div>
                <div class="monthly-item__details">
                    <span class="monthly-item__type monthly-item__type--${typeClass}">${typeLabel}</span>
                    ${item.period ? `<span>${item.period}</span>` : ''}
                </div>
            </div>
            <div class="monthly-item__amount">
                <div class="monthly-item__amount-primary">${formatCurrency(item.amount, 'HKD')}</div>
            </div>
        </div>
    `;
}

function getTypeClass(type) {
    switch (type) {
        case 'confirmed': return 'confirmed';
        case 'predicted': return 'predicted';
        case 'deposit': return 'deposit';
        case 'bond': return 'bond';
        default: return 'confirmed';
    }
}

function getTypeLabel(type) {
    switch (type) {
        case 'confirmed': return 'ç¢ºå®š';
        case 'predicted': return 'é æ¸¬';
        case 'deposit': return 'å­˜æ¬¾';
        case 'bond': return 'å‚µåˆ¸';
        default: return 'ç¢ºå®š';
    }
}

// Chart Functions
function updateMonthlyChart(monthlyData) {
    const ctx = document.getElementById('monthlyChart');
    if (!ctx) return;
    const context = ctx.getContext('2d');
    if (charts.monthly) {
        charts.monthly.destroy();
    }
    const labels = monthNames;
    const stockData = monthlyData.map(d => d.stock);
    const depositData = monthlyData.map(d => d.deposit);
    const bondData = monthlyData.map(d => d.bond);

    charts.monthly = new Chart(context, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'è‚¡æ¯',
                    data: stockData,
                    backgroundColor: chartColors[0],
                    borderColor: chartColors[0],
                    borderWidth: 1
                },
                {
                    label: 'å®šæœŸå­˜æ¬¾',
                    data: depositData,
                    backgroundColor: chartColors[1],
                    borderColor: chartColors[1],
                    borderWidth: 1
                },
                {
                    label: 'å‚µåˆ¸',
                    data: bondData,
                    backgroundColor: chartColors[2],
                    borderColor: chartColors[2],
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'æœˆåº¦æ”¶å…¥åˆ†ä½ˆï¼ˆå †ç–Šï¼‰'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.y;
                            return `${label}: ${formatCurrency(value, 'HKD')}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'HK$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Analysis Charts
function updateAnalysis() {
    renderAnalysisYearSelector();
    setTimeout(() => {
        updateSourceChart();
        updateStockDividendChart();
        updateTrendChart();
        updateSummary();
    }, 100);
}

function updateSourceChart() {
    const ctx = document.getElementById('sourceChart');
    if (!ctx) return;
    const context = ctx.getContext('2d');
    const totals = calculateTotals(selectedAnalysisYear);
    if (charts.source) {
        charts.source.destroy();
    }
    const data = [totals.stock.hkd, totals.deposit.hkd, totals.bond.hkd];
    const labels = ['è‚¡ç¥¨', 'å®šæœŸå­˜æ¬¾', 'å‚µåˆ¸'];

    charts.source = new Chart(context, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [chartColors[0], chartColors[1], chartColors[2]],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'æ”¶ç›Šä¾†æºåˆ†ä½ˆ'
                },
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                            return `${label}: ${formatCurrency(value, 'HKD')} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateStockDividendChart() {
    const ctx = document.getElementById('stockDividendChart');
    const legendContainer = document.getElementById('stockDividendLegend');
    if (!ctx || !legendContainer) return;
    const context = ctx.getContext('2d');
    const stockBreakdown = calculateStockDividendBreakdown(selectedAnalysisYear);
    if (charts.stockDividend) {
        charts.stockDividend.destroy();
    }
    
    // å°‡æ•¸æ“šè½‰æ›ç‚ºæ•¸çµ„ä¸¦æŒ‰é‡‘é¡æ’åºï¼ˆç”±é«˜åˆ°ä½ï¼‰
    const sortedData = Object.entries(stockBreakdown)
        .map(([code, amount]) => ({
            code: code,
            amount: amount,
            label: (() => {
                const stock = appData.stocks[code];
                return stock ? `${stock.code} ${stock.name}` : code;
            })()
        }))
        .sort((a, b) => b.amount - a.amount); // ç”±é«˜åˆ°ä½æ’åº

    const labels = sortedData.map(item => item.label);
    const data = sortedData.map(item => item.amount);

    // ç”Ÿæˆè¶³å¤ çš„ä¸é‡è¤‡é¡è‰²
    function generateColors(count) {
        const colors = [];
        const baseColors = ["#1FB8CD", "#FFC185", "#B4413C", "#ECEBD5", "#5D878F", "#DB4545", "#D2BA4C", "#964325", "#944454", "#13343B"];
        
        // å…ˆä½¿ç”¨é å®šç¾©çš„é¡è‰²
        for (let i = 0; i < Math.min(count, baseColors.length); i++) {
            colors.push(baseColors[i]);
        }
        
        // å¦‚æœéœ€è¦æ›´å¤šé¡è‰²ï¼Œå‹•æ…‹ç”Ÿæˆ
        for (let i = baseColors.length; i < count; i++) {
            const hue = (i * 137.508) % 360; // ä½¿ç”¨é»ƒé‡‘è§’åº¦åˆ†å‰²
            const saturation = 60 + (i % 4) * 10; // 60-90%
            const lightness = 40 + (i % 3) * 15; // 40-70%
            colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
        }
        
        return colors;
    }

    const colors = generateColors(labels.length);

    charts.stockDividend = new Chart(context, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'å„è‚¡ç¥¨è‚¡æ¯ä½”æ¯”'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const rawValue = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((rawValue / total) * 100).toFixed(1) : '0.0';
                            return `${label}: ${formatCurrency(rawValue, 'HKD')} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // è‡ªè¨‚ legend - æŒ‰ç…§æ’åºå¾Œçš„é †åºé¡¯ç¤º
    legendContainer.innerHTML = '';
    const total = data.reduce((a, b) => a + b, 0);
    labels.forEach((label, i) => {
        const percentage = total > 0 ? ((data[i] / total) * 100).toFixed(1) : 0;
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `
            <span class="color-box" style="background-color:${colors[i]}"></span>
            <span class="label">${label}</span>
            <span class="percentage">${percentage}%</span>
        `;
        item.addEventListener('click', () => {
            const meta = charts.stockDividend.getDatasetMeta(0);
            const slice = meta.data[i];
            if (slice.hidden === true) {
                slice.hidden = false;
                item.style.opacity = 1;
            } else {
                slice.hidden = true;
                item.style.opacity = 0.5;
            }
            charts.stockDividend.update();
        });
        legendContainer.appendChild(item);
    });
}

function updateTrendChart() {
    const ctx = document.getElementById('trendChart');
    if (!ctx) return;
    const context = ctx.getContext('2d');
    const monthlyData = calculateMonthlyDistributionStacked(selectedAnalysisYear);
    if (charts.trend) {
        charts.trend.destroy();
    }
    const cumulativeData = [];
    let cumulative = 0;
    monthlyData.forEach(data => {
        cumulative += data.stock + data.deposit + data.bond;
        cumulativeData.push(cumulative);
    });

    charts.trend = new Chart(context, {
        type: 'line',
        data: {
            labels: monthNames,
            datasets: [{
                label: 'ç´¯ç©æ”¶ç›Š (HK$)',
                data: cumulativeData,
                borderColor: chartColors[0],
                backgroundColor: chartColors[0] + '20',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ç´¯ç©æ”¶ç›Šè¶¨å‹¢'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'HK$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function updateSummary() {
    const summary = calculateMonthlySummary(selectedAnalysisYear);
    const container = document.getElementById('analysis-summary');
    if (!container) return;

    container.innerHTML = `
    <div class="summary-list">
        <div class="summary-bar">
            <span class="summary-label">æ”¶ç›Šæœ€é«˜æœˆä»½</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${summary.maxMonth}</span>
        </div>
        <div class="summary-bar">
            <span class="summary-label">å¹³å‡æœˆåº¦æ”¶ç›Š</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${formatCurrency(summary.avg, 'HKD')}</span>
        </div>
        <div class="summary-bar">
            <span class="summary-label">å®šæœŸå­˜æ¬¾ç¸½æ”¶ç›Š</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${formatCurrency(summary.totals.deposit, 'HKD')}</span>
        </div>
        <div class="summary-bar">
            <span class="summary-label">è‚¡æ¯ç¸½æ”¶ç›Š</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${formatCurrency(summary.totals.stock, 'HKD')}</span>
        </div>
        <div class="summary-bar">
            <span class="summary-label">å‚µæ¯ç¸½æ”¶ç›Š</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${formatCurrency(summary.totals.bond, 'HKD')}</span>
        </div>
        <div class="summary-bar">
            <span class="summary-label">ç¸½è¢«å‹•æ”¶å…¥æ”¶ç›Š</span><span class="summary-colon">ï¼š</span>
            <span class="summary-value">${formatCurrency(summary.totals.stock + summary.totals.deposit + summary.totals.bond, 'HKD')}</span>
        </div>
    </div>
`;
}

window.toggleExpand = function(monthName) {
    const container = document.getElementById(`items-${monthName}`);
    const btn = container.nextElementSibling;
    if (container.classList.contains('expanded')) {
        container.classList.remove('expanded');
        btn.textContent = 'é»æ“ŠæŸ¥çœ‹æ›´å¤š';
    } else {
        container.classList.add('expanded');
        btn.textContent = 'æ”¶èµ·å…§å®¹';
    }
};

// ========== æ–°çš„ updateOverview() å¯¦ç¾ ==========
function updateOverview() {
    if (typeof getAvailableYears !== "function" || typeof calculateTotals !== "function" || typeof formatCurrency !== "function") return;

    const years = getAvailableYears();

    // å¹´åº¦ç¸½æ”¶ç›Š
    const totalAnnualList = document.getElementById('total-annual-list');
    if (totalAnnualList) {
        totalAnnualList.innerHTML = years.map(year => {
            const totals = calculateTotals(year);
            return `<div>${year}å¹´ï¼š${formatCurrency(totals.total.hkd, 'HKD')}</div>`;
        }).join('');
    }

    // ç¢ºå®šæ”¶ç›Š
    const confirmedIncomeList = document.getElementById('confirmed-income-list');
    if (confirmedIncomeList) {
        confirmedIncomeList.innerHTML = years.map(year => {
            const totals = calculateTotals(year);
            return `<div>${year}å¹´ï¼š${formatCurrency(totals.total.confirmed, 'HKD')}</div>`;
        }).join('');
    }

    // é æ¸¬æ”¶ç›Š
    const predictedIncomeList = document.getElementById('predicted-income-list');
    if (predictedIncomeList) {
        predictedIncomeList.innerHTML = years.map(year => {
            const totals = calculateTotals(year);
            return `<div>${year}å¹´ï¼š${formatCurrency(totals.total.predicted, 'HKD')} <span class="prediction-label">(é æ¸¬)</span></div>`;
        }).join('');
    }

    // æ”¶ç›Šä¾†æºåˆ†ä½ˆ
    const sourcePercentageList = document.getElementById('source-percentage-list');
    if (sourcePercentageList) {
        sourcePercentageList.innerHTML = years.map(year => {
            const totals = calculateTotals(year);
            const total = totals.total.hkd;
            const stockP = total > 0 ? (totals.stock.hkd / total * 100).toFixed(1) : '0.0';
            const depositP = total > 0 ? (totals.deposit.hkd / total * 100).toFixed(1) : '0.0';
            const bondP = total > 0 ? (totals.bond.hkd / total * 100).toFixed(1) : '0.0';
            return `<div style="margin-bottom: 8px;">
                <div><b>${year}å¹´ï¼š</b></div>
                <div style="padding-left: 12px;">
                    <div>è‚¡ç¥¨ <span style="float:right;">${stockP}%</span></div>
                    <div>å®šæœŸå­˜æ¬¾ <span style="float:right;">${depositP}%</span></div>
                    <div>å‚µåˆ¸ <span style="float:right;">${bondP}%</span></div>
                </div>
            </div>`;
        }).join('');
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    initTabs();
    renderStocks();
    renderDeposits();
    renderBonds();

    setTimeout(() => {
        updateOverview();
    }, 100);

    const addDepositBtn = document.getElementById('add-deposit-btn');
    const addBondBtn = document.getElementById('add-bond-btn');
    const exportBtn = document.getElementById('export-data-btn');
    const importInput = document.getElementById('import-data-file');
    const resetBtn = document.getElementById('reset-data-btn');

    if (addDepositBtn) {
        addDepositBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addDeposit();
        });
    }

    if (addBondBtn) {
        addBondBtn.addEventListener('click', (e) => {
            e.preventDefault();
            addBond();
        });
    }

    if (exportBtn) {
        exportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            exportData();
        });
    }

    if (importInput) {
        importInput.addEventListener('change', (e) => {
            importData(e);
        });
    }

    if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
            e.preventDefault();
            resetData();
        });
    }
    // GitHub åŒæ­¥æŒ‰éˆ•äº‹ä»¶
const syncGithubBtn = document.getElementById('sync-github-btn');
const loadGithubBtn = document.getElementById('load-github-btn');

if (syncGithubBtn) {
    syncGithubBtn.addEventListener('click', (e) => {
        e.preventDefault();
        syncToGitHub();
    });
}

if (loadGithubBtn) {
    loadGithubBtn.addEventListener('click', (e) => {
        e.preventDefault();
        loadFromGitHub();
    });
}

    const rateInput = document.getElementById('usd-hkd-rate');
    if (rateInput) {
        rateInput.value = appData.usdHkdRate;
        rateInput.addEventListener('change', (e) => {
            const value = parseFloat(e.target.value);
            if (!isNaN(value) && value > 0) {
                appData.usdHkdRate = value;
                saveData();
                updateCalculations();
            } else {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åŒ¯ç‡');
            }
        });
    }
});

window.addEventListener('beforeunload', function() {
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
});

document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-control') ||
        e.target.classList.contains('btn')) {
        saveData();
    }
});

document.addEventListener('input', function(e) {
    if (e.target.classList.contains('form-control')) {
        saveData();
    }
});

// ========== GitHub åŒæ­¥åŠŸèƒ½ ==========
async function syncToGitHub() {
    const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
    if (!config.username || !config.repo || !config.token) {
        alert('è«‹å…ˆåœ¨æŒ‡å—é è¨­å®š GitHub é€£æ¥');
        return;
    }
    
    try {
        const path = 'data/dividendtrack-data.json';
        const dataToSync = {
            investmentTrackerData: appData,
            lastSync: new Date().toISOString()
        };
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(dataToSync, null, 2))));
        
        // å…ˆå˜—è©¦ç²å–ç¾æœ‰æ–‡ä»¶çš„ SHA
        let sha = '';
        try {
            const getResponse = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}/contents/${path}`, {
                headers: {
                    'Authorization': `token ${config.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if (getResponse.ok) {
                const fileData = await getResponse.json();
                sha = fileData.sha;
            }
        } catch (e) {}
        
        const body = {
            message: `Update dividendtrack-data.json - ${new Date().toISOString()}`,
            content: content
        };
        if (sha) body.sha = sha;
        
        const response = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}/contents/${path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${config.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            alert('âœ… åŒæ­¥æˆåŠŸï¼');
        } else {
            const errorData = await response.json();
            alert('âŒ åŒæ­¥å¤±æ•—ï¼š' + (errorData.message || response.status));
        }
    } catch (error) {
        alert('âŒ åŒæ­¥éŒ¯èª¤ï¼š' + error.message);
    }
}

async function loadFromGitHub() {
    const config = JSON.parse(localStorage.getItem('githubConfig') || '{}');
    if (!config.username || !config.repo || !config.token) {
        alert('è«‹å…ˆåœ¨æŒ‡å—é è¨­å®š GitHub é€£æ¥');
        return;
    }
    
    try {
        const path = 'data/dividendtrack-data.json';
        const response = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}/contents/${path}`, {
            headers: {
                'Authorization': `token ${config.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const fileData = await response.json();
            const content = decodeURIComponent(escape(atob(fileData.content)));
            const data = JSON.parse(content);
            
            if (data.investmentTrackerData) {
                appData = data.investmentTrackerData;
                localStorage.setItem('investmentTrackerData', JSON.stringify(appData));
                alert('âœ… è¼‰å…¥æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†');
                location.reload();
            } else {
                alert('GitHub ä¸Šçš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
            }
        } else if (response.status === 404) {
            alert('GitHub ä¸Šå°šç„¡å‚™ä»½æ•¸æ“š');
        } else {
            alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + response.status);
        }
    } catch (error) {
        alert('âŒ è¼‰å…¥éŒ¯èª¤ï¼š' + error.message);
    }
}
    </script>
</body>
</html>