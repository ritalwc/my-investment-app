<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººæŠ•è³‡ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* å¯†ç¢¼ä¿è­·é é¢ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-box h1 {
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.7);
        }

        .login-box input {
            width: 200px;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            outline: none;
            letter-spacing: 8px;
        }

        .login-box input:focus {
            border-color: #4ecdc4;
        }

        .login-box button {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .login-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(78, 205, 196, 0.4);
        }

        .login-error {
            color: #ff6b6b;
            margin-top: 15px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        /* ä¸»æ‡‰ç”¨ç¨‹å¼ */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* é ‚éƒ¨æ¨™é¡Œ */
        .app-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-header h1 {
            font-size: 1.5em;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-github {
            background: #6e5494;
            color: #fff;
        }

        .btn-backup {
            background: #4ecdc4;
            color: #fff;
        }

        .btn-restore {
            background: #f39c12;
            color: #fff;
        }

        .btn-logout {
            background: #e74c3c;
            color: #fff;
        }

        .header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Tab å°èˆª */
        .tab-nav {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            overflow-x: auto;
            padding: 10px;
            gap: 5px;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #fff;
            font-weight: bold;
        }

        /* Tab å…§å®¹ */
        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* é€šç”¨å¡ç‰‡æ¨£å¼ */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2, .card h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #fff;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-warning {
            background: #f39c12;
            color: #fff;
        }

        .btn-info {
            background: #3498db;
            color: #fff;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4ecdc4;
        }

        .stat-card .stat-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        /* å­˜éŒ¢ç½ç‰¹æ®Šæ¨£å¼ */
        .piggy-bank {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.2), rgba(68, 160, 141, 0.2));
            border: 2px solid rgba(78, 205, 196, 0.5);
        }

        .piggy-value {
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            color: #4ecdc4;
        }

        .piggy-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* å‚µåˆ¸æ¢¯è¦–è¦ºåŒ– */
        .bond-ladder {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bond-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bond-bar-label {
            min-width: 100px;
            font-size: 0.9em;
        }

        .bond-bar-fill {
            height: 30px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border-radius: 5px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: #fff;
            font-weight: bold;
            transition: width 0.5s ease;
        }

        /* æ¨¡æ…‹æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
        }

        /* GitHub è¨­å®šé¢æ¿ */
        .github-settings {
            background: rgba(110, 84, 148, 0.2);
            border: 1px solid rgba(110, 84, 148, 0.5);
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .tab-nav {
                flex-wrap: nowrap;
            }

            .tab-btn {
                min-width: 100px;
                padding: 10px 15px;
                font-size: 0.8em;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .app-header {
                flex-direction: column;
                text-align: center;
            }

            .header-buttons {
                justify-content: center;
            }
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(78, 205, 196, 0.8);
        }

        /* æˆåŠŸ/éŒ¯èª¤æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-weight: bold;
            z-index: 10001;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: #27ae60;
        }

        .toast-error {
            background: #e74c3c;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* æŠ•è³‡è¨˜éŒ„ç‰¹æ®Šæ¨£å¼ */
        .investment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .investment-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .counter-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .counter-btn.minus {
            background: #e74c3c;
            color: #fff;
        }

        .counter-btn.plus {
            background: #27ae60;
            color: #fff;
        }

        .counter-value {
            font-size: 1.5em;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        /* æ¯”è¼ƒçµæœ */
        .comparison-result {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .comparison-result.winner-a {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.5);
        }

        .comparison-result.winner-b {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.5);
        }

        .comparison-result.tie {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid rgba(241, 196, 15, 0.5);
        }

        /* å°å…¥å°å‡ºæŒ‰éˆ•çµ„ */
        .io-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* å‚µåˆ¸é¡å‹æ¨™ç±¤ */
        .bond-type-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
        }

        .bond-type-tag.treasury {
            background: rgba(52, 152, 219, 0.3);
            color: #5dade2;
        }

        .bond-type-tag.corporate {
            background: rgba(155, 89, 182, 0.3);
            color: #bb8fce;
        }

        /* ä»˜æ¯æœˆä»½é¡¯ç¤º */
        .payment-months {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .month-badge {
            padding: 2px 6px;
            background: rgba(78, 205, 196, 0.3);
            border-radius: 4px;
            font-size: 0.75em;
        }

        /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4ecdc4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- å¯†ç¢¼ä¿è­·é é¢ -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h1>ğŸ” å€‹äººæŠ•è³‡ç®¡ç†ç³»çµ±</h1>
            <p>è«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            <input type="password" id="passwordInput" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off">
            <button onclick="checkPassword()">é€²å…¥ç³»çµ±</button>
            <p class="login-error" id="loginError">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
    <div class="main-app" id="mainApp">
        <!-- é ‚éƒ¨æ¨™é¡Œ -->
        <div class="app-header">
            <h1>ğŸ“Š å€‹äººæŠ•è³‡ç®¡ç†ç³»çµ±</h1>
            <div class="header-buttons">
                <button class="header-btn btn-github" onclick="openGitHubSettings()">âš™ï¸ GitHub è¨­å®š</button>
                <button class="header-btn btn-backup" onclick="backupAllData()">ğŸ’¾ å‚™ä»½å…¨éƒ¨</button>
                <button class="header-btn btn-restore" onclick="document.getElementById('restoreFile').click()">ğŸ“‚ è¼‰å…¥å‚™ä»½</button>
                <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreAllData(event)">
                <button class="header-btn btn-logout" onclick="logout()">ğŸšª ç™»å‡º</button>
            </div>
        </div>

        <!-- Tab å°èˆª -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('piggybank')">ğŸ’° å­˜éŒ¢ç½+å®šæŠ•</button>
            <button class="tab-btn" onclick="switchTab('bondladder')">ğŸ¦ ç¾å‚µæ¢¯å·¥å…·</button>
            <button class="tab-btn" onclick="switchTab('bondcompare')">âš–ï¸ å‚µåˆ¸å°æ¯”</button>
            <button class="tab-btn" onclick="switchTab('profitloss')">ğŸ“ˆ ç›ˆè™§è¨ˆç®—å™¨</button>
            <button class="tab-btn" onclick="switchTab('portfolio')">ğŸ“Š æŠ•è³‡çµ„åˆåˆ†æ</button>
        </div>

        <!-- Tab 1: å­˜éŒ¢ç½+å®šæŠ•è¨˜éŒ„ -->
        <div class="tab-content active" id="tab-piggybank">
            <div class="card">
                <h2>ğŸ’° è‚¡æ¯å­˜éŒ¢ç½</h2>
                
                <div class="form-row">
                    <!-- æ¸¯å…ƒè‚¡æ¯ -->
                    <div class="card piggy-bank">
                        <h3>ğŸ‡­ğŸ‡° æ¸¯å…ƒè‚¡æ¯</h3>
                        <div class="piggy-value">HK$ <span id="hkdDividend">0.00</span></div>
                        <div class="piggy-actions">
                            <input type="number" id="hkdAmount" placeholder="é‡‘é¡" style="width:120px">
                            <button class="btn btn-primary" onclick="piggyAction('hkd', 'deposit')">å­˜å…¥</button>
                            <button class="btn btn-danger" onclick="piggyAction('hkd', 'withdraw')">æå–</button>
                        </div>
                    </div>

                    <!-- ç¾å…ƒè‚¡æ¯ SPLG/VXUS -->
                    <div class="card piggy-bank">
                        <h3>ğŸ‡ºğŸ‡¸ SPLG/VXUS å„²éŒ¢ç½</h3>
                        <div class="piggy-value">US$ <span id="usdStock">0.00</span></div>
                        <div class="piggy-actions">
                            <input type="number" id="usdStockAmount" placeholder="é‡‘é¡" style="width:120px">
                            <button class="btn btn-primary" onclick="piggyAction('usdStock', 'deposit')">å­˜å…¥</button>
                            <button class="btn btn-danger" onclick="piggyAction('usdStock', 'withdraw')">æå–</button>
                        </div>
                    </div>

                    <!-- ç¾å‚µå„²éŒ¢ç½ -->
                    <div class="card piggy-bank">
                        <h3>ğŸ‡ºğŸ‡¸ ç¾å‚µå„²éŒ¢ç½</h3>
                        <div class="piggy-value">US$ <span id="usdBond">0.00</span></div>
                        <div class="piggy-actions">
                            <input type="number" id="usdBondAmount" placeholder="é‡‘é¡" style="width:120px">
                            <button class="btn btn-primary" onclick="piggyAction('usdBond', 'deposit')">å­˜å…¥</button>
                            <button class="btn btn-danger" onclick="piggyAction('usdBond', 'withdraw')">æå–</button>
                        </div>
                    </div>
                </div>

                <!-- ç¾è‚¡è‚¡æ¯è‡ªå‹•åˆ†é… -->
                <div class="card" style="margin-top:20px">
                    <h3>ğŸ“Š ç¾è‚¡è‚¡æ¯è‡ªå‹•åˆ†é… (70/30)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è‚¡æ¯é‡‘é¡ (USD)</label>
                            <input type="number" id="usDividendInput" placeholder="è¼¸å…¥è‚¡æ¯é‡‘é¡">
                        </div>
                        <div class="form-group" style="display:flex;align-items:flex-end">
                            <button class="btn btn-primary" onclick="distributeDividend()">åˆ†é…å­˜å…¥</button>
                        </div>
                    </div>
                    <p style="font-size:0.9em;color:rgba(255,255,255,0.7)">70% å…¥ SPLG/VXUS æ± ï¼Œ30% å…¥ç¾å‚µæ± </p>
                </div>
            </div>

            <!-- é‚„æ¬¾å€’æ•¸ -->
            <div class="card">
                <h3>â³ é‚„æ¬¾å€’æ•¸</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>å‰©é¤˜æœˆæ•¸</label>
                        <input type="number" id="loanMonths" value="0" onchange="savePiggyData()">
                    </div>
                    <div class="stat-card">
                        <div class="stat-value"><span id="loanCountdown">--</span></div>
                        <div class="stat-label">å€‹æœˆå¾Œæ¢å¾©æ¯æœˆå„²è“„</div>
                    </div>
                </div>
            </div>

            <!-- æ¸¯è‚¡æŠ•è³‡æ¸…å–® -->
            <div class="card">
                <h3>ğŸ‡­ğŸ‡° æ¸¯è‚¡æŠ•è³‡æ¸…å–®</h3>
                <button class="btn btn-primary" onclick="addHKStock()" style="margin-bottom:15px">+ æ–°å¢è‚¡ç¥¨</button>
                <div id="hkStockList"></div>
            </div>

            <!-- ç¾è‚¡å®šæŠ• -->
            <div class="card">
                <h3>ğŸ‡ºğŸ‡¸ ç¾è‚¡å®šæŠ• (æœ¬æœˆ)</h3>
                <div class="form-row">
                    <div class="investment-item">
                        <span style="font-size:1.2em;font-weight:bold">SPLG</span>
                        <div style="display:flex;align-items:center;gap:15px">
                            <button class="counter-btn minus" onclick="updateDCA('splg', -1)">-</button>
                            <span class="counter-value" id="splgCount">0</span>
                            <button class="counter-btn plus" onclick="updateDCA('splg', 1)">+</button>
                        </div>
                    </div>
                    <div class="investment-item">
                        <span style="font-size:1.2em;font-weight:bold">VXUS</span>
                        <div style="display:flex;align-items:center;gap:15px">
                            <button class="counter-btn minus" onclick="updateDCA('vxus', -1)">-</button>
                            <span class="counter-value" id="vxusCount">0</span>
                            <button class="counter-btn plus" onclick="updateDCA('vxus', 1)">+</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveDCARecord()" style="margin-top:15px">âœ… ä¿å­˜æœ¬æœˆè¨˜éŒ„</button>
            </div>

            <!-- æŠ•è³‡æ­·å²çµ±è¨ˆ -->
            <div class="card">
                <h3>ğŸ“Š æŠ•è³‡æ­·å²çµ±è¨ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSplg">0</div>
                        <div class="stat-label">ç¸½ SPLG</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalVxus">0</div>
                        <div class="stat-label">ç¸½ VXUS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="investMonths">0</div>
                        <div class="stat-label">æŠ•è³‡æœˆæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgMonthly">0</div>
                        <div class="stat-label">å¹³å‡æœˆæŠ•</div>
                    </div>
                </div>
                <div style="margin-top:20px">
                    <h4>æ­·å²è¨˜éŒ„</h4>
                    <div id="dcaHistory" style="max-height:300px;overflow-y:auto"></div>
                </div>
            </div>
        </div>

        <!-- Tab 2: ç¾å‚µæ¢¯è¦–è¦ºåŒ–å·¥å…· -->
        <div class="tab-content" id="tab-bondladder">
            <div class="card">
                <h2>ğŸ¦ ç¾å‚µæ¢¯è¦–è¦ºåŒ–å·¥å…·</h2>
                
                <!-- æ–°å¢å‚µåˆ¸è¡¨å–® -->
                <div class="card">
                    <h3>ğŸ“ æ–°å¢å‚µåˆ¸</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ğŸ“… è³¼è²·æ—¥æœŸ</label>
                            <input type="date" id="bondPurchaseDate">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ å‚µåˆ¸åç¨±</label>
                            <input type="text" id="bondName" placeholder="ä¾‹: 2Y Treasury">
                        </div>
                        <div class="form-group">
                            <label>ğŸ¯ åˆ°æœŸæ—¥</label>
                            <input type="date" id="bondMaturityDate">
                        </div>
                        <div class="form-group">
                            <label>ğŸ’° é¢é¡ (USD)</label>
                            <input type="number" id="bondFaceValue" placeholder="1000">
                        </div>
                        <div class="form-group">
                            <label>ğŸ’µ è³¼è²·åƒ¹æ ¼ (USD)</label>
                            <input type="number" id="bondPurchasePrice" placeholder="980">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ˆ ç¥¨é¢åˆ©ç‡ (%)</label>
                            <input type="number" id="bondCouponRate" step="0.01" placeholder="4.5">
                        </div>
                        <div class="form-group">
                            <label>ğŸ·ï¸ é¡å‹</label>
                            <select id="bondType">
                                <option value="treasury">åœ‹å‚µ</option>
                                <option value="corporate">å…¬å¸å‚µ</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addBond()">â• æ–°å¢å‚µåˆ¸</button>
                </div>

                <!-- çµ±è¨ˆ -->
                <div class="card">
                    <h3>ğŸ“ˆ æŠ•è³‡çµ„åˆçµ±è¨ˆ</h3>
                    <div class="stats-grid" id="bondStats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalBondValue">$0</div>
                            <div class="stat-label">ç¸½é¢é¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalBondCost">$0</div>
                            <div class="stat-label">ç¸½æˆæœ¬</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avgYTM">0%</div>
                            <div class="stat-label">å¹³å‡ YTM</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="annualIncome">$0</div>
                            <div class="stat-label">é ä¼°å¹´æ”¶å…¥</div>
                        </div>
                    </div>
                </div>

                <!-- å‚µæ¯æœˆä»½åˆ†æ -->
                <div class="card">
                    <h3>ğŸ“† å‚µæ¯æœˆä»½åˆ†æ</h3>
                    <div class="chart-container">
                        <canvas id="bondMonthlyChart"></canvas>
                    </div>
                </div>

                <!-- å‚µåˆ¸æ¢¯åœ–è¡¨ -->
                <div class="card">
                    <h3>ğŸ“Š å‚µåˆ¸æ¢¯åœ–è¡¨</h3>
                    <div id="bondLadderChart" class="bond-ladder"></div>
                </div>

                <!-- å‚µåˆ¸åˆ—è¡¨ -->
                <div class="card">
                    <h3>ğŸ“‹ å‚µåˆ¸åˆ—è¡¨</h3>
                    <div style="overflow-x:auto">
                        <table class="data-table" id="bondTable">
                            <thead>
                                <tr>
                                    <th>åç¨±</th>
                                    <th>é¡å‹</th>
                                    <th>ç¥¨é¢åˆ©ç‡</th>
                                    <th>YTM</th>
                                    <th>è³¼è²·æ—¥</th>
                                    <th>åˆ°æœŸæ—¥</th>
                                    <th>è·åˆ°æœŸ</th>
                                    <th>é¢é¡</th>
                                    <th>æˆæœ¬</th>
                                    <th>ä»˜æ¯æœˆä»½</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="bondTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: å‚µåˆ¸å°æ¯”å°ç¨‹å¼ -->
        <div class="tab-content" id="tab-bondcompare">
            <div class="card">
                <h2>âš–ï¸ å‚µåˆ¸æˆæœ¬å°æ¯”å°ç¨‹å¼</h2>
                
                <div class="form-group">
                    <label>è¨ˆç®—æ¨¡å¼</label>
                    <select id="calcMode" onchange="updateCalcMode()">
                        <option value="simple">ç°¡æ˜“æ¨¡å¼</option>
                        <option value="professional">å°ˆæ¥­æ¨¡å¼ï¼ˆDirty Price / æ‡‰è¨ˆåˆ©æ¯ï¼‰</option>
                    </select>
                </div>

                <div class="form-row">
                    <!-- å‚µåˆ¸ A -->
                    <div class="card" style="border-left:4px solid #4ecdc4">
                        <h3>ğŸ“— å‚µåˆ¸ A</h3>
                        <div class="form-group">
                            <label>å‚µåˆ¸é¡å‹</label>
                            <select id="bondA_type">
                                <option value="treasury">åœ‹å‚µ</option>
                                <option value="corporate">å…¬å¸å‚µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç¥¨é¢æ¯ç‡ (%)</label>
                            <input type="number" id="bondA_coupon" step="0.01" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>é¢å€¼ ($)</label>
                            <input type="number" id="bondA_faceValue" value="1000" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>ç¾è³¼è²·åƒ¹ (Clean Price)</label>
                            <input type="number" id="bondA_price" step="0.01" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>ä»˜æ¯é »ç‡</label>
                            <select id="bondA_frequency" onchange="calculateBondComparison()">
                                <option value="2">åŠå¹´ä»˜</option>
                                <option value="1">å¹´ä»˜</option>
                                <option value="4">å­£ä»˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è²·å…¥æ—¥æœŸ</label>
                            <input type="date" id="bondA_buyDate" onchange="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>åˆ°æœŸæ—¥æœŸ</label>
                            <input type="date" id="bondA_maturityDate" onchange="calculateBondComparison()">
                        </div>

                        <div class="card" style="background:rgba(78,205,196,0.1)">
                            <h4>å‚µåˆ¸ A çµæœ</h4>
                            <div id="bondA_results">
                                <p>æŒæœ‰å¤©æ•¸ï¼š<span id="bondA_days">-</span></p>
                                <p>ç¥¨æ¯æ”¶ç›Šï¼š<span id="bondA_couponIncome">-</span></p>
                                <p>è³‡æœ¬æ”¶ç›Šï¼š<span id="bondA_capitalGain">-</span></p>
                                <p>ç¸½æ”¶ç›Šï¼š<span id="bondA_totalReturn">-</span></p>
                                <p>å¹´åŒ–æ¯ç‡ï¼š<span id="bondA_annualRate">-</span></p>
                                <p>YTMï¼š<span id="bondA_ytm">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- å‚µåˆ¸ B -->
                    <div class="card" style="border-left:4px solid #3498db">
                        <h3>ğŸ“˜ å‚µåˆ¸ B</h3>
                        <div class="form-group">
                            <label>å‚µåˆ¸é¡å‹</label>
                            <select id="bondB_type">
                                <option value="treasury">åœ‹å‚µ</option>
                                <option value="corporate">å…¬å¸å‚µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ç¥¨é¢æ¯ç‡ (%)</label>
                            <input type="number" id="bondB_coupon" step="0.01" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>é¢å€¼ ($)</label>
                            <input type="number" id="bondB_faceValue" value="1000" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>ç¾è³¼è²·åƒ¹ (Clean Price)</label>
                            <input type="number" id="bondB_price" step="0.01" oninput="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>ä»˜æ¯é »ç‡</label>
                            <select id="bondB_frequency" onchange="calculateBondComparison()">
                                <option value="2">åŠå¹´ä»˜</option>
                                <option value="1">å¹´ä»˜</option>
                                <option value="4">å­£ä»˜</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>è²·å…¥æ—¥æœŸ</label>
                            <input type="date" id="bondB_buyDate" onchange="calculateBondComparison()">
                        </div>
                        <div class="form-group">
                            <label>åˆ°æœŸæ—¥æœŸ</label>
                            <input type="date" id="bondB_maturityDate" onchange="calculateBondComparison()">
                        </div>

                        <div class="card" style="background:rgba(52,152,219,0.1)">
                            <h4>å‚µåˆ¸ B çµæœ</h4>
                            <div id="bondB_results">
                                <p>æŒæœ‰å¤©æ•¸ï¼š<span id="bondB_days">-</span></p>
                                <p>ç¥¨æ¯æ”¶ç›Šï¼š<span id="bondB_couponIncome">-</span></p>
                                <p>è³‡æœ¬æ”¶ç›Šï¼š<span id="bondB_capitalGain">-</span></p>
                                <p>ç¸½æ”¶ç›Šï¼š<span id="bondB_totalReturn">-</span></p>
                                <p>å¹´åŒ–æ¯ç‡ï¼š<span id="bondB_annualRate">-</span></p>
                                <p>YTMï¼š<span id="bondB_ytm">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¯”è¼ƒçµæœ -->
                <div class="card">
                    <h3>ğŸ“Š æ¯”è¼ƒçµæœ</h3>
                    <div id="comparisonResults"></div>
                </div>

                <button class="btn btn-danger" onclick="resetBondComparison()">ğŸ”„ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

        <!-- Tab 4: ç›ˆè™§è¨ˆç®—å™¨ -->
        <div class="tab-content" id="tab-profitloss">
            <div class="card">
                <h2>ğŸ“ˆ é€²éšè‚¡ç¥¨ç›ˆè™§è©¦ç®—å™¨</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>ğŸ“Š æŒæœ‰è‚¡æ•¸</label>
                        <input type="number" id="pl_shares" oninput="calculateProfitLoss()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ’° è²·å…¥åƒ¹ (æ¯è‚¡)</label>
                        <input type="number" id="pl_buyPrice" step="0.01" oninput="calculateProfitLoss()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ’³ è²·å…¥æ‰‹çºŒè²»</label>
                        <input type="number" id="pl_buyFee" step="0.01" value="0" oninput="calculateProfitLoss()">
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="pl_totalCost">$0</div>
                        <div class="stat-label">è²·å…¥ç¸½æˆæœ¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pl_breakeven">$0</div>
                        <div class="stat-label">æç›Šå…©å¹³åƒ¹</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px">
                    <label>ğŸ’ é è¨ˆå¯æ”¶è‚¡æ¯</label>
                    <input type="number" id="pl_dividend" step="0.01" value="0" oninput="calculateProfitLoss()">
                </div>

                <!-- ç›ˆè™§è¨ˆç®— -->
                <div class="card" style="margin-top:20px">
                    <h3>ğŸ¯ ç›ˆè™§è¨ˆç®—</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>é è¨ˆè³£å‡ºåƒ¹ (æ¯è‚¡)</label>
                            <input type="number" id="pl_sellPrice" step="0.01" oninput="calculateProfitLoss()">
                        </div>
                        <div class="form-group">
                            <label>ğŸ’³ è³£å‡ºæ‰‹çºŒè²»</label>
                            <input type="number" id="pl_sellFee" step="0.01" value="0" oninput="calculateProfitLoss()">
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="pl_sellTotal">$0</div>
                            <div class="stat-label">è³£å‡ºç¸½é¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pl_profit">$0</div>
                            <div class="stat-label">ç›ˆè™§é‡‘é¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pl_profitPercent">0%</div>
                            <div class="stat-label">ç›ˆè™§ç™¾åˆ†æ¯”</div>
                        </div>
                    </div>
                </div>

                <!-- åæ¨è³£å‡ºåƒ¹ -->
                <div class="card" style="margin-top:20px">
                    <h3>ğŸª åæ¨è³£å‡ºåƒ¹</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç›®æ¨™æœ€çµ‚ç²åˆ©é‡‘é¡</label>
                            <input type="number" id="pl_targetProfit" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>ğŸ’³ è³£å‡ºæ‰‹çºŒè²»</label>
                            <input type="number" id="pl_targetSellFee" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>æ˜¯å¦åŒ…å«è‚¡æ¯</label>
                            <select id="pl_includeDividend">
                                <option value="yes">å«è‚¡æ¯</option>
                                <option value="no">ä¸å«è‚¡æ¯</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calculateTargetSellPrice()">ğŸ”„ åæ¨æ‰€éœ€è³£å‡ºåƒ¹</button>
                    <div class="stat-card" style="margin-top:15px">
                        <div class="stat-value" id="pl_requiredSellPrice">$0</div>
                        <div class="stat-label">æ‰€éœ€è³£å‡ºåƒ¹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: æŠ•è³‡çµ„åˆåˆ†æå™¨ -->
        <div class="tab-content" id="tab-portfolio">
            <div class="card">
                <h2>ğŸ“Š æŠ•è³‡çµ„åˆåˆ†æå™¨</h2>

                <div class="form-group">
                    <label>ç¾å…ƒå…Œæ¸¯å…ƒåŒ¯ç‡ (USD to HKD)</label>
                    <input type="number" id="usdHkdRate" value="7.8" step="0.01" oninput="updatePortfolio()">
                </div>

                <!-- æ–°å¢è³‡ç”¢è¡¨å–® -->
                <div class="card">
                    <h3>æ–°å¢/ä¿®æ”¹è³‡ç”¢</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è‚¡ç¥¨/è³‡ç”¢åç¨±åŠä»£è™Ÿ</label>
                            <input type="text" id="asset_name" placeholder="ä¾‹: é¨°è¨Š 0700">
                        </div>
                        <div class="form-group">
                            <label>é¡å‹</label>
                            <select id="asset_type">
                                <option value="hk_stock">æ¸¯è‚¡</option>
                                <option value="us_stock">ç¾è‚¡</option>
                                <option value="us_treasury">ç¾å‚µ</option>
                                <option value="corporate_bond">å…¬å¸å‚µ</option>
                                <option value="usd_deposit">ç¾é‡‘å®šæœŸ</option>
                                <option value="hkd_deposit">æ¸¯å…ƒå®šæœŸ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¸‚å€¼</label>
                            <input type="number" id="asset_value" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>è²¨å¹£å–®ä½</label>
                            <select id="asset_currency">
                                <option value="HKD">æ¸¯å…ƒ (HKD)</option>
                                <option value="USD">ç¾å…ƒ (USD)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addAsset()">æ–°å¢è³‡ç”¢</button>
                </div>

                <!-- è³‡ç”¢åˆ—è¡¨ -->
                <div class="card">
                    <h3>è³‡ç”¢åˆ—è¡¨</h3>
                    <div style="overflow-x:auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>åç¨±/ä»£è™Ÿ</th>
                                    <th>é¡å‹</th>
                                    <th>åŸå¹£å¸‚å€¼</th>
                                    <th>æ¸¯å…ƒä¼°å€¼</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="assetTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- è³‡ç”¢åˆ†ä½ˆåˆ†æ -->
                <div class="card">
                    <h3>ğŸ“Š è³‡ç”¢åˆ†ä½ˆåˆ†æ</h3>
                    
                    <div class="form-row">
                        <div>
                            <h4>1. å®è§€è³‡ç”¢é¡åˆ¥åˆ†ä½ˆ</h4>
                            <p style="color:rgba(255,255,255,0.6)">è‚¡ç¥¨ vs å‚µåˆ¸ vs å®šæœŸ</p>
                            <div class="chart-container" style="height:250px">
                                <canvas id="macroChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4>2. è©³ç´°è³‡ç”¢é¡åˆ¥åˆ†ä½ˆ</h4>
                            <div class="chart-container" style="height:250px">
                                <canvas id="detailChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top:20px">
                        <div>
                            <h4>3. è‚¡ç¥¨å…§éƒ¨æ¯”è¼ƒ</h4>
                            <p style="color:rgba(255,255,255,0.6)">æ¸¯è‚¡ vs ç¾è‚¡</p>
                            <div class="chart-container" style="height:200px">
                                <canvas id="stockChart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4>4. å‚µåˆ¸å…§éƒ¨æ¯”è¼ƒ</h4>
                            <p style="color:rgba(255,255,255,0.6)">ç¾å‚µ vs å…¬å¸å‚µ</p>
                            <div class="chart-container" style="height:200px">
                                <canvas id="bondDistChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub è¨­å®šæ¨¡æ…‹æ¡† -->
    <div class="modal" id="githubModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ GitHub é›²ç«¯åŒæ­¥è¨­å®š</h2>
                <button class="modal-close" onclick="closeGitHubModal()">&times;</button>
            </div>
            
            <div class="card github-settings">
                <p style="margin-bottom:15px">è¨­å®š GitHub ä»¥è‡ªå‹•å„²å­˜å’Œè¼‰å…¥æ‚¨çš„è³‡æ–™</p>
                
                <div class="form-group">
                    <label>GitHub Personal Access Token</label>
                    <input type="password" id="github_token" placeholder="ghp_xxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.6)">éœ€è¦ repo æ¬Šé™</small>
                </div>
                
                <div class="form-group">
                    <label>GitHub ç”¨æˆ¶å</label>
                    <input type="text" id="github_username" placeholder="your-username">
                </div>
                
                <div class="form-group">
                    <label>Repository åç¨±</label>
                    <input type="text" id="github_repo" placeholder="my-investment-data">
                </div>
                
                <div class="form-group">
                    <label>è³‡æ–™æª”æ¡ˆè·¯å¾‘</label>
                    <input type="text" id="github_path" value="data/investment-data.json">
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:20px">
                    <button class="btn btn-primary" onclick="saveGitHubSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    <button class="btn btn-info" onclick="testGitHubConnection()">ğŸ”— æ¸¬è©¦é€£æ¥</button>
                    <button class="btn btn-warning" onclick="syncFromGitHub()">ğŸ“¥ å¾ GitHub è¼‰å…¥</button>
                    <button class="btn btn-primary" onclick="syncToGitHub()">ğŸ“¤ ä¸Šå‚³è‡³ GitHub</button>
                </div>

                <div id="githubStatus" style="margin-top:15px"></div>
            </div>

            <div class="card" style="margin-top:20px">
                <h3>ğŸ“– ä½¿ç”¨èªªæ˜</h3>
                <ol style="line-height:2;padding-left:20px">
                    <li>å‰å¾€ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens</li>
                    <li>é»æ“Š "Generate new token (classic)"</li>
                    <li>å‹¾é¸ "repo" æ¬Šé™ï¼Œç”Ÿæˆ Token</li>
                    <li>å»ºç«‹ä¸€å€‹ç§äºº Repository ä¾†å­˜æ”¾è³‡æ–™</li>
                    <li>åœ¨ä¸Šæ–¹å¡«å…¥ç›¸é—œè³‡è¨Šä¸¦å„²å­˜</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        const CORRECT_PASSWORD = '1982';
        let isLoggedIn = false;

        // å„æ¨¡çµ„è³‡æ–™
        let piggyData = {
            hkdDividend: 0,
            usdStock: 0,
            usdBond: 0,
            loanMonths: 0,
            hkStocks: [],
            dcaRecords: [],
            currentMonth: { splg: 0, vxus: 0 }
        };

        let bondLadderData = {
            bonds: []
        };

        let bondCompareData = {};

        let portfolioData = {
            assets: [],
            usdHkdRate: 7.8
        };

        // åœ–è¡¨å¯¦ä¾‹
        let bondMonthlyChart = null;
        let macroChart = null;
        let detailChart = null;
        let stockChart = null;
        let bondDistChart = null;

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
            if (sessionStorage.getItem('loggedIn') === 'true') {
                showMainApp();
            }

            // å¯†ç¢¼è¼¸å…¥æ¡†æŒ‰ Enter
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });

            // è¼‰å…¥æœ¬åœ°å„²å­˜çš„è³‡æ–™
            loadAllDataFromLocal();

            // å˜—è©¦å¾ GitHub è¼‰å…¥ï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
            const githubSettings = JSON.parse(localStorage.getItem('githubSettings') || '{}');
            if (githubSettings.token && githubSettings.username && githubSettings.repo) {
                setTimeout(() => {
                    if (isLoggedIn) {
                        syncFromGitHub(true); // éœé»˜è¼‰å…¥
                    }
                }, 1000);
            }
        });

        // ==================== å¯†ç¢¼é©—è­‰ ====================
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            if (input === CORRECT_PASSWORD) {
                sessionStorage.setItem('loggedIn', 'true');
                showMainApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function showMainApp() {
            isLoggedIn = true;
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            initializeAllTabs();
        }

        function logout() {
            sessionStorage.removeItem('loggedIn');
            location.reload();
        }

        // ==================== Tab åˆ‡æ› ====================
        function switchTab(tabId) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            // é‡æ–°æ¸²æŸ“åœ–è¡¨ï¼ˆè§£æ±ºåœ–è¡¨å°ºå¯¸å•é¡Œï¼‰
            setTimeout(() => {
                if (tabId === 'bondladder') {
                    renderBondLadder();
                } else if (tabId === 'portfolio') {
                    updatePortfolio();
                }
            }, 100);
        }

        // ==================== åˆå§‹åŒ–æ‰€æœ‰ Tab ====================
        function initializeAllTabs() {
            updatePiggyDisplay();
            updateDCADisplay();
            renderHKStockList();
            renderBondLadder();
            renderAssetTable();
            updatePortfolio();
        }

        // ==================== Toast æç¤º ====================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== Tab 1: å­˜éŒ¢ç½+å®šæŠ• ====================
        function piggyAction(type, action) {
            let amountInput;
            if (type === 'hkd') amountInput = document.getElementById('hkdAmount');
            else if (type === 'usdStock') amountInput = document.getElementById('usdStockAmount');
            else if (type === 'usdBond') amountInput = document.getElementById('usdBondAmount');

            const amount = parseFloat(amountInput.value) || 0;
            if (amount <= 0) return;

            if (action === 'deposit') {
                if (type === 'hkd') piggyData.hkdDividend += amount;
                else if (type === 'usdStock') piggyData.usdStock += amount;
                else if (type === 'usdBond') piggyData.usdBond += amount;
            } else {
                if (type === 'hkd') piggyData.hkdDividend = Math.max(0, piggyData.hkdDividend - amount);
                else if (type === 'usdStock') piggyData.usdStock = Math.max(0, piggyData.usdStock - amount);
                else if (type === 'usdBond') piggyData.usdBond = Math.max(0, piggyData.usdBond - amount);
            }

            amountInput.value = '';
            updatePiggyDisplay();
            savePiggyData();
        }

        function distributeDividend() {
            const amount = parseFloat(document.getElementById('usDividendInput').value) || 0;
            if (amount <= 0) return;

            const stockAmount = amount * 0.7;
            const bondAmount = amount * 0.3;

            piggyData.usdStock += stockAmount;
            piggyData.usdBond += bondAmount;

            document.getElementById('usDividendInput').value = '';
            updatePiggyDisplay();
            savePiggyData();
            showToast(`å·²åˆ†é…: $${stockAmount.toFixed(2)} å…¥è‚¡ç¥¨æ± , $${bondAmount.toFixed(2)} å…¥å‚µåˆ¸æ± `);
        }

        function updatePiggyDisplay() {
            document.getElementById('hkdDividend').textContent = piggyData.hkdDividend.toFixed(2);
            document.getElementById('usdStock').textContent = piggyData.usdStock.toFixed(2);
            document.getElementById('usdBond').textContent = piggyData.usdBond.toFixed(2);
            document.getElementById('loanMonths').value = piggyData.loanMonths;
            document.getElementById('loanCountdown').textContent = piggyData.loanMonths > 0 ? piggyData.loanMonths : '--';
        }

        function updateDCA(type, delta) {
            if (type === 'splg') {
                piggyData.currentMonth.splg = Math.max(0, piggyData.currentMonth.splg + delta);
                document.getElementById('splgCount').textContent = piggyData.currentMonth.splg;
            } else {
                piggyData.currentMonth.vxus = Math.max(0, piggyData.currentMonth.vxus + delta);
                document.getElementById('vxusCount').textContent = piggyData.currentMonth.vxus;
            }
        }

        function saveDCARecord() {
            const now = new Date();
            const record = {
                date: now.toISOString().split('T')[0],
                month: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`,
                splg: piggyData.currentMonth.splg,
                vxus: piggyData.currentMonth.vxus
            };

            // æª¢æŸ¥æ˜¯å¦å·²æœ‰æœ¬æœˆè¨˜éŒ„
            const existingIndex = piggyData.dcaRecords.findIndex(r => r.month === record.month);
            if (existingIndex >= 0) {
                piggyData.dcaRecords[existingIndex] = record;
            } else {
                piggyData.dcaRecords.push(record);
            }

            piggyData.currentMonth = { splg: 0, vxus: 0 };
            updateDCADisplay();
            savePiggyData();
            showToast('æœ¬æœˆè¨˜éŒ„å·²ä¿å­˜');
        }

        function updateDCADisplay() {
            document.getElementById('splgCount').textContent = piggyData.currentMonth.splg;
            document.getElementById('vxusCount').textContent = piggyData.currentMonth.vxus;

            const totalSplg = piggyData.dcaRecords.reduce((sum, r) => sum + r.splg, 0);
            const totalVxus = piggyData.dcaRecords.reduce((sum, r) => sum + r.vxus, 0);
            const months = piggyData.dcaRecords.length;
            const avgMonthly = months > 0 ? ((totalSplg + totalVxus) / months).toFixed(1) : 0;

            document.getElementById('totalSplg').textContent = totalSplg;
            document.getElementById('totalVxus').textContent = totalVxus;
            document.getElementById('investMonths').textContent = months;
            document.getElementById('avgMonthly').textContent = avgMonthly;

            // æ¸²æŸ“æ­·å²è¨˜éŒ„
            const historyHtml = piggyData.dcaRecords.slice().reverse().map(r => `
                <div class="investment-item">
                    <span>${r.month}</span>
                    <span>SPLG: ${r.splg} | VXUS: ${r.vxus}</span>
                </div>
            `).join('');
            document.getElementById('dcaHistory').innerHTML = historyHtml || '<p style="color:rgba(255,255,255,0.5)">æš«ç„¡è¨˜éŒ„</p>';
        }

        function addHKStock() {
            const name = prompt('è«‹è¼¸å…¥è‚¡ç¥¨åç¨±/ä»£è™Ÿ:');
            if (!name) return;

            piggyData.hkStocks.push({
                id: Date.now(),
                name: name,
                purchased: false
            });

            renderHKStockList();
            savePiggyData();
        }

        function renderHKStockList() {
            const html = piggyData.hkStocks.map(stock => `
                <div class="investment-item">
                    <span style="${stock.purchased ? 'text-decoration:line-through;color:rgba(255,255,255,0.5)' : ''}">${stock.name}</span>
                    <div>
                        <button class="btn ${stock.purchased ? 'btn-warning' : 'btn-primary'}" 
                                onclick="toggleHKStockPurchase(${stock.id})" style="margin-right:5px">
                            ${stock.purchased ? 'å–æ¶ˆ' : 'å·²è³¼è²·'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteHKStock(${stock.id})">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('hkStockList').innerHTML = html || '<p style="color:rgba(255,255,255,0.5)">æš«ç„¡è‚¡ç¥¨</p>';
        }

        function toggleHKStockPurchase(id) {
            const stock = piggyData.hkStocks.find(s => s.id === id);
            if (stock) {
                stock.purchased = !stock.purchased;
                renderHKStockList();
                savePiggyData();
            }
        }

        function deleteHKStock(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è‚¡ç¥¨?')) {
                piggyData.hkStocks = piggyData.hkStocks.filter(s => s.id !== id);
                renderHKStockList();
                savePiggyData();
            }
        }

        function savePiggyData() {
            piggyData.loanMonths = parseInt(document.getElementById('loanMonths').value) || 0;
            localStorage.setItem('piggyData', JSON.stringify(piggyData));
        }

        // ==================== Tab 2: ç¾å‚µæ¢¯è¦–è¦ºåŒ–å·¥å…· ====================
        function addBond() {
            const bond = {
                id: Date.now(),
                purchaseDate: document.getElementById('bondPurchaseDate').value,
                name: document.getElementById('bondName').value,
                maturityDate: document.getElementById('bondMaturityDate').value,
                faceValue: parseFloat(document.getElementById('bondFaceValue').value) || 0,
                purchasePrice: parseFloat(document.getElementById('bondPurchasePrice').value) || 0,
                couponRate: parseFloat(document.getElementById('bondCouponRate').value) || 0,
                type: document.getElementById('bondType').value
            };

            if (!bond.name || !bond.maturityDate || !bond.faceValue) {
                showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'error');
                return;
            }

            bondLadderData.bonds.push(bond);
            saveBondLadderData();
            renderBondLadder();
            clearBondForm();
            showToast('å‚µåˆ¸å·²æ–°å¢');
        }

        function clearBondForm() {
            document.getElementById('bondPurchaseDate').value = '';
            document.getElementById('bondName').value = '';
            document.getElementById('bondMaturityDate').value = '';
            document.getElementById('bondFaceValue').value = '';
            document.getElementById('bondPurchasePrice').value = '';
            document.getElementById('bondCouponRate').value = '';
        }

        function deleteBond(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤å‚µåˆ¸?')) {
                bondLadderData.bonds = bondLadderData.bonds.filter(b => b.id !== id);
                saveBondLadderData();
                renderBondLadder();
                showToast('å‚µåˆ¸å·²åˆªé™¤');
            }
        }

        function calculateYTM(bond) {
            const fv = bond.faceValue;
            const pv = bond.purchasePrice || fv;
            const c = fv * (bond.couponRate / 100);
            const n = Math.max(1, (new Date(bond.maturityDate) - new Date(bond.purchaseDate || new Date())) / (365 * 24 * 60 * 60 * 1000));
            
            // ç°¡åŒ– YTM è¨ˆç®—
            const ytm = ((c + (fv - pv) / n) / ((fv + pv) / 2)) * 100;
            return ytm;
        }

        function getPaymentMonths(bond) {
            const maturityDate = new Date(bond.maturityDate);
            const month1 = maturityDate.getMonth() + 1;
            const month2 = ((month1 + 5) % 12) + 1;
            return [Math.min(month1, month2), Math.max(month1, month2)];
        }

        function getDaysToMaturity(maturityDate) {
            const today = new Date();
            const maturity = new Date(maturityDate);
            const days = Math.ceil((maturity - today) / (1000 * 60 * 60 * 24));
            return days;
        }

        function renderBondLadder() {
            // æ›´æ–°çµ±è¨ˆ
            const totalValue = bondLadderData.bonds.reduce((sum, b) => sum + b.faceValue, 0);
            const totalCost = bondLadderData.bonds.reduce((sum, b) => sum + (b.purchasePrice || b.faceValue), 0);
            const avgYTM = bondLadderData.bonds.length > 0 
                ? bondLadderData.bonds.reduce((sum, b) => sum + calculateYTM(b), 0) / bondLadderData.bonds.length 
                : 0;
            const annualIncome = bondLadderData.bonds.reduce((sum, b) => sum + b.faceValue * (b.couponRate / 100), 0);

            document.getElementById('totalBondValue').textContent = '$' + totalValue.toLocaleString();
            document.getElementById('totalBondCost').textContent = '$' + totalCost.toLocaleString();
            document.getElementById('avgYTM').textContent = avgYTM.toFixed(2) + '%';
            document.getElementById('annualIncome').textContent = '$' + annualIncome.toLocaleString();

            // æ¸²æŸ“è¡¨æ ¼
            const tableHtml = bondLadderData.bonds.map(bond => {
                const ytm = calculateYTM(bond);
                const days = getDaysToMaturity(bond.maturityDate);
                const months = getPaymentMonths(bond);
                const monthNames = ['', '1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

                return `
                    <tr>
                        <td>${bond.name}</td>
                        <td><span class="bond-type-tag ${bond.type}">${bond.type === 'treasury' ? 'åœ‹å‚µ' : 'å…¬å¸å‚µ'}</span></td>
                        <td>${bond.couponRate}%</td>
                        <td>${ytm.toFixed(2)}%</td>
                        <td>${bond.purchaseDate || '-'}</td>
                        <td>${bond.maturityDate}</td>
                        <td>${days > 0 ? days + 'å¤©' : 'å·²åˆ°æœŸ'}</td>
                        <td>$${bond.faceValue.toLocaleString()}</td>
                        <td>$${(bond.purchasePrice || bond.faceValue).toLocaleString()}</td>
                        <td>
                            <div class="payment-months">
                                <span class="month-badge">${monthNames[months[0]]}</span>
                                <span class="month-badge">${monthNames[months[1]]}</span>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteBond(${bond.id})" style="padding:5px 10px">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');
            document.getElementById('bondTableBody').innerHTML = tableHtml || '<tr><td colspan="11" style="text-align:center">æš«ç„¡å‚µåˆ¸</td></tr>';

            // æ¸²æŸ“å‚µåˆ¸æ¢¯åœ–è¡¨
            renderBondLadderChart();
            renderBondMonthlyChart();
        }

        function renderBondLadderChart() {
            const container = document.getElementById('bondLadderChart');
            const maxValue = Math.max(...bondLadderData.bonds.map(b => b.faceValue), 1);

            const sortedBonds = [...bondLadderData.bonds].sort((a, b) => 
                new Date(a.maturityDate) - new Date(b.maturityDate)
            );

            container.innerHTML = sortedBonds.map(bond => {
                const width = (bond.faceValue / maxValue) * 100;
                const days = getDaysToMaturity(bond.maturityDate);
                return `
                    <div class="bond-bar">
                        <span class="bond-bar-label">${bond.name}</span>
                        <div class="bond-bar-fill" style="width:${width}%;background:${bond.type === 'treasury' ? 'linear-gradient(135deg, #4ecdc4, #44a08d)' : 'linear-gradient(135deg, #9b59b6, #8e44ad)'}">
                            $${bond.faceValue.toLocaleString()} | ${days > 0 ? days + 'å¤©' : 'å·²åˆ°æœŸ'}
                        </div>
                    </div>
                `;
            }).join('') || '<p style="color:rgba(255,255,255,0.5);text-align:center">æš«ç„¡å‚µåˆ¸</p>';
        }

        function renderBondMonthlyChart() {
            const ctx = document.getElementById('bondMonthlyChart');
            if (!ctx) return;

            // è¨ˆç®—æ¯æœˆå‚µæ¯æ”¶å…¥
            const monthlyIncome = Array(12).fill(0);
            bondLadderData.bonds.forEach(bond => {
                const months = getPaymentMonths(bond);
                const payment = (bond.faceValue * (bond.couponRate / 100)) / 2;
                months.forEach(m => {
                    monthlyIncome[m - 1] += payment;
                });
            });

            if (bondMonthlyChart) {
                bondMonthlyChart.destroy();
            }

            bondMonthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                    datasets: [{
                        label: 'å‚µæ¯æ”¶å…¥ ($)',
                        data: monthlyIncome,
                        backgroundColor: 'rgba(78, 205, 196, 0.6)',
                        borderColor: 'rgba(78, 205, 196, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function saveBondLadderData() {
            localStorage.setItem('bondLadderData', JSON.stringify(bondLadderData));
        }

        // ==================== Tab 3: å‚µåˆ¸å°æ¯” ====================
        function calculateBondComparison() {
            ['A', 'B'].forEach(side => {
                const coupon = parseFloat(document.getElementById(`bond${side}_coupon`).value) || 0;
                const faceValue = parseFloat(document.getElementById(`bond${side}_faceValue`).value) || 1000;
                const price = parseFloat(document.getElementById(`bond${side}_price`).value) || 0;
                const frequency = parseInt(document.getElementById(`bond${side}_frequency`).value) || 2;
                const buyDate = document.getElementById(`bond${side}_buyDate`).value;
                const maturityDate = document.getElementById(`bond${side}_maturityDate`).value;

                if (!buyDate || !maturityDate || !price) {
                    return;
                }

                const buy = new Date(buyDate);
                const maturity = new Date(maturityDate);
                const days = Math.ceil((maturity - buy) / (1000 * 60 * 60 * 24));
                const years = days / 365;

                // è¨ˆç®—ç¥¨æ¯æ”¶ç›Š
                const annualCoupon = faceValue * (coupon / 100);
                const totalCoupon = annualCoupon * years;

                // è¨ˆç®—è³‡æœ¬æ”¶ç›Š
                const capitalGain = faceValue - price;

                // ç¸½æ”¶ç›Š
                const totalReturn = totalCoupon + capitalGain;

                // å¹´åŒ–æ”¶ç›Šç‡
                const annualRate = years > 0 ? (totalReturn / price / years) * 100 : 0;

                // YTM è¨ˆç®—
                const ytm = years > 0 ? ((annualCoupon + capitalGain / years) / ((faceValue + price) / 2)) * 100 : 0;

                // æ›´æ–°é¡¯ç¤º
                document.getElementById(`bond${side}_days`).textContent = days + ' å¤©';
                document.getElementById(`bond${side}_couponIncome`).textContent = '$' + totalCoupon.toFixed(2);
                document.getElementById(`bond${side}_capitalGain`).textContent = '$' + capitalGain.toFixed(2);
                document.getElementById(`bond${side}_totalReturn`).textContent = '$' + totalReturn.toFixed(2);
                document.getElementById(`bond${side}_annualRate`).textContent = annualRate.toFixed(2) + '%';
                document.getElementById(`bond${side}_ytm`).textContent = ytm.toFixed(2) + '%';
            });

            updateComparisonResults();
        }

        function updateComparisonResults() {
            const results = document.getElementById('comparisonResults');
            
            const ytmA = parseFloat(document.getElementById('bondA_ytm').textContent) || 0;
            const ytmB = parseFloat(document.getElementById('bondB_ytm').textContent) || 0;
            const returnA = parseFloat(document.getElementById('bondA_totalReturn').textContent.replace('$', '')) || 0;
            const returnB = parseFloat(document.getElementById('bondB_totalReturn').textContent.replace('$', '')) || 0;

            if (ytmA === 0 && ytmB === 0) {
                results.innerHTML = '<p style="color:rgba(255,255,255,0.5)">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</p>';
                return;
            }

            let html = '';

            // YTM æ¯”è¼ƒ
            if (ytmA > ytmB) {
                html += `<div class="comparison-result winner-a">YTM æ¯”è¼ƒï¼šå‚µåˆ¸ A å‹å‡º (${ytmA.toFixed(2)}% vs ${ytmB.toFixed(2)}%)</div>`;
            } else if (ytmB > ytmA) {
                html += `<div class="comparison-result winner-b">YTM æ¯”è¼ƒï¼šå‚µåˆ¸ B å‹å‡º (${ytmB.toFixed(2)}% vs ${ytmA.toFixed(2)}%)</div>`;
            } else {
                html += `<div class="comparison-result tie">YTM æ¯”è¼ƒï¼šå¹³æ‰‹ (${ytmA.toFixed(2)}%)</div>`;
            }

            // ç¸½æ”¶ç›Šæ¯”è¼ƒ
            if (returnA > returnB) {
                html += `<div class="comparison-result winner-a">ç¸½æ”¶ç›Šæ¯”è¼ƒï¼šå‚µåˆ¸ A å‹å‡º ($${returnA.toFixed(2)} vs $${returnB.toFixed(2)})</div>`;
            } else if (returnB > returnA) {
                html += `<div class="comparison-result winner-b">ç¸½æ”¶ç›Šæ¯”è¼ƒï¼šå‚µåˆ¸ B å‹å‡º ($${returnB.toFixed(2)} vs $${returnA.toFixed(2)})</div>`;
            } else {
                html += `<div class="comparison-result tie">ç¸½æ”¶ç›Šæ¯”è¼ƒï¼šå¹³æ‰‹ ($${returnA.toFixed(2)})</div>`;
            }

            results.innerHTML = html;
        }

        function resetBondComparison() {
            ['A', 'B'].forEach(side => {
                document.getElementById(`bond${side}_coupon`).value = '';
                document.getElementById(`bond${side}_faceValue`).value = '1000';
                document.getElementById(`bond${side}_price`).value = '';
                document.getElementById(`bond${side}_buyDate`).value = '';
                document.getElementById(`bond${side}_maturityDate`).value = '';
                document.getElementById(`bond${side}_days`).textContent = '-';
                document.getElementById(`bond${side}_couponIncome`).textContent = '-';
                document.getElementById(`bond${side}_capitalGain`).textContent = '-';
                document.getElementById(`bond${side}_totalReturn`).textContent = '-';
                document.getElementById(`bond${side}_annualRate`).textContent = '-';
                document.getElementById(`bond${side}_ytm`).textContent = '-';
            });
            document.getElementById('comparisonResults').innerHTML = '<p style="color:rgba(255,255,255,0.5)">è«‹å®Œæˆå…©å€‹å‚µåˆ¸çš„è³‡æ–™è¼¸å…¥</p>';
        }

        // ==================== Tab 4: ç›ˆè™§è¨ˆç®—å™¨ ====================
        function calculateProfitLoss() {
            const shares = parseFloat(document.getElementById('pl_shares').value) || 0;
            const buyPrice = parseFloat(document.getElementById('pl_buyPrice').value) || 0;
            const buyFee = parseFloat(document.getElementById('pl_buyFee').value) || 0;
            const dividend = parseFloat(document.getElementById('pl_dividend').value) || 0;
            const sellPrice = parseFloat(document.getElementById('pl_sellPrice').value) || 0;
            const sellFee = parseFloat(document.getElementById('pl_sellFee').value) || 0;

            // è²·å…¥ç¸½æˆæœ¬
            const totalCost = (shares * buyPrice) + buyFee;
            document.getElementById('pl_totalCost').textContent = '$' + totalCost.toFixed(2);

            // æç›Šå…©å¹³åƒ¹
            const breakeven = shares > 0 ? (totalCost - dividend) / shares : 0;
            document.getElementById('pl_breakeven').textContent = '$' + breakeven.toFixed(2);

            if (sellPrice > 0) {
                // è³£å‡ºç¸½é¡
                const sellTotal = (shares * sellPrice) - sellFee;
                document.getElementById('pl_sellTotal').textContent = '$' + sellTotal.toFixed(2);

                // ç›ˆè™§
                const profit = sellTotal - totalCost + dividend;
                document.getElementById('pl_profit').textContent = '$' + profit.toFixed(2);
                document.getElementById('pl_profit').style.color = profit >= 0 ? '#4ecdc4' : '#e74c3c';

                // ç›ˆè™§ç™¾åˆ†æ¯”
                const profitPercent = totalCost > 0 ? (profit / totalCost) * 100 : 0;
                document.getElementById('pl_profitPercent').textContent = profitPercent.toFixed(2) + '%';
                document.getElementById('pl_profitPercent').style.color = profitPercent >= 0 ? '#4ecdc4' : '#e74c3c';
            }
        }

        function calculateTargetSellPrice() {
            const shares = parseFloat(document.getElementById('pl_shares').value) || 0;
            const buyPrice = parseFloat(document.getElementById('pl_buyPrice').value) || 0;
            const buyFee = parseFloat(document.getElementById('pl_buyFee').value) || 0;
            const dividend = parseFloat(document.getElementById('pl_dividend').value) || 0;
            const targetProfit = parseFloat(document.getElementById('pl_targetProfit').value) || 0;
            const sellFee = parseFloat(document.getElementById('pl_targetSellFee').value) || 0;
            const includeDividend = document.getElementById('pl_includeDividend').value === 'yes';

            if (shares <= 0) {
                showToast('è«‹è¼¸å…¥æŒæœ‰è‚¡æ•¸', 'error');
                return;
            }

            const totalCost = (shares * buyPrice) + buyFee;
            let requiredSellTotal;

            if (includeDividend) {
                requiredSellTotal = totalCost + targetProfit + sellFee - dividend;
            } else {
                requiredSellTotal = totalCost + targetProfit + sellFee;
            }

            const requiredSellPrice = requiredSellTotal / shares;
            document.getElementById('pl_requiredSellPrice').textContent = '$' + requiredSellPrice.toFixed(2);
        }

        // ==================== Tab 5: æŠ•è³‡çµ„åˆåˆ†æå™¨ ====================
        function addAsset() {
            const asset = {
                id: Date.now(),
                name: document.getElementById('asset_name').value,
                type: document.getElementById('asset_type').value,
                value: parseFloat(document.getElementById('asset_value').value) || 0,
                currency: document.getElementById('asset_currency').value
            };

            if (!asset.name || !asset.value) {
                showToast('è«‹å¡«å¯«å®Œæ•´è³‡æ–™', 'error');
                return;
            }

            portfolioData.assets.push(asset);
            savePortfolioData();
            renderAssetTable();
            updatePortfolio();
            showToast('è³‡ç”¢å·²æ–°å¢');

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('asset_name').value = '';
            document.getElementById('asset_value').value = '';
        }

        function deleteAsset(id) {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤è³‡ç”¢?')) {
                portfolioData.assets = portfolioData.assets.filter(a => a.id !== id);
                savePortfolioData();
                renderAssetTable();
                updatePortfolio();
            }
        }

        function renderAssetTable() {
            const rate = parseFloat(document.getElementById('usdHkdRate').value) || 7.8;
            const typeNames = {
                'hk_stock': 'æ¸¯è‚¡',
                'us_stock': 'ç¾è‚¡',
                'us_treasury': 'ç¾å‚µ',
                'corporate_bond': 'å…¬å¸å‚µ',
                'usd_deposit': 'ç¾é‡‘å®šæœŸ',
                'hkd_deposit': 'æ¸¯å…ƒå®šæœŸ'
            };

            const html = portfolioData.assets.map(asset => {
                const hkdValue = asset.currency === 'USD' ? asset.value * rate : asset.value;
                return `
                    <tr>
                        <td>${asset.name}</td>
                        <td>${typeNames[asset.type] || asset.type}</td>
                        <td>${asset.currency} ${asset.value.toLocaleString()}</td>
                        <td>HKD ${hkdValue.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteAsset(${asset.id})" style="padding:5px 10px">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('assetTableBody').innerHTML = html || '<tr><td colspan="5" style="text-align:center">æš«ç„¡è³‡ç”¢</td></tr>';
        }

        function updatePortfolio() {
            const rate = parseFloat(document.getElementById('usdHkdRate').value) || 7.8;
            portfolioData.usdHkdRate = rate;

            // è¨ˆç®—å„é¡è³‡ç”¢çš„æ¸¯å…ƒåƒ¹å€¼
            const categories = {
                stock: 0,    // è‚¡ç¥¨
                bond: 0,     // å‚µåˆ¸
                deposit: 0,  // å®šæœŸ
                hk_stock: 0,
                us_stock: 0,
                us_treasury: 0,
                corporate_bond: 0,
                usd_deposit: 0,
                hkd_deposit: 0
            };

            portfolioData.assets.forEach(asset => {
                const hkdValue = asset.currency === 'USD' ? asset.value * rate : asset.value;
                
                categories[asset.type] = (categories[asset.type] || 0) + hkdValue;

                if (asset.type === 'hk_stock' || asset.type === 'us_stock') {
                    categories.stock += hkdValue;
                } else if (asset.type === 'us_treasury' || asset.type === 'corporate_bond') {
                    categories.bond += hkdValue;
                } else {
                    categories.deposit += hkdValue;
                }
            });

            // æ›´æ–°åœ–è¡¨
            updateMacroChart(categories);
            updateDetailChart(categories);
            updateStockChart(categories);
            updateBondDistChart(categories);

            savePortfolioData();
        }

        function updateMacroChart(categories) {
            const ctx = document.getElementById('macroChart');
            if (!ctx) return;

            if (macroChart) macroChart.destroy();

            macroChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['è‚¡ç¥¨', 'å‚µåˆ¸', 'å®šæœŸ'],
                    datasets: [{
                        data: [categories.stock, categories.bond, categories.deposit],
                        backgroundColor: ['#4ecdc4', '#9b59b6', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        function updateDetailChart(categories) {
            const ctx = document.getElementById('detailChart');
            if (!ctx) return;

            if (detailChart) detailChart.destroy();

            detailChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['æ¸¯è‚¡', 'ç¾è‚¡', 'ç¾å‚µ', 'å…¬å¸å‚µ', 'ç¾é‡‘å®šæœŸ', 'æ¸¯å…ƒå®šæœŸ'],
                    datasets: [{
                        data: [
                            categories.hk_stock,
                            categories.us_stock,
                            categories.us_treasury,
                            categories.corporate_bond,
                            categories.usd_deposit,
                            categories.hkd_deposit
                        ],
                        backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f39c12', '#1abc9c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        function updateStockChart(categories) {
            const ctx = document.getElementById('stockChart');
            if (!ctx) return;

            if (stockChart) stockChart.destroy();

            stockChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['æ¸¯è‚¡', 'ç¾è‚¡'],
                    datasets: [{
                        data: [categories.hk_stock, categories.us_stock],
                        backgroundColor: ['#e74c3c', '#3498db']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        function updateBondDistChart(categories) {
            const ctx = document.getElementById('bondDistChart');
            if (!ctx) return;

            if (bondDistChart) bondDistChart.destroy();

            bondDistChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ç¾å‚µ', 'å…¬å¸å‚µ'],
                    datasets: [{
                        data: [categories.us_treasury, categories.corporate_bond],
                        backgroundColor: ['#2ecc71', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    }
                }
            });
        }

        function savePortfolioData() {
            localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
        }

        // ==================== è³‡æ–™ç®¡ç† ====================
        function loadAllDataFromLocal() {
            try {
                const savedPiggy = localStorage.getItem('piggyData');
                if (savedPiggy) piggyData = JSON.parse(savedPiggy);

                const savedBondLadder = localStorage.getItem('bondLadderData');
                if (savedBondLadder) bondLadderData = JSON.parse(savedBondLadder);

                const savedPortfolio = localStorage.getItem('portfolioData');
                if (savedPortfolio) portfolioData = JSON.parse(savedPortfolio);
            } catch (e) {
                console.error('è¼‰å…¥æœ¬åœ°è³‡æ–™å¤±æ•—:', e);
            }
        }

        function backupAllData() {
            const allData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                piggyData: piggyData,
                bondLadderData: bondLadderData,
                portfolioData: portfolioData
            };

            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `investment-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰');
        }

        function restoreAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.piggyData) {
                        piggyData = data.piggyData;
                        localStorage.setItem('piggyData', JSON.stringify(piggyData));
                    }
                    if (data.bondLadderData) {
                        bondLadderData = data.bondLadderData;
                        localStorage.setItem('bondLadderData', JSON.stringify(bondLadderData));
                    }
                    if (data.portfolioData) {
                        portfolioData = data.portfolioData;
                        localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
                    }

                    initializeAllTabs();
                    showToast('è³‡æ–™å·²æˆåŠŸè¼‰å…¥');
                } catch (err) {
                    showToast('è¼‰å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ==================== GitHub åŒæ­¥ ====================
        function openGitHubSettings() {
            document.getElementById('githubModal').classList.add('active');
            
            // è¼‰å…¥å·²å„²å­˜çš„è¨­å®š
            const settings = JSON.parse(localStorage.getItem('githubSettings') || '{}');
            if (settings.token) document.getElementById('github_token').value = settings.token;
            if (settings.username) document.getElementById('github_username').value = settings.username;
            if (settings.repo) document.getElementById('github_repo').value = settings.repo;
            if (settings.path) document.getElementById('github_path').value = settings.path;
        }

        function closeGitHubModal() {
            document.getElementById('githubModal').classList.remove('active');
        }

        function saveGitHubSettings() {
            const settings = {
                token: document.getElementById('github_token').value,
                username: document.getElementById('github_username').value,
                repo: document.getElementById('github_repo').value,
                path: document.getElementById('github_path').value
            };
            localStorage.setItem('githubSettings', JSON.stringify(settings));
            showToast('GitHub è¨­å®šå·²å„²å­˜');
        }

        async function testGitHubConnection() {
            const settings = JSON.parse(localStorage.getItem('githubSettings') || '{}');
            const statusDiv = document.getElementById('githubStatus');

            if (!settings.token || !settings.username || !settings.repo) {
                statusDiv.innerHTML = '<p style="color:#e74c3c">è«‹å…ˆå¡«å¯«ä¸¦å„²å­˜è¨­å®š</p>';
                return;
            }

            statusDiv.innerHTML = '<p>æ¸¬è©¦é€£æ¥ä¸­...</p>';

            try {
                const response = await fetch(`https://api.github.com/repos/${settings.username}/${settings.repo}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const repo = await response.json();
                    statusDiv.innerHTML = `<p style="color:#4ecdc4">âœ… é€£æ¥æˆåŠŸï¼Repository: ${repo.full_name}</p>`;
                } else {
                    statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ é€£æ¥å¤±æ•—ï¼š${response.status} ${response.statusText}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ é€£æ¥éŒ¯èª¤ï¼š${error.message}</p>`;
            }
        }

        async function syncToGitHub() {
            const settings = JSON.parse(localStorage.getItem('githubSettings') || '{}');
            const statusDiv = document.getElementById('githubStatus');

            if (!settings.token || !settings.username || !settings.repo) {
                showToast('è«‹å…ˆè¨­å®š GitHub', 'error');
                return;
            }

            statusDiv.innerHTML = '<p>æ­£åœ¨ä¸Šå‚³...</p>';

            const allData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                piggyData: piggyData,
                bondLadderData: bondLadderData,
                portfolioData: portfolioData
            };

            try {
                // å…ˆæª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä»¥ç²å– SHA
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/${settings.path}`,
                        {
                            headers: {
                                'Authorization': `token ${settings.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // æª”æ¡ˆä¸å­˜åœ¨ï¼Œé€™æ˜¯æ­£å¸¸çš„
                }

                // ä¸Šå‚³æª”æ¡ˆ
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(allData, null, 2))));
                const body = {
                    message: `Update investment data - ${new Date().toISOString()}`,
                    content: content
                };
                if (sha) body.sha = sha;

                const response = await fetch(
                    `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/${settings.path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    statusDiv.innerHTML = '<p style="color:#4ecdc4">âœ… ä¸Šå‚³æˆåŠŸï¼</p>';
                    showToast('è³‡æ–™å·²ä¸Šå‚³è‡³ GitHub');
                } else {
                    const error = await response.json();
                    statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ ä¸Šå‚³å¤±æ•—ï¼š${error.message}</p>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ ä¸Šå‚³éŒ¯èª¤ï¼š${error.message}</p>`;
            }
        }

        async function syncFromGitHub(silent = false) {
            const settings = JSON.parse(localStorage.getItem('githubSettings') || '{}');
            const statusDiv = document.getElementById('githubStatus');

            if (!settings.token || !settings.username || !settings.repo) {
                if (!silent) showToast('è«‹å…ˆè¨­å®š GitHub', 'error');
                return;
            }

            if (!silent && statusDiv) statusDiv.innerHTML = '<p>æ­£åœ¨è¼‰å…¥...</p>';

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/${settings.path}`,
                    {
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(content);

                    if (data.piggyData) {
                        piggyData = data.piggyData;
                        localStorage.setItem('piggyData', JSON.stringify(piggyData));
                    }
                    if (data.bondLadderData) {
                        bondLadderData = data.bondLadderData;
                        localStorage.setItem('bondLadderData', JSON.stringify(bondLadderData));
                    }
                    if (data.portfolioData) {
                        portfolioData = data.portfolioData;
                        localStorage.setItem('portfolioData', JSON.stringify(portfolioData));
                    }

                    initializeAllTabs();

                    if (!silent) {
                        if (statusDiv) statusDiv.innerHTML = '<p style="color:#4ecdc4">âœ… è¼‰å…¥æˆåŠŸï¼</p>';
                        showToast('è³‡æ–™å·²å¾ GitHub è¼‰å…¥');
                    }
                } else if (response.status === 404) {
                    if (!silent && statusDiv) statusDiv.innerHTML = '<p style="color:#f39c12">âš ï¸ æª”æ¡ˆä¸å­˜åœ¨ï¼Œè«‹å…ˆä¸Šå‚³è³‡æ–™</p>';
                } else {
                    if (!silent && statusDiv) statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ è¼‰å…¥å¤±æ•—ï¼š${response.status}</p>`;
                }
            } catch (error) {
                if (!silent && statusDiv) statusDiv.innerHTML = `<p style="color:#e74c3c">âŒ è¼‰å…¥éŒ¯èª¤ï¼š${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
